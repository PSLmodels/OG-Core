
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ogcore.txfunc &#8212; OG-Core</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- So that users can add custom icons -->
  <script src="../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/ogcore/txfunc';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../content/intro/intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/OG-Core_logo.png" class="logo__image only-light" alt="OG-Core - Home"/>
    <img src="../../_static/OG-Core_logo.png" class="logo__image only-dark pst-js-only" alt="OG-Core - Home"/>
  
  
</a></div>
        <div class="sidebar-primary-item">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../content/intro/intro.html">
                    OG-Core
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Contributing to OG-Core</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../content/contributing/contributor_guide.html">Contributor Guide</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">OG-Core API</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../content/api/public_api.html">API</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../content/api/aggregates.html">Aggregates Equations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../content/api/demographics.html">Demographics Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../content/api/elliptical_u_est.html">Elliptical Utility Function Estimation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../content/api/execute.html">Model Execution Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../content/api/firm.html">Firm Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../content/api/fiscal.html">Fiscal Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../content/api/household.html">Household Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../content/api/output_plots.html">Output Plotting Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../content/api/output_tables.html">Output Table Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../content/api/parameter_plots.html">Parameter Plotting Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../content/api/parameter_tables.html">Parameter Table Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../content/api/parameters.html">Parameters Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../content/api/pensions.html">Pension Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../content/api/tax.html">Tax Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../content/api/txfunc.html">Tax Function Estimation Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../content/api/utils.html">Utilities Functions</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">OG-Core Theory</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../content/theory/intro.html">Model Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../content/theory/demographics.html">Demographics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../content/theory/households.html">Households</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../content/theory/firms.html">Firms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../content/theory/government.html">Government</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../content/theory/open_economy.html">Open Economy Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../content/theory/financial.html">Financial Intermediary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../content/theory/market_clearing.html">Market Clearing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../content/theory/stationarization.html">Stationarization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../content/theory/equilibrium.html">Equilibrium</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../content/theory/calibration.html">Calibrating OG-Core</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendix</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../content/theory/derivations.html">Derivations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../content/intro/parameters.html">Model parameters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../content/intro/variables.html">Model variables</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">References</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../content/OGCore_references.html">References</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Citations of OG-Core</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../content/citations.html">Citations and use cases of OG-Core</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/PSLmodels/OG-Core" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/PSLmodels/OG-Core/issues/new?title=Issue%20on%20page%20%2F_modules/ogcore/txfunc.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button>


<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>

</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1></h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for ogcore.txfunc</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">------------------------------------------------------------------------</span>
<span class="sd">This script reads in data generated from a tax-benefit microsimulation model.</span>
<span class="sd">It then estimates tax functions tau_{s,t}(x,y), where</span>
<span class="sd">tau_{s,t} is the effective tax rate, marginal tax rate on labor income,</span>
<span class="sd">or the marginal tax rate on capital income, for a given age (s) in a</span>
<span class="sd">particular year (t). x is total labor income, and y is total capital</span>
<span class="sd">income.</span>
<span class="sd">------------------------------------------------------------------------</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># Import packages</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy.optimize</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">opt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dask</span><span class="w"> </span><span class="kn">import</span> <span class="n">delayed</span><span class="p">,</span> <span class="n">compute</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">dask.multiprocessing</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cloudpickle</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.interpolate</span><span class="w"> </span><span class="kn">import</span> <span class="n">interp1d</span> <span class="k">as</span> <span class="n">intp</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ogcore.parameter_plots</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pp</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ogcore.constants</span><span class="w"> </span><span class="kn">import</span> <span class="n">DEFAULT_START_YEAR</span><span class="p">,</span> <span class="n">SHOW_RUNTIME</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ogcore</span><span class="w"> </span><span class="kn">import</span> <span class="n">utils</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pygam</span><span class="w"> </span><span class="kn">import</span> <span class="n">LinearGAM</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">te</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">cm</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>


<span class="k">if</span> <span class="ow">not</span> <span class="n">SHOW_RUNTIME</span><span class="p">:</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>

<span class="n">CUR_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">MIN_OBS</span> <span class="o">=</span> <span class="mi">240</span>  <span class="c1"># 240 is 8 parameters to estimate X 30 obs per parameter</span>
<span class="n">MAX_ETR</span> <span class="o">=</span> <span class="mf">0.65</span>
<span class="n">MAX_MTR</span> <span class="o">=</span> <span class="mf">0.99</span>
<span class="n">MIN_INCOME</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">MIN_INC_GRAPH</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">MAX_INC_GRAPH</span> <span class="o">=</span> <span class="mi">500000</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">------------------------------------------------------------------------</span>
<span class="sd">Define Functions</span>
<span class="sd">------------------------------------------------------------------------</span>
<span class="sd">&quot;&quot;&quot;</span>


<div class="viewcode-block" id="get_tax_rates">
<a class="viewcode-back" href="../../content/api/txfunc.html#ogcore.txfunc.get_tax_rates">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_tax_rates</span><span class="p">(</span>
    <span class="n">params</span><span class="p">,</span>
    <span class="n">X</span><span class="p">,</span>
    <span class="n">Y</span><span class="p">,</span>
    <span class="n">wgts</span><span class="p">,</span>
    <span class="n">tax_func_type</span><span class="p">,</span>
    <span class="n">rate_type</span><span class="p">,</span>
    <span class="n">analytical_mtrs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">mtr_capital</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">for_estimation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates tax rates given income data and the parameters of the tax</span>
<span class="sd">    functions.</span>

<span class="sd">    Args:</span>
<span class="sd">        params (list): list of parameters of the tax function, or</span>
<span class="sd">            nonparametric function for tax function type &quot;mono&quot;</span>
<span class="sd">        X (array_like): labor income data</span>
<span class="sd">        Y (array_like): capital income data</span>
<span class="sd">        wgts (array_like): weights for data observations</span>
<span class="sd">        tax_func_type (str): functional form of tax functions</span>
<span class="sd">        rate_type (str): type of tax rate: mtrx, mtry, etr</span>
<span class="sd">        analytical_mtrs (bool): whether to compute marginal tax rates</span>
<span class="sd">            from the total tax function (for DEP functions only)</span>
<span class="sd">        mtr_capital (bool): whether analytical mtr on capital income</span>
<span class="sd">        for_estimation (bool): whether the results are used in</span>
<span class="sd">            estimation, if True, then tax rates are computed as</span>
<span class="sd">            deviations from the mean</span>

<span class="sd">    Returns:</span>
<span class="sd">        txrates (array_like): model tax rates for each observation</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">X2</span> <span class="o">=</span> <span class="n">X</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">Y2</span> <span class="o">=</span> <span class="n">Y</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">income</span> <span class="o">=</span> <span class="n">X</span> <span class="o">+</span> <span class="n">Y</span>
    <span class="k">if</span> <span class="n">tax_func_type</span> <span class="o">!=</span> <span class="s2">&quot;mono&quot;</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="n">params</span>
        <span class="p">)</span>  <span class="c1"># easier to use arrays for calculations below, except when can&#39;t (bc lists of functions)</span>
    <span class="k">if</span> <span class="n">tax_func_type</span> <span class="o">==</span> <span class="s2">&quot;GS&quot;</span><span class="p">:</span>
        <span class="n">phi0</span><span class="p">,</span> <span class="n">phi1</span><span class="p">,</span> <span class="n">phi2</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">]),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">rate_type</span> <span class="o">==</span> <span class="s2">&quot;etr&quot;</span><span class="p">:</span>
            <span class="n">txrates</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">phi0</span> <span class="o">*</span> <span class="p">(</span><span class="n">income</span> <span class="o">-</span> <span class="p">((</span><span class="n">income</span><span class="o">**-</span><span class="n">phi1</span><span class="p">)</span> <span class="o">+</span> <span class="n">phi2</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">/</span> <span class="n">phi1</span><span class="p">))</span>
            <span class="p">)</span> <span class="o">/</span> <span class="n">income</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># marginal tax rate function</span>
            <span class="n">txrates</span> <span class="o">=</span> <span class="n">phi0</span> <span class="o">*</span> <span class="p">(</span>
                <span class="mi">1</span>
                <span class="o">-</span> <span class="p">(</span>
                    <span class="n">income</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="n">phi1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="o">*</span> <span class="p">((</span><span class="n">income</span><span class="o">**-</span><span class="n">phi1</span><span class="p">)</span> <span class="o">+</span> <span class="n">phi2</span><span class="p">)</span> <span class="o">**</span> <span class="p">((</span><span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="n">phi1</span><span class="p">)</span> <span class="o">/</span> <span class="n">phi1</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
    <span class="k">if</span> <span class="n">tax_func_type</span> <span class="o">==</span> <span class="s2">&quot;HSV&quot;</span><span class="p">:</span>
        <span class="n">lambda_s</span><span class="p">,</span> <span class="n">tau_s</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">rate_type</span> <span class="o">==</span> <span class="s2">&quot;etr&quot;</span><span class="p">:</span>
            <span class="n">txrates</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">lambda_s</span> <span class="o">*</span> <span class="p">(</span><span class="n">income</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="n">tau_s</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># marginal tax rate function</span>
            <span class="n">txrates</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">lambda_s</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">tau_s</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">income</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="n">tau_s</span><span class="p">)))</span>
    <span class="k">elif</span> <span class="n">tax_func_type</span> <span class="o">==</span> <span class="s2">&quot;DEP&quot;</span><span class="p">:</span>
        <span class="p">(</span>
            <span class="n">A</span><span class="p">,</span>
            <span class="n">B</span><span class="p">,</span>
            <span class="n">C</span><span class="p">,</span>
            <span class="n">D</span><span class="p">,</span>
            <span class="n">max_x</span><span class="p">,</span>
            <span class="n">max_y</span><span class="p">,</span>
            <span class="n">share</span><span class="p">,</span>
            <span class="n">min_x</span><span class="p">,</span>
            <span class="n">min_y</span><span class="p">,</span>
            <span class="n">shift_x</span><span class="p">,</span>
            <span class="n">shift_y</span><span class="p">,</span>
            <span class="n">shift</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">]),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">3</span><span class="p">]),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">4</span><span class="p">]),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">5</span><span class="p">]),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">6</span><span class="p">]),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">7</span><span class="p">]),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">8</span><span class="p">]),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">9</span><span class="p">]),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">10</span><span class="p">]),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">11</span><span class="p">]),</span>
        <span class="p">)</span>
        <span class="n">Etil</span> <span class="o">=</span> <span class="n">A</span> <span class="o">+</span> <span class="n">B</span>
        <span class="n">Ftil</span> <span class="o">=</span> <span class="n">C</span> <span class="o">+</span> <span class="n">D</span>
        <span class="k">if</span> <span class="n">for_estimation</span><span class="p">:</span>
            <span class="n">shift_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="o">-</span><span class="n">min_x</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_x</span> <span class="o">-</span> <span class="n">min_x</span><span class="p">)</span>
            <span class="n">shift_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="o">-</span><span class="n">min_y</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_y</span> <span class="o">-</span> <span class="n">min_y</span><span class="p">)</span>
            <span class="n">X2bar</span> <span class="o">=</span> <span class="p">(</span><span class="n">X2</span> <span class="o">*</span> <span class="n">wgts</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">wgts</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">Xbar</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span> <span class="o">*</span> <span class="n">wgts</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">wgts</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">Y2bar</span> <span class="o">=</span> <span class="p">(</span><span class="n">Y2</span> <span class="o">*</span> <span class="n">wgts</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">wgts</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">Ybar</span> <span class="o">=</span> <span class="p">(</span><span class="n">Y</span> <span class="o">*</span> <span class="n">wgts</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">wgts</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">X2til</span> <span class="o">=</span> <span class="p">(</span><span class="n">X2</span> <span class="o">-</span> <span class="n">X2bar</span><span class="p">)</span> <span class="o">/</span> <span class="n">X2bar</span>
            <span class="n">Xtil</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span> <span class="o">-</span> <span class="n">Xbar</span><span class="p">)</span> <span class="o">/</span> <span class="n">Xbar</span>
            <span class="n">Y2til</span> <span class="o">=</span> <span class="p">(</span><span class="n">Y2</span> <span class="o">-</span> <span class="n">Y2bar</span><span class="p">)</span> <span class="o">/</span> <span class="n">Y2bar</span>
            <span class="n">Ytil</span> <span class="o">=</span> <span class="p">(</span><span class="n">Y</span> <span class="o">-</span> <span class="n">Ybar</span><span class="p">)</span> <span class="o">/</span> <span class="n">Ybar</span>
            <span class="n">tau_x</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">max_x</span> <span class="o">-</span> <span class="n">min_x</span><span class="p">)</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">A</span> <span class="o">*</span> <span class="n">X2til</span> <span class="o">+</span> <span class="n">B</span> <span class="o">*</span> <span class="n">Xtil</span> <span class="o">+</span> <span class="n">Etil</span><span class="p">)</span>
                <span class="o">/</span> <span class="p">(</span><span class="n">A</span> <span class="o">*</span> <span class="n">X2til</span> <span class="o">+</span> <span class="n">B</span> <span class="o">*</span> <span class="n">Xtil</span> <span class="o">+</span> <span class="n">Etil</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span> <span class="o">+</span> <span class="n">min_x</span>
            <span class="n">tau_y</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">max_y</span> <span class="o">-</span> <span class="n">min_y</span><span class="p">)</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">C</span> <span class="o">*</span> <span class="n">Y2til</span> <span class="o">+</span> <span class="n">D</span> <span class="o">*</span> <span class="n">Ytil</span> <span class="o">+</span> <span class="n">Ftil</span><span class="p">)</span>
                <span class="o">/</span> <span class="p">(</span><span class="n">C</span> <span class="o">*</span> <span class="n">Y2til</span> <span class="o">+</span> <span class="n">D</span> <span class="o">*</span> <span class="n">Ytil</span> <span class="o">+</span> <span class="n">Ftil</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span> <span class="o">+</span> <span class="n">min_y</span>
            <span class="n">txrates</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">((</span><span class="n">tau_x</span> <span class="o">+</span> <span class="n">shift_x</span><span class="p">)</span> <span class="o">**</span> <span class="n">share</span><span class="p">)</span>
                <span class="o">*</span> <span class="p">((</span><span class="n">tau_y</span> <span class="o">+</span> <span class="n">shift_y</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">share</span><span class="p">))</span>
            <span class="p">)</span> <span class="o">+</span> <span class="n">shift</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">analytical_mtrs</span><span class="p">:</span>
                <span class="n">tau_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_x</span> <span class="o">-</span> <span class="n">min_x</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">A</span> <span class="o">*</span> <span class="n">X2</span> <span class="o">+</span> <span class="n">B</span> <span class="o">*</span> <span class="n">X</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
                    <span class="n">A</span> <span class="o">*</span> <span class="n">X2</span> <span class="o">+</span> <span class="n">B</span> <span class="o">*</span> <span class="n">X</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="p">)</span> <span class="o">+</span> <span class="n">min_x</span>
                <span class="n">tau_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_y</span> <span class="o">-</span> <span class="n">min_y</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">C</span> <span class="o">*</span> <span class="n">Y2</span> <span class="o">+</span> <span class="n">D</span> <span class="o">*</span> <span class="n">Y</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
                    <span class="n">C</span> <span class="o">*</span> <span class="n">Y2</span> <span class="o">+</span> <span class="n">D</span> <span class="o">*</span> <span class="n">Y</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="p">)</span> <span class="o">+</span> <span class="n">min_y</span>
                <span class="n">etr</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">((</span><span class="n">tau_x</span> <span class="o">+</span> <span class="n">shift_x</span><span class="p">)</span> <span class="o">**</span> <span class="n">share</span><span class="p">)</span>
                    <span class="o">*</span> <span class="p">((</span><span class="n">tau_y</span> <span class="o">+</span> <span class="n">shift_y</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">share</span><span class="p">))</span>
                <span class="p">)</span> <span class="o">+</span> <span class="n">shift</span>
                <span class="k">if</span> <span class="n">mtr_capital</span><span class="p">:</span>
                    <span class="n">d_etr</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">share</span><span class="p">)</span>
                        <span class="o">*</span> <span class="p">((</span><span class="n">tau_y</span> <span class="o">+</span> <span class="n">shift_y</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="n">share</span><span class="p">))</span>
                        <span class="o">*</span> <span class="p">(</span><span class="n">max_y</span> <span class="o">-</span> <span class="n">min_y</span><span class="p">)</span>
                        <span class="o">*</span> <span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">C</span> <span class="o">*</span> <span class="n">Y</span> <span class="o">+</span> <span class="n">D</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="n">C</span> <span class="o">*</span> <span class="n">Y2</span> <span class="o">+</span> <span class="n">D</span> <span class="o">*</span> <span class="n">Y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
                        <span class="o">*</span> <span class="p">((</span><span class="n">tau_x</span> <span class="o">+</span> <span class="n">shift_x</span><span class="p">)</span> <span class="o">**</span> <span class="n">share</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">txrates</span> <span class="o">=</span> <span class="n">d_etr</span> <span class="o">*</span> <span class="n">income</span> <span class="o">+</span> <span class="n">etr</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">d_etr</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">share</span>
                        <span class="o">*</span> <span class="p">((</span><span class="n">tau_x</span> <span class="o">+</span> <span class="n">shift_x</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="n">share</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                        <span class="o">*</span> <span class="p">(</span><span class="n">max_x</span> <span class="o">-</span> <span class="n">min_x</span><span class="p">)</span>
                        <span class="o">*</span> <span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">A</span> <span class="o">*</span> <span class="n">X</span> <span class="o">+</span> <span class="n">B</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="n">A</span> <span class="o">*</span> <span class="n">X2</span> <span class="o">+</span> <span class="n">B</span> <span class="o">*</span> <span class="n">X</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
                        <span class="o">*</span> <span class="p">((</span><span class="n">tau_y</span> <span class="o">+</span> <span class="n">shift_y</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">share</span><span class="p">))</span>
                    <span class="p">)</span>
                    <span class="n">txrates</span> <span class="o">=</span> <span class="n">d_etr</span> <span class="o">*</span> <span class="n">income</span> <span class="o">+</span> <span class="n">etr</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tau_x</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">max_x</span> <span class="o">-</span> <span class="n">min_x</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">A</span> <span class="o">*</span> <span class="n">X2</span> <span class="o">+</span> <span class="n">B</span> <span class="o">*</span> <span class="n">X</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">A</span> <span class="o">*</span> <span class="n">X2</span> <span class="o">+</span> <span class="n">B</span> <span class="o">*</span> <span class="n">X</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="p">)</span> <span class="o">+</span> <span class="n">min_x</span>
                <span class="n">tau_y</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">max_y</span> <span class="o">-</span> <span class="n">min_y</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">C</span> <span class="o">*</span> <span class="n">Y2</span> <span class="o">+</span> <span class="n">D</span> <span class="o">*</span> <span class="n">Y</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">C</span> <span class="o">*</span> <span class="n">Y2</span> <span class="o">+</span> <span class="n">D</span> <span class="o">*</span> <span class="n">Y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="p">)</span> <span class="o">+</span> <span class="n">min_y</span>
                <span class="n">txrates</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">((</span><span class="n">tau_x</span> <span class="o">+</span> <span class="n">shift_x</span><span class="p">)</span> <span class="o">**</span> <span class="n">share</span><span class="p">)</span>
                    <span class="o">*</span> <span class="p">((</span><span class="n">tau_y</span> <span class="o">+</span> <span class="n">shift_y</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">share</span><span class="p">))</span>
                <span class="p">)</span> <span class="o">+</span> <span class="n">shift</span>
    <span class="k">elif</span> <span class="n">tax_func_type</span> <span class="o">==</span> <span class="s2">&quot;DEP_totalinc&quot;</span><span class="p">:</span>
        <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">max_income</span><span class="p">,</span> <span class="n">min_income</span><span class="p">,</span> <span class="n">shift_income</span><span class="p">,</span> <span class="n">shift</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">]),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">3</span><span class="p">]),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">4</span><span class="p">]),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">5</span><span class="p">]),</span>
        <span class="p">)</span>
        <span class="n">Etil</span> <span class="o">=</span> <span class="n">A</span> <span class="o">+</span> <span class="n">B</span>
        <span class="n">income2</span> <span class="o">=</span> <span class="n">income</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">if</span> <span class="n">for_estimation</span><span class="p">:</span>
            <span class="n">shift_income</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="o">-</span><span class="n">min_income</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="p">(</span>
                <span class="n">max_income</span> <span class="o">-</span> <span class="n">min_income</span>
            <span class="p">)</span>
            <span class="n">income2bar</span> <span class="o">=</span> <span class="p">(</span><span class="n">income2</span> <span class="o">*</span> <span class="n">wgts</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">wgts</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">Ibar</span> <span class="o">=</span> <span class="p">(</span><span class="n">income</span> <span class="o">*</span> <span class="n">wgts</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">wgts</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">income2til</span> <span class="o">=</span> <span class="p">(</span><span class="n">income2</span> <span class="o">-</span> <span class="n">income2bar</span><span class="p">)</span> <span class="o">/</span> <span class="n">income2bar</span>
            <span class="n">Itil</span> <span class="o">=</span> <span class="p">(</span><span class="n">income</span> <span class="o">-</span> <span class="n">Ibar</span><span class="p">)</span> <span class="o">/</span> <span class="n">Ibar</span>
            <span class="n">tau_income</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">max_income</span> <span class="o">-</span> <span class="n">min_income</span><span class="p">)</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">A</span> <span class="o">*</span> <span class="n">income2til</span> <span class="o">+</span> <span class="n">B</span> <span class="o">*</span> <span class="n">Itil</span> <span class="o">+</span> <span class="n">Etil</span><span class="p">)</span>
                <span class="o">/</span> <span class="p">(</span><span class="n">A</span> <span class="o">*</span> <span class="n">income2til</span> <span class="o">+</span> <span class="n">B</span> <span class="o">*</span> <span class="n">Itil</span> <span class="o">+</span> <span class="n">Etil</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span> <span class="o">+</span> <span class="n">min_income</span>
            <span class="n">txrates</span> <span class="o">=</span> <span class="n">tau_income</span> <span class="o">+</span> <span class="n">shift_income</span> <span class="o">+</span> <span class="n">shift</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">analytical_mtrs</span><span class="p">:</span>
                <span class="n">d_etr</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_income</span> <span class="o">-</span> <span class="n">min_income</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
                    <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">A</span> <span class="o">*</span> <span class="n">income</span> <span class="o">+</span> <span class="n">B</span><span class="p">)</span>
                    <span class="o">/</span> <span class="p">((</span><span class="n">A</span> <span class="o">*</span> <span class="n">income2</span> <span class="o">+</span> <span class="n">B</span> <span class="o">*</span> <span class="n">income</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">etr</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">(</span>
                        <span class="p">(</span><span class="n">max_income</span> <span class="o">-</span> <span class="n">min_income</span><span class="p">)</span>
                        <span class="o">*</span> <span class="p">(</span>
                            <span class="p">(</span><span class="n">A</span> <span class="o">*</span> <span class="n">income2</span> <span class="o">+</span> <span class="n">B</span> <span class="o">*</span> <span class="n">income</span><span class="p">)</span>
                            <span class="o">/</span> <span class="p">(</span><span class="n">A</span> <span class="o">*</span> <span class="n">income2</span> <span class="o">+</span> <span class="n">B</span> <span class="o">*</span> <span class="n">income</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="o">+</span> <span class="n">min_income</span>
                    <span class="p">)</span>
                    <span class="o">+</span> <span class="n">shift_income</span>
                    <span class="o">+</span> <span class="n">shift</span>
                <span class="p">)</span>
                <span class="n">txrates</span> <span class="o">=</span> <span class="p">(</span><span class="n">d_etr</span> <span class="o">*</span> <span class="n">income</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">etr</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tau_income</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">max_income</span> <span class="o">-</span> <span class="n">min_income</span><span class="p">)</span>
                    <span class="o">*</span> <span class="p">(</span><span class="n">A</span> <span class="o">*</span> <span class="n">income2</span> <span class="o">+</span> <span class="n">B</span> <span class="o">*</span> <span class="n">income</span><span class="p">)</span>
                    <span class="o">/</span> <span class="p">(</span><span class="n">A</span> <span class="o">*</span> <span class="n">income2</span> <span class="o">+</span> <span class="n">B</span> <span class="o">*</span> <span class="n">income</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="p">)</span> <span class="o">+</span> <span class="n">min_income</span>
                <span class="n">txrates</span> <span class="o">=</span> <span class="n">tau_income</span> <span class="o">+</span> <span class="n">shift_income</span> <span class="o">+</span> <span class="n">shift</span>
    <span class="k">elif</span> <span class="n">tax_func_type</span> <span class="o">==</span> <span class="s2">&quot;linear&quot;</span><span class="p">:</span>
        <span class="n">rate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">txrates</span> <span class="o">=</span> <span class="n">rate</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">income</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">tax_func_type</span> <span class="o">==</span> <span class="s2">&quot;mono&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">for_estimation</span><span class="p">:</span>
            <span class="n">mono_interp</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">txrates</span> <span class="o">=</span> <span class="n">mono_interp</span><span class="p">(</span><span class="n">income</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">income</span><span class="p">):</span>
                <span class="n">txrates</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="n">income</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">income</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># for s in range(income.shape[0]):</span>
                <span class="c1">#     txrates[s] = params[s][0](income[s])</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">income</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
                <span class="p">):</span>  <span class="c1"># for case where loops over S</span>
                    <span class="n">txrates</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">params</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="mi">0</span><span class="p">](</span><span class="n">income</span><span class="p">[</span><span class="n">s</span><span class="p">])</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">income</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">txrates</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="n">income</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">income</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="p">]</span>
            <span class="k">elif</span> <span class="p">(</span>
                <span class="n">income</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span>
            <span class="p">):</span>  <span class="c1"># I think only calls here are for loops over S and J</span>
                <span class="n">txrates</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">[</span>
                        <span class="n">params</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">](</span><span class="n">income</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">income</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="p">]</span>
                    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">income</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># to catch 3D arrays, looping over T, S, J</span>
                <span class="n">txrates</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">[</span>
                        <span class="p">[</span>
                            <span class="n">params</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="n">s</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">](</span><span class="n">income</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>
                            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">income</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                        <span class="p">]</span>
                        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">income</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="p">]</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">income</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="p">]</span>
        <span class="n">txrates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">txrates</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">tax_func_type</span> <span class="o">==</span> <span class="s2">&quot;mono2D&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">for_estimation</span><span class="p">:</span>
            <span class="n">mono_interp</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">txrates</span> <span class="o">=</span> <span class="n">mono_interp</span><span class="p">([[</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">]])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">Y</span><span class="p">):</span>
                <span class="n">txrates</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]([[</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">]])</span>
            <span class="k">elif</span> <span class="n">X</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">Y</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
                <span class="p">):</span>  <span class="c1"># for case where loops over S</span>
                    <span class="n">txrates</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">params</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="mi">0</span><span class="p">]([[</span><span class="n">X</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="n">Y</span><span class="p">]])</span>
                        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">income</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">txrates</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="n">income</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">income</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="p">]</span>
            <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="ow">and</span> <span class="n">Y</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
                <span class="p">):</span>  <span class="c1"># for case where loops over S</span>
                    <span class="n">txrates</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">params</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="mi">0</span><span class="p">]([[</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">[</span><span class="n">s</span><span class="p">]]])</span>
                        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">income</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">txrates</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="n">income</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">income</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="p">]</span>
            <span class="k">elif</span> <span class="n">X</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">Y</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
                <span class="p">):</span>
                    <span class="n">txrates</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">params</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="mi">0</span><span class="p">]([[</span><span class="n">X</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="n">Y</span><span class="p">[</span><span class="n">s</span><span class="p">]]])</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">txrates</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]([[</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Y</span><span class="p">[</span><span class="n">i</span><span class="p">]]])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="p">]</span>
            <span class="k">elif</span> <span class="n">X</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">Y</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">txrates</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">[</span>
                        <span class="n">params</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]([[</span><span class="n">X</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">Y</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">j</span><span class="p">]]])</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="p">]</span>
                    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># to catch 3D arrays, looping over T, S, J</span>
                <span class="n">txrates</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">[</span>
                        <span class="p">[</span>
                            <span class="n">params</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="n">s</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]([[</span><span class="n">X</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">Y</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">j</span><span class="p">]]])</span>
                            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">income</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                        <span class="p">]</span>
                        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">income</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="p">]</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">income</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="p">]</span>
        <span class="n">txrates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">txrates</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">txrates</span></div>



<div class="viewcode-block" id="wsumsq">
<a class="viewcode-back" href="../../content/api/txfunc.html#ogcore.txfunc.wsumsq">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">wsumsq</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function generates the weighted sum of squared deviations of</span>
<span class="sd">    predicted values of tax rates (ETR, MTRx, or MTRy) from the tax</span>
<span class="sd">    rates from the data for the Cobb-Douglas functional form of the tax</span>
<span class="sd">    function.</span>

<span class="sd">    Args:</span>
<span class="sd">        params (tuple): tax function parameter values</span>
<span class="sd">        args (tuple): contains (fixed_tax_func_params, X, Y, txrates,</span>
<span class="sd">            wgts, tax_func_type, rate_type)</span>
<span class="sd">        fixed_tax_func_params (tuple): value of parameters of tax</span>
<span class="sd">            functions that are not estimated</span>
<span class="sd">        X (array_like): labor income data</span>
<span class="sd">        Y (array_like): capital income data</span>
<span class="sd">        txrates (array_like): tax rates data</span>
<span class="sd">        wgts (array_like): weights for data observations</span>
<span class="sd">        tax_func_type (str): functional form of tax functions</span>
<span class="sd">        rate_type (str): type of tax rate: mtrx, mtry, etr</span>

<span class="sd">    Returns:</span>
<span class="sd">        wssqdev (scalar): weighted sum of squared deviations, &gt;0</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span>
        <span class="n">fixed_tax_func_params</span><span class="p">,</span>
        <span class="n">X</span><span class="p">,</span>
        <span class="n">Y</span><span class="p">,</span>
        <span class="n">txrates</span><span class="p">,</span>
        <span class="n">wgts</span><span class="p">,</span>
        <span class="n">tax_func_type</span><span class="p">,</span>
        <span class="n">rate_type</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">=</span> <span class="n">args</span>
    <span class="n">params_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">fixed_tax_func_params</span><span class="p">)</span>
    <span class="n">txrates_est</span> <span class="o">=</span> <span class="n">get_tax_rates</span><span class="p">(</span>
        <span class="n">params_all</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">wgts</span><span class="p">,</span> <span class="n">tax_func_type</span><span class="p">,</span> <span class="n">rate_type</span>
    <span class="p">)</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="n">txrates_est</span> <span class="o">-</span> <span class="n">txrates</span>
    <span class="n">wssqdev</span> <span class="o">=</span> <span class="p">(</span><span class="n">wgts</span> <span class="o">*</span> <span class="p">(</span><span class="n">errors</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">wssqdev</span></div>



<div class="viewcode-block" id="find_outliers">
<a class="viewcode-back" href="../../content/api/txfunc.html#ogcore.txfunc.find_outliers">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">find_outliers</span><span class="p">(</span><span class="n">sse_mat</span><span class="p">,</span> <span class="n">age_vec</span><span class="p">,</span> <span class="n">se_mult</span><span class="p">,</span> <span class="n">start_year</span><span class="p">,</span> <span class="n">varstr</span><span class="p">,</span> <span class="n">graph</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function takes a matrix of sum of squared errors (SSE) from</span>
<span class="sd">    tax function estimations for each age (s) in each year of the budget</span>
<span class="sd">    window (t) and marks estimations that have outlier SSE.</span>

<span class="sd">    Args:</span>
<span class="sd">        sse_mat (Numpy array): SSE for each estimated tax function,</span>
<span class="sd">            size is BW x S</span>
<span class="sd">        age_vec (numpy array): vector of ages, length S</span>
<span class="sd">        se_mult (scalar): multiple of standard deviations before</span>
<span class="sd">            consider estimate an outlier</span>
<span class="sd">        start_year (int): first year of budget window</span>
<span class="sd">        varstr (str): name of tax function being evaluated</span>
<span class="sd">        graph (bool): whether to output graphs</span>

<span class="sd">    Returns:</span>
<span class="sd">        sse_big_mat (bool array_like): indicators of whether tax function</span>
<span class="sd">            is outlier, size is BW x S</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Mark outliers from estimated MTRx functions</span>
    <span class="n">thresh</span> <span class="o">=</span> <span class="n">sse_mat</span><span class="p">[</span><span class="n">sse_mat</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">+</span> <span class="n">se_mult</span> <span class="o">*</span> <span class="n">sse_mat</span><span class="p">[</span><span class="n">sse_mat</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="n">sse_big_mat</span> <span class="o">=</span> <span class="n">sse_mat</span> <span class="o">&gt;</span> <span class="n">thresh</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="n">varstr</span><span class="p">,</span>
        <span class="s2">&quot;: &quot;</span><span class="p">,</span>
        <span class="nb">str</span><span class="p">(</span><span class="n">sse_big_mat</span><span class="o">.</span><span class="n">sum</span><span class="p">()),</span>
        <span class="s2">&quot; observations tagged as outliers.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CUR_PATH</span><span class="p">,</span> <span class="s2">&quot;OUTPUT&quot;</span><span class="p">,</span> <span class="s2">&quot;TaxFunctions&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">graph</span><span class="p">:</span>
        <span class="n">pp</span><span class="o">.</span><span class="n">txfunc_sse_plot</span><span class="p">(</span><span class="n">age_vec</span><span class="p">,</span> <span class="n">sse_mat</span><span class="p">,</span> <span class="n">start_year</span><span class="p">,</span> <span class="n">varstr</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sse_big_mat</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Mark the outliers from the first sweep above. Then mark the</span>
        <span class="c1"># new outliers in a second sweep</span>
        <span class="n">sse_mat_new</span> <span class="o">=</span> <span class="n">sse_mat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">sse_mat_new</span><span class="p">[</span><span class="n">sse_big_mat</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">thresh2</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">sse_mat_new</span><span class="p">[</span><span class="n">sse_mat_new</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="o">+</span> <span class="n">se_mult</span> <span class="o">*</span> <span class="n">sse_mat_new</span><span class="p">[</span><span class="n">sse_mat_new</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">sse_big_mat</span> <span class="o">+=</span> <span class="n">sse_mat_new</span> <span class="o">&gt;</span> <span class="n">thresh2</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="n">varstr</span><span class="p">,</span>
            <span class="s2">&quot;: &quot;</span><span class="p">,</span>
            <span class="s2">&quot;After second round, &quot;</span><span class="p">,</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">sse_big_mat</span><span class="o">.</span><span class="n">sum</span><span class="p">()),</span>
            <span class="s2">&quot; observations tagged as outliers (cumulative).&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">graph</span><span class="p">:</span>
            <span class="n">pp</span><span class="o">.</span><span class="n">txfunc_sse_plot</span><span class="p">(</span>
                <span class="n">age_vec</span><span class="p">,</span> <span class="n">sse_mat_new</span><span class="p">,</span> <span class="n">start_year</span><span class="p">,</span> <span class="n">varstr</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="mi">1</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sse_mat_new</span> <span class="o">&gt;</span> <span class="n">thresh2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Mark the outliers from the second sweep above</span>
            <span class="n">sse_mat_new2</span> <span class="o">=</span> <span class="n">sse_mat_new</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">sse_mat_new2</span><span class="p">[</span><span class="n">sse_big_mat</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">if</span> <span class="n">graph</span><span class="p">:</span>
                <span class="n">pp</span><span class="o">.</span><span class="n">txfunc_sse_plot</span><span class="p">(</span>
                    <span class="n">age_vec</span><span class="p">,</span> <span class="n">sse_mat_new2</span><span class="p">,</span> <span class="n">start_year</span><span class="p">,</span> <span class="n">varstr</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="mi">2</span>
                <span class="p">)</span>

    <span class="k">return</span> <span class="n">sse_big_mat</span></div>



<div class="viewcode-block" id="replace_outliers">
<a class="viewcode-back" href="../../content/api/txfunc.html#ogcore.txfunc.replace_outliers">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">replace_outliers</span><span class="p">(</span><span class="n">param_list</span><span class="p">,</span> <span class="n">sse_big_mat</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function replaces outlier estimated tax function parameters</span>
<span class="sd">    with linearly interpolated tax function tax function parameters</span>

<span class="sd">    Args:</span>
<span class="sd">        param_list (list): estimated tax function parameters or nonparametric</span>
<span class="sd">            functions, size is BW x S x #TaxParams</span>
<span class="sd">        sse_big_mat (bool, array_like): indicators of whether tax function</span>
<span class="sd">            is outlier, size is BW x S</span>

<span class="sd">    Returns:</span>
<span class="sd">        param_arr_adj (array_like): estimated and interpolated tax function</span>
<span class="sd">            parameters, size BW x S x #TaxParams</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">numparams</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">param_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">sse_big_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">param_list_adj</span> <span class="o">=</span> <span class="n">param_list</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sse_big_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">big_cnt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">S</span><span class="p">):</span>
            <span class="c1"># Smooth out ETR tax function outliers</span>
            <span class="k">if</span> <span class="n">sse_big_mat</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="ow">and</span> <span class="n">s</span> <span class="o">&lt;</span> <span class="n">S</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># For all outlier observations, increase the big_cnt by</span>
                <span class="c1"># 1 and set the param_arr_adj equal to nan</span>
                <span class="n">big_cnt</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">param_list_adj</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">sse_big_mat</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="ow">and</span> <span class="n">big_cnt</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">s</span> <span class="o">==</span> <span class="n">big_cnt</span><span class="p">:</span>
                <span class="c1"># When the current function is not an outlier but the last</span>
                <span class="c1"># one was and this string of outliers is at the beginning</span>
                <span class="c1"># ages, set the outliers equal to this period&#39;s tax function</span>
                <span class="n">param_list_adj</span><span class="p">[</span><span class="n">t</span><span class="p">][:</span><span class="n">big_cnt</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">param_list_adj</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="n">s</span><span class="p">]]</span> <span class="o">*</span> <span class="n">big_cnt</span>
                <span class="n">big_cnt</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">sse_big_mat</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="ow">and</span> <span class="n">big_cnt</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">s</span> <span class="o">&gt;</span> <span class="n">big_cnt</span><span class="p">:</span>
                <span class="c1"># When the current function is not an outlier but the last</span>
                <span class="c1"># one was and this string of outliers is in the interior of</span>
                <span class="c1"># ages, set the outliers equal to a linear interpolation</span>
                <span class="c1"># between the two bounding non-outlier functions</span>
                <span class="n">diff</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">param_list_adj</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="n">s</span><span class="p">]</span> <span class="o">-</span> <span class="n">param_list_adj</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="n">s</span> <span class="o">-</span> <span class="n">big_cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">slopevec</span> <span class="o">=</span> <span class="p">(</span><span class="n">diff</span> <span class="o">/</span> <span class="p">(</span><span class="n">big_cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">numparams</span><span class="p">)</span>
                <span class="n">tiled_slopevec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">slopevec</span><span class="p">,</span> <span class="p">(</span><span class="n">big_cnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

                <span class="n">interceptvec</span> <span class="o">=</span> <span class="n">param_list_adj</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="n">s</span> <span class="o">-</span> <span class="n">big_cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                    <span class="mi">1</span><span class="p">,</span> <span class="n">numparams</span>
                <span class="p">)</span>
                <span class="n">tiled_intvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">interceptvec</span><span class="p">,</span> <span class="p">(</span><span class="n">big_cnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

                <span class="n">reshaped_arange</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">big_cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">big_cnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">tiled_reshape_arange</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">reshaped_arange</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">numparams</span><span class="p">))</span>

                <span class="k">for</span> <span class="n">s_ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">big_cnt</span><span class="p">):</span>
                    <span class="n">param_list_adj</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="n">s</span> <span class="o">-</span> <span class="n">big_cnt</span> <span class="o">+</span> <span class="n">s_ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">tiled_intvec</span><span class="p">[</span>
                        <span class="n">s_ind</span><span class="p">,</span> <span class="p">:</span>
                    <span class="p">]</span> <span class="o">+</span> <span class="p">(</span>
                        <span class="n">tiled_slopevec</span><span class="p">[</span><span class="n">s_ind</span><span class="p">,</span> <span class="p">:]</span>
                        <span class="o">*</span> <span class="n">tiled_reshape_arange</span><span class="p">[</span><span class="n">s_ind</span><span class="p">,</span> <span class="p">:]</span>
                    <span class="p">)</span>

                <span class="n">big_cnt</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">sse_big_mat</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span> <span class="ow">and</span> <span class="n">s</span> <span class="o">==</span> <span class="n">sse_big_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># When the last ages are outliers, set the parameters equal</span>
                <span class="c1"># to the most recent non-outlier tax function</span>
                <span class="n">big_cnt</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">param_list_adj</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">reshaped</span> <span class="o">=</span> <span class="n">param_list_adj</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="n">s</span> <span class="o">-</span> <span class="n">big_cnt</span><span class="p">]</span>
                <span class="n">param_list_adj</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="n">s</span> <span class="o">-</span> <span class="n">big_cnt</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">param_list_adj</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="n">s</span> <span class="o">-</span> <span class="n">big_cnt</span><span class="p">]</span>
                <span class="p">]</span> <span class="o">*</span> <span class="n">big_cnt</span>

    <span class="k">return</span> <span class="n">param_list_adj</span></div>



<div class="viewcode-block" id="txfunc_est">
<a class="viewcode-back" href="../../content/api/txfunc.html#ogcore.txfunc.txfunc_est">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">txfunc_est</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">s</span><span class="p">,</span>
    <span class="n">t</span><span class="p">,</span>
    <span class="n">rate_type</span><span class="p">,</span>
    <span class="n">tax_func_type</span><span class="p">,</span>
    <span class="n">numparams</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="p">,</span>
    <span class="n">graph</span><span class="p">,</span>
    <span class="n">params_init</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">global_opt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function uses tax tax rate and income data for individuals of a</span>
<span class="sd">    particular age (s) and a particular year (t) to estimate the</span>
<span class="sd">    parameters of a Cobb-Douglas aggregation function of two ratios of</span>
<span class="sd">    polynomials in labor income and capital income, respectively.</span>

<span class="sd">    Args:</span>
<span class="sd">        df (Pandas DataFrame): 11 variables with N observations of tax</span>
<span class="sd">            rates</span>
<span class="sd">        s (int): age of individual, &gt;= 21</span>
<span class="sd">        t (int): year of analysis, &gt;= 2016</span>
<span class="sd">        rate_type (str): type of tax rate: mtrx, mtry, etr</span>
<span class="sd">        tax_func_type (str): functional form of tax functions</span>
<span class="sd">        numparams (int): number of parameters in the tax functions</span>
<span class="sd">        output_dir (str): output directory for saving plot files</span>
<span class="sd">        graph (bool): whether to plot the estimated functions compared</span>
<span class="sd">            to the data</span>
<span class="sd">        params_init (Numpy array): initial values for the parameters</span>
<span class="sd">        global_opt (bool): whether to use global optimization method</span>

<span class="sd">    Returns:</span>
<span class="sd">        (tuple): tax function estimation output:</span>

<span class="sd">            * params (Numpy array or function object): vector of estimated</span>
<span class="sd">            parameters or nonparametric function object</span>
<span class="sd">            * wsse (scalar): weighted sum of squared deviations from</span>
<span class="sd">            minimization</span>
<span class="sd">            * obs (int): number of observations in the data, &gt; 600</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;total_labinc&quot;</span><span class="p">]</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;total_capinc&quot;</span><span class="p">]</span>
    <span class="n">wgts</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span>
    <span class="n">X2</span> <span class="o">=</span> <span class="n">X</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">Y2</span> <span class="o">=</span> <span class="n">Y</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">X2bar</span> <span class="o">=</span> <span class="p">(</span><span class="n">X2</span> <span class="o">*</span> <span class="n">wgts</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">wgts</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">Xbar</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span> <span class="o">*</span> <span class="n">wgts</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">wgts</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">Y2bar</span> <span class="o">=</span> <span class="p">(</span><span class="n">Y2</span> <span class="o">*</span> <span class="n">wgts</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">wgts</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">Ybar</span> <span class="o">=</span> <span class="p">(</span><span class="n">Y</span> <span class="o">*</span> <span class="n">wgts</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">wgts</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">income</span> <span class="o">=</span> <span class="n">X</span> <span class="o">+</span> <span class="n">Y</span>
    <span class="n">income2</span> <span class="o">=</span> <span class="n">income</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">Ibar</span> <span class="o">=</span> <span class="p">(</span><span class="n">income</span> <span class="o">*</span> <span class="n">wgts</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">wgts</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">income2bar</span> <span class="o">=</span> <span class="p">(</span><span class="n">income2</span> <span class="o">*</span> <span class="n">wgts</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">wgts</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">rate_type</span> <span class="o">==</span> <span class="s2">&quot;etr&quot;</span><span class="p">:</span>
        <span class="n">txrates</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;etr&quot;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">rate_type</span> <span class="o">==</span> <span class="s2">&quot;mtrx&quot;</span><span class="p">:</span>
        <span class="n">txrates</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;mtr_labinc&quot;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">rate_type</span> <span class="o">==</span> <span class="s2">&quot;mtry&quot;</span><span class="p">:</span>
        <span class="n">txrates</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;mtr_capinc&quot;</span><span class="p">]</span>
    <span class="n">x_10pctl</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;total_labinc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">y_10pctl</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;total_capinc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">x_20pctl</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;total_labinc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
    <span class="n">y_20pctl</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;total_capinc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
    <span class="n">min_x</span> <span class="o">=</span> <span class="n">txrates</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;total_capinc&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">y_10pctl</span><span class="p">)]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">min_y</span> <span class="o">=</span> <span class="n">txrates</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;total_labinc&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">x_10pctl</span><span class="p">)]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">tax_func_type</span> <span class="o">==</span> <span class="s2">&quot;DEP&quot;</span><span class="p">:</span>
        <span class="c1"># &#39;&#39;&#39;</span>
        <span class="c1"># Estimate DeBacker, Evans, Phillips (2018) ratio of polynomial</span>
        <span class="c1"># tax functions.</span>
        <span class="c1"># &#39;&#39;&#39;</span>
        <span class="c1"># if Atil_init not exist, set to 1.0</span>
        <span class="k">if</span> <span class="n">params_init</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Atil_init</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">Btil_init</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">Ctil_init</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">Dtil_init</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">max_x_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                <span class="n">txrates</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;total_capinc&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">y_20pctl</span><span class="p">)]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">MAX_ETR</span> <span class="o">+</span> <span class="mf">0.05</span>
            <span class="p">)</span>
            <span class="n">max_y_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                <span class="n">txrates</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;total_labinc&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">x_20pctl</span><span class="p">)]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">MAX_ETR</span> <span class="o">+</span> <span class="mf">0.05</span>
            <span class="p">)</span>
            <span class="n">share_init</span> <span class="o">=</span> <span class="mf">0.5</span>
            <span class="n">params_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">Atil_init</span><span class="p">,</span>
                    <span class="n">Btil_init</span><span class="p">,</span>
                    <span class="n">Ctil_init</span><span class="p">,</span>
                    <span class="n">Dtil_init</span><span class="p">,</span>
                    <span class="n">max_x_init</span><span class="p">,</span>
                    <span class="n">max_y_init</span><span class="p">,</span>
                    <span class="n">share_init</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="n">txrates</span><span class="p">[</span>
            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;total_labinc&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">x_20pctl</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;total_capinc&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">y_20pctl</span><span class="p">)</span>
        <span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">shift_x</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># temp value</span>
        <span class="n">shift_y</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># temp value</span>
        <span class="n">tx_objs</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">min_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">,</span> <span class="n">shift_x</span><span class="p">,</span> <span class="n">shift_y</span><span class="p">,</span> <span class="n">shift</span><span class="p">]),</span>
            <span class="n">X</span><span class="p">,</span>
            <span class="n">Y</span><span class="p">,</span>
            <span class="n">txrates</span><span class="p">,</span>
            <span class="n">wgts</span><span class="p">,</span>
            <span class="n">tax_func_type</span><span class="p">,</span>
            <span class="n">rate_type</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">lb_max_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">min_x</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-4</span>
        <span class="n">lb_max_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">min_y</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-4</span>
        <span class="n">bnds</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="mf">1e-12</span><span class="p">,</span> <span class="mi">9999</span><span class="p">),</span>
            <span class="p">(</span><span class="mf">1e-12</span><span class="p">,</span> <span class="mi">9999</span><span class="p">),</span>
            <span class="p">(</span><span class="mf">1e-12</span><span class="p">,</span> <span class="mi">9999</span><span class="p">),</span>
            <span class="p">(</span><span class="mf">1e-12</span><span class="p">,</span> <span class="mi">9999</span><span class="p">),</span>
            <span class="p">(</span><span class="n">lb_max_x</span><span class="p">,</span> <span class="n">MAX_ETR</span> <span class="o">+</span> <span class="mf">0.15</span><span class="p">),</span>
            <span class="p">(</span><span class="n">lb_max_y</span><span class="p">,</span> <span class="n">MAX_ETR</span> <span class="o">+</span> <span class="mf">0.15</span><span class="p">),</span>
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">global_opt</span><span class="p">:</span>
            <span class="n">params_til</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">differential_evolution</span><span class="p">(</span>
                <span class="n">wsumsq</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bnds</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">tx_objs</span><span class="p">),</span> <span class="n">seed</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">params_til</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
                <span class="n">wsumsq</span><span class="p">,</span>
                <span class="n">params_init</span><span class="p">,</span>
                <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">tx_objs</span><span class="p">),</span>
                <span class="n">method</span><span class="o">=</span><span class="s2">&quot;L-BFGS-B&quot;</span><span class="p">,</span>
                <span class="n">bounds</span><span class="o">=</span><span class="n">bnds</span><span class="p">,</span>
                <span class="n">tol</span><span class="o">=</span><span class="mf">1e-15</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">Atil</span><span class="p">,</span> <span class="n">Btil</span><span class="p">,</span> <span class="n">Ctil</span><span class="p">,</span> <span class="n">Dtil</span><span class="p">,</span> <span class="n">max_x</span><span class="p">,</span> <span class="n">max_y</span><span class="p">,</span> <span class="n">share</span> <span class="o">=</span> <span class="n">params_til</span><span class="o">.</span><span class="n">x</span>
        <span class="c1"># message = (&quot;(max_x, min_x)=(&quot; + str(max_x) + &quot;, &quot; + str(min_x) +</span>
        <span class="c1">#     &quot;), (max_y, min_y)=(&quot; + str(max_y) + &quot;, &quot; + str(min_y) + &quot;)&quot;)</span>
        <span class="c1"># print(message)</span>
        <span class="n">wsse</span> <span class="o">=</span> <span class="n">params_til</span><span class="o">.</span><span class="n">fun</span>
        <span class="n">obs</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">shift_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="o">-</span><span class="n">min_x</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_x</span> <span class="o">-</span> <span class="n">min_x</span><span class="p">)</span>
        <span class="n">shift_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="o">-</span><span class="n">min_y</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_y</span> <span class="o">-</span> <span class="n">min_y</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">numparams</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">Atil</span><span class="p">,</span> <span class="n">Btil</span><span class="p">,</span> <span class="n">Ctil</span><span class="p">,</span> <span class="n">Dtil</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="n">X2bar</span><span class="p">,</span> <span class="n">Xbar</span><span class="p">,</span> <span class="n">Y2bar</span><span class="p">,</span> <span class="n">Ybar</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="n">max_x</span><span class="p">,</span> <span class="n">max_y</span><span class="p">,</span> <span class="n">share</span><span class="p">,</span> <span class="n">min_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">,</span> <span class="n">shift_x</span><span class="p">,</span> <span class="n">shift_y</span><span class="p">,</span> <span class="n">shift</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">params_to_plot</span> <span class="o">=</span> <span class="n">params</span>
        <span class="c1"># set initial values to parameter estimates</span>
        <span class="n">params_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">Atil</span><span class="p">,</span>
                <span class="n">Btil</span><span class="p">,</span>
                <span class="n">Ctil</span><span class="p">,</span>
                <span class="n">Dtil</span><span class="p">,</span>
                <span class="n">max_x</span><span class="p">,</span>
                <span class="n">max_y</span><span class="p">,</span>
                <span class="n">share</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">tax_func_type</span> <span class="o">==</span> <span class="s2">&quot;DEP_totalinc&quot;</span><span class="p">:</span>
        <span class="c1"># &#39;&#39;&#39;</span>
        <span class="c1"># Estimate DeBacker, Evans, Phillips (2018) ratio of polynomial</span>
        <span class="c1"># tax functions as a function of total income.</span>
        <span class="c1"># &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">params_init</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Atil_init</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">Btil_init</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">max_x_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                <span class="n">txrates</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;total_capinc&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">y_20pctl</span><span class="p">)]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">MAX_ETR</span> <span class="o">+</span> <span class="mf">0.05</span>
            <span class="p">)</span>
            <span class="n">max_y_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                <span class="n">txrates</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;total_labinc&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">x_20pctl</span><span class="p">)]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">MAX_ETR</span> <span class="o">+</span> <span class="mf">0.05</span>
            <span class="p">)</span>
            <span class="n">max_income_init</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_x_init</span><span class="p">,</span> <span class="n">max_y_init</span><span class="p">)</span>
            <span class="n">share_init</span> <span class="o">=</span> <span class="mf">0.5</span>
            <span class="n">params_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">Atil_init</span><span class="p">,</span> <span class="n">Btil_init</span><span class="p">,</span> <span class="n">max_income_init</span><span class="p">])</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="n">txrates</span><span class="p">[</span>
            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;total_labinc&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">x_20pctl</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;total_capinc&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">y_20pctl</span><span class="p">)</span>
        <span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">min_income</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">min_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">)</span>
        <span class="n">shift_inc</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># temp value</span>
        <span class="n">tx_objs</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">min_income</span><span class="p">,</span> <span class="n">shift_inc</span><span class="p">,</span> <span class="n">shift</span><span class="p">]),</span>
            <span class="n">X</span><span class="p">,</span>
            <span class="n">Y</span><span class="p">,</span>
            <span class="n">txrates</span><span class="p">,</span>
            <span class="n">wgts</span><span class="p">,</span>
            <span class="n">tax_func_type</span><span class="p">,</span>
            <span class="n">rate_type</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">lb_max_income</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">min_income</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-4</span>
        <span class="c1"># bnds = ((1e-12, None), (1e-12, None), (lb_max_income, MAX_ETR + 0.15))</span>
        <span class="n">bnds</span> <span class="o">=</span> <span class="p">((</span><span class="mf">1e-12</span><span class="p">,</span> <span class="mi">99999</span><span class="p">),</span> <span class="p">(</span><span class="mf">1e-12</span><span class="p">,</span> <span class="mi">9999</span><span class="p">),</span> <span class="p">(</span><span class="n">lb_max_income</span><span class="p">,</span> <span class="n">MAX_ETR</span> <span class="o">+</span> <span class="mf">0.15</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">global_opt</span><span class="p">:</span>
            <span class="n">params_til</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">differential_evolution</span><span class="p">(</span>
                <span class="n">wsumsq</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bnds</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">tx_objs</span><span class="p">),</span> <span class="n">seed</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">params_til</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
                <span class="n">wsumsq</span><span class="p">,</span>
                <span class="n">params_init</span><span class="p">,</span>
                <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">tx_objs</span><span class="p">),</span>
                <span class="n">method</span><span class="o">=</span><span class="s2">&quot;L-BFGS-B&quot;</span><span class="p">,</span>
                <span class="n">bounds</span><span class="o">=</span><span class="n">bnds</span><span class="p">,</span>
                <span class="n">tol</span><span class="o">=</span><span class="mf">1e-15</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">Atil</span><span class="p">,</span> <span class="n">Btil</span><span class="p">,</span> <span class="n">max_income</span> <span class="o">=</span> <span class="n">params_til</span><span class="o">.</span><span class="n">x</span>
        <span class="n">wsse</span> <span class="o">=</span> <span class="n">params_til</span><span class="o">.</span><span class="n">fun</span>
        <span class="n">obs</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">shift_income</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="o">-</span><span class="n">min_income</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="p">(</span>
            <span class="n">max_income</span> <span class="o">-</span> <span class="n">min_income</span>
        <span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">numparams</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">Atil</span><span class="p">,</span> <span class="n">Btil</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">income2bar</span><span class="p">,</span> <span class="n">Ibar</span><span class="p">])</span>
        <span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">max_income</span><span class="p">,</span> <span class="n">min_income</span><span class="p">,</span> <span class="n">shift_income</span><span class="p">,</span> <span class="n">shift</span><span class="p">])</span>
        <span class="n">params_to_plot</span> <span class="o">=</span> <span class="n">params</span>
        <span class="c1"># set initial values to parameter estimates</span>
        <span class="n">params_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">Atil</span><span class="p">,</span> <span class="n">Btil</span><span class="p">,</span> <span class="n">max_income</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">tax_func_type</span> <span class="o">==</span> <span class="s2">&quot;GS&quot;</span><span class="p">:</span>
        <span class="c1"># &#39;&#39;&#39;</span>
        <span class="c1"># Estimate Gouveia-Strauss parameters via least squares.</span>
        <span class="c1"># Need to use a different functional form than for DEP function.</span>
        <span class="c1"># &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">params_init</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">phi0_init</span> <span class="o">=</span> <span class="mf">0.3</span>
            <span class="n">phi1_init</span> <span class="o">=</span> <span class="mf">0.3</span>
            <span class="n">phi2_init</span> <span class="o">=</span> <span class="mf">0.01</span>
            <span class="n">params_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">phi0_init</span><span class="p">,</span> <span class="n">phi1_init</span><span class="p">,</span> <span class="n">phi2_init</span><span class="p">])</span>
        <span class="n">tx_objs</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">None</span><span class="p">]),</span>
            <span class="n">X</span><span class="p">,</span>
            <span class="n">Y</span><span class="p">,</span>
            <span class="n">txrates</span><span class="p">,</span>
            <span class="n">wgts</span><span class="p">,</span>
            <span class="n">tax_func_type</span><span class="p">,</span>
            <span class="n">rate_type</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">bnds</span> <span class="o">=</span> <span class="p">((</span><span class="mf">1e-12</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="p">(</span><span class="mf">1e-12</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="p">(</span><span class="mf">1e-12</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">global_opt</span><span class="p">:</span>
            <span class="n">params_til</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">differential_evolution</span><span class="p">(</span>
                <span class="n">wsumsq</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bnds</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">tx_objs</span><span class="p">),</span> <span class="n">seed</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">params_til</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
                <span class="n">wsumsq</span><span class="p">,</span>
                <span class="n">params_init</span><span class="p">,</span>
                <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">tx_objs</span><span class="p">),</span>
                <span class="n">method</span><span class="o">=</span><span class="s2">&quot;L-BFGS-B&quot;</span><span class="p">,</span>
                <span class="n">bounds</span><span class="o">=</span><span class="n">bnds</span><span class="p">,</span>
                <span class="n">tol</span><span class="o">=</span><span class="mf">1e-15</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">phi0til</span><span class="p">,</span> <span class="n">phi1til</span><span class="p">,</span> <span class="n">phi2til</span> <span class="o">=</span> <span class="n">params_til</span><span class="o">.</span><span class="n">x</span>
        <span class="n">wsse</span> <span class="o">=</span> <span class="n">params_til</span><span class="o">.</span><span class="n">fun</span>
        <span class="n">obs</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">numparams</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">phi0til</span><span class="p">,</span> <span class="n">phi1til</span><span class="p">,</span> <span class="n">phi2til</span><span class="p">])</span>
        <span class="n">params_to_plot</span> <span class="o">=</span> <span class="n">params</span>
        <span class="c1"># set initial values to parameter estimates</span>
        <span class="n">params_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">phi0til</span><span class="p">,</span> <span class="n">phi1til</span><span class="p">,</span> <span class="n">phi2til</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">tax_func_type</span> <span class="o">==</span> <span class="s2">&quot;HSV&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Estimate Heathcote, Storesletten, Violante (2017) parameters via</span>
<span class="sd">        OLS</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">constant</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">income</span><span class="p">)</span>
        <span class="n">ln_income</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">income</span><span class="p">)</span>
        <span class="n">X_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">constant</span><span class="p">,</span> <span class="n">ln_income</span><span class="p">))</span>
        <span class="n">Y_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">txrates</span><span class="p">)</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">wgts</span><span class="p">)</span>
        <span class="n">param_est</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">X_mat</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">W</span> <span class="o">@</span> <span class="n">X_mat</span><span class="p">)</span> <span class="o">@</span> <span class="n">X_mat</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">W</span> <span class="o">@</span> <span class="n">Y_vec</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">numparams</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rate_type</span> <span class="o">==</span> <span class="s2">&quot;etr&quot;</span><span class="p">:</span>
            <span class="n">ln_lambda_s_hat</span><span class="p">,</span> <span class="n">minus_tau_s_hat</span> <span class="o">=</span> <span class="n">param_est</span>
            <span class="n">params</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">ln_lambda_s_hat</span><span class="p">),</span> <span class="o">-</span><span class="n">minus_tau_s_hat</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">constant</span><span class="p">,</span> <span class="n">minus_tau_s_hat</span> <span class="o">=</span> <span class="n">param_est</span>
            <span class="n">lambda_s_hat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">constant</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">minus_tau_s_hat</span><span class="p">))</span>
            <span class="n">params</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">lambda_s_hat</span><span class="p">,</span> <span class="o">-</span><span class="n">minus_tau_s_hat</span><span class="p">])</span>
        <span class="c1"># Calculate the WSSE</span>
        <span class="n">Y_hat</span> <span class="o">=</span> <span class="n">X_mat</span> <span class="o">@</span> <span class="n">params</span>
        <span class="n">wsse</span> <span class="o">=</span> <span class="p">((</span><span class="n">Y_vec</span> <span class="o">-</span> <span class="n">Y_hat</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">wgts</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">obs</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">params_to_plot</span> <span class="o">=</span> <span class="n">params</span>
    <span class="k">elif</span> <span class="n">tax_func_type</span> <span class="o">==</span> <span class="s2">&quot;linear&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For linear rates, just take the mean ETR or MTR by age-year.</span>
<span class="sd">        Can use DEP form and set all parameters except for the shift</span>
<span class="sd">        parameter to zero.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">numparams</span><span class="p">)</span>
        <span class="n">wsse</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">obs</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">txrates</span> <span class="o">*</span> <span class="n">wgts</span> <span class="o">*</span> <span class="n">income</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">income</span> <span class="o">*</span> <span class="n">wgts</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">params_to_plot</span> <span class="o">=</span> <span class="n">params</span>
    <span class="k">elif</span> <span class="n">tax_func_type</span> <span class="o">==</span> <span class="s2">&quot;mono&quot;</span><span class="p">:</span>
        <span class="c1"># &#39;&#39;&#39;</span>
        <span class="c1"># For monotonically increasing smoothing spline function rates, return</span>
        <span class="c1"># the resulting function object in place of parametric model.</span>
        <span class="c1"># This is the approach we will take with all nonparametric tax</span>
        <span class="c1"># functions and might be the best approach even for our parametric</span>
        <span class="c1"># tax functions.</span>
        <span class="c1"># &#39;&#39;&#39;</span>
        <span class="c1"># Set the number of bins to 500 unless the number of observations is</span>
        <span class="c1"># less-than-or-equal-to 1,000 and greater-than-or-equal-to MIN_OBS. For</span>
        <span class="c1"># that case create a linear function of bin number as 80% of MIN_OBS at</span>
        <span class="c1"># MIN_OBS and 500 bins at 1,000 observations.</span>
        <span class="n">obs</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">slope</span> <span class="o">=</span> <span class="p">(</span><span class="mi">500</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mf">0.8</span> <span class="o">*</span> <span class="n">MIN_OBS</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1_000</span> <span class="o">-</span> <span class="n">MIN_OBS</span><span class="p">)</span>
        <span class="n">intercept</span> <span class="o">=</span> <span class="mi">500</span> <span class="o">-</span> <span class="n">slope</span> <span class="o">*</span> <span class="mi">1_000</span>
        <span class="n">bin_num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">obs</span> <span class="o">+</span> <span class="n">intercept</span><span class="p">)</span>
        <span class="n">mono_interp</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">wsse_cstr</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">monotone_spline</span><span class="p">(</span>
            <span class="n">income</span><span class="p">,</span> <span class="n">txrates</span><span class="p">,</span> <span class="n">wgts</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bin_num</span>
        <span class="p">)</span>
        <span class="n">wsse</span> <span class="o">=</span> <span class="n">wsse_cstr</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="n">mono_interp</span><span class="p">]</span>
        <span class="n">params_to_plot</span> <span class="o">=</span> <span class="n">params</span>
    <span class="k">elif</span> <span class="n">tax_func_type</span> <span class="o">==</span> <span class="s2">&quot;mono2D&quot;</span><span class="p">:</span>
        <span class="n">obs</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">mono_interp</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">wsse_cstr</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">monotone_spline</span><span class="p">(</span>
            <span class="c1"># df[[&quot;total_labinc&quot;, &quot;total_capinc&quot;]].values,</span>
            <span class="c1"># df[&quot;etr&quot;].values,</span>
            <span class="c1"># df[&quot;weight&quot;].values,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
            <span class="c1"># X, Y,</span>
            <span class="n">txrates</span><span class="p">,</span>
            <span class="n">wgts</span><span class="p">,</span>
            <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;pygam&quot;</span><span class="p">,</span>
            <span class="n">splines</span><span class="o">=</span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">wsse</span> <span class="o">=</span> <span class="n">wsse_cstr</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="n">mono_interp</span><span class="p">]</span>
        <span class="n">params_to_plot</span> <span class="o">=</span> <span class="n">params</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s2">&quot;Choice of tax function is not in the set of&quot;</span>
            <span class="o">+</span> <span class="s2">&quot; possible tax functions.  Please select&quot;</span>
            <span class="o">+</span> <span class="s2">&quot; from: DEP, DEP_totalinc, GS, linear, mono, mono2D.&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">graph</span><span class="p">:</span>
        <span class="n">pp</span><span class="o">.</span><span class="n">txfunc_graph</span><span class="p">(</span>
            <span class="n">s</span><span class="p">,</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">df</span><span class="p">,</span>
            <span class="n">X</span><span class="p">,</span>
            <span class="n">Y</span><span class="p">,</span>
            <span class="n">txrates</span><span class="p">,</span>
            <span class="n">rate_type</span><span class="p">,</span>
            <span class="n">tax_func_type</span><span class="p">,</span>
            <span class="n">params_to_plot</span><span class="p">,</span>
            <span class="n">output_dir</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Garbage collection</span>
    <span class="k">del</span> <span class="n">df</span><span class="p">,</span> <span class="n">txrates</span>

    <span class="k">return</span> <span class="n">params</span><span class="p">,</span> <span class="n">wsse</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">params_init</span></div>



<div class="viewcode-block" id="tax_data_sample">
<a class="viewcode-back" href="../../content/api/txfunc.html#ogcore.txfunc.tax_data_sample">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">tax_data_sample</span><span class="p">(</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">max_etr</span><span class="o">=</span><span class="n">MAX_ETR</span><span class="p">,</span> <span class="n">min_income</span><span class="o">=</span><span class="n">MIN_INCOME</span><span class="p">,</span> <span class="n">max_mtr</span><span class="o">=</span><span class="n">MAX_MTR</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to create sample tax data for estimation by dropping</span>
<span class="sd">    observations with extreme values.</span>

<span class="sd">    Args:</span>
<span class="sd">        data (DataFrame): raw data from microsimulation model</span>

<span class="sd">    Returns:</span>
<span class="sd">        data (DataFrame): selected sample</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># drop all obs with ETR &gt; MAX_ETR</span>
    <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;etr&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">MAX_ETR</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># drop all obs with ETR &lt; MIN_ETR</span>
    <span class="c1"># set min ETR to value at 10th percentile in distribution of ETRs</span>
    <span class="n">min_etr</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;etr&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="mf">0.10</span><span class="p">)</span>
    <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;etr&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min_etr</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># drop all obs with total market income, labor income, or</span>
    <span class="c1"># capital income &lt; MIN_INCOME</span>
    <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
        <span class="n">data</span><span class="p">[</span>
            <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;market_income&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">MIN_INCOME</span><span class="p">)</span>
            <span class="o">|</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;total_labinc&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">MIN_INCOME</span><span class="p">)</span>
            <span class="o">|</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;total_capinc&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">MIN_INCOME</span><span class="p">)</span>
        <span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
        <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># drop all obs with MTR on capital income &gt; MAX_MTR</span>
    <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;mtr_capinc&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">MAX_MTR</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># drop all obs with MTR on capital income &lt; min_cap_mtr</span>
    <span class="c1"># set min MTR to value at 10th percentile in distribution of MTRs</span>
    <span class="n">min_cap_mtr</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;mtr_capinc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="mf">0.10</span><span class="p">)</span>
    <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;mtr_capinc&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min_cap_mtr</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># drop all obs with MTR on labor income &gt; MAX_MTR</span>
    <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;mtr_labinc&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">MAX_MTR</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># drop all obs with MTR on labor income &lt; min_lab_mtr</span>
    <span class="n">min_lab_mtr</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;mtr_labinc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="mf">0.10</span><span class="p">)</span>
    <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;mtr_labinc&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min_lab_mtr</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span></div>



<div class="viewcode-block" id="tax_func_loop">
<a class="viewcode-back" href="../../content/api/txfunc.html#ogcore.txfunc.tax_func_loop">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">tax_func_loop</span><span class="p">(</span>
    <span class="n">t</span><span class="p">,</span>
    <span class="n">data</span><span class="p">,</span>
    <span class="n">start_year</span><span class="p">,</span>
    <span class="n">s_min</span><span class="p">,</span>
    <span class="n">s_max</span><span class="p">,</span>
    <span class="n">age_specific</span><span class="p">,</span>
    <span class="n">tax_func_type</span><span class="p">,</span>
    <span class="n">analytical_mtrs</span><span class="p">,</span>
    <span class="n">desc_data</span><span class="p">,</span>
    <span class="n">graph_data</span><span class="p">,</span>
    <span class="n">graph_est</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="p">,</span>
    <span class="n">numparams</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Estimates tax functions for a particular year.  Looped over.</span>

<span class="sd">    Args:</span>
<span class="sd">        t (int): year of tax data to estimated tax functions for</span>
<span class="sd">        data (Pandas DataFrame): tax return data for year t</span>
<span class="sd">        start_yr (int): first year of budget window</span>
<span class="sd">        s_min (int): minimum age to estimate tax functions for</span>
<span class="sd">        s_max (int): maximum age to estimate tax functions for</span>
<span class="sd">        age_specific (bool): whether to estimate age specific tax</span>
<span class="sd">            functions</span>
<span class="sd">        tax_func_type (str): functional form of tax functions</span>
<span class="sd">        analytical_mtrs (bool): whether to use the analytical derivation</span>
<span class="sd">            of the marginal tax rates (and thus only need to estimate</span>
<span class="sd">            the effective tax rate functions)</span>
<span class="sd">        desc_data (bool): whether to print descriptive statistics</span>
<span class="sd">        graph_data (bool): whether to plot data</span>
<span class="sd">        graph_est (bool): whether to plot estimated coefficients</span>
<span class="sd">        output_dir (str): path to save output to</span>
<span class="sd">        numparams (int): number of parameters in tax functions</span>

<span class="sd">    Returns:</span>
<span class="sd">        (tuple): tax function estimation output:</span>

<span class="sd">            * TotPop_yr (int): total population derived from micro data</span>
<span class="sd">            * Pct_age (Numpy array): fraction of observations that are</span>
<span class="sd">                in each age bin</span>
<span class="sd">            * AvgInc (scalar): mean income in the data</span>
<span class="sd">            * AvgETR (scalar): mean effective tax rate in data</span>
<span class="sd">            * AvgMTRx (scalar): mean marginal tax rate on labor income</span>
<span class="sd">                in data</span>
<span class="sd">            * AvgMTRy (scalar): mean marginal tax rate on capital income</span>
<span class="sd">                in data</span>
<span class="sd">            * frac_tax_payroll (scalar): fraction of total tax revenue</span>
<span class="sd">                the comes from payroll taxes</span>
<span class="sd">            * etrparam_arr (Numpy array): parameters of the effective</span>
<span class="sd">                tax rate functions</span>
<span class="sd">            * etr_wsumsq_arr (Numpy array): weighted sum of squares from</span>
<span class="sd">                estimation of the effective tax rate functions</span>
<span class="sd">            * etr_obs_arr (Numpy array): weighted sum of squares from</span>
<span class="sd">                estimation of the effective tax rate functions</span>
<span class="sd">            * mtrxparam_arr (Numpy array): parameters of the marginal</span>
<span class="sd">                tax rate on labor income functions</span>
<span class="sd">            * mtrx_wsumsq_arr (Numpy array): weighted sum of squares</span>
<span class="sd">                from estimation of the marginal tax rate on labor income</span>
<span class="sd">                functions</span>
<span class="sd">            * mtrx_obs_arr (Numpy array): weighted sum of squares from</span>
<span class="sd">                estimation of the marginal tax rate on labor income</span>
<span class="sd">                functions</span>
<span class="sd">            * mtryparam_arr (Numpy array): parameters of the marginal</span>
<span class="sd">                tax rate on capital income functions</span>
<span class="sd">            * mtry_wsumsq_arr (Numpy array): weighted sum of squares</span>
<span class="sd">                from estimation of the marginal tax rate on capital</span>
<span class="sd">                income functions</span>
<span class="sd">            * mtry_obs_arr (Numpy array): weighted sum of squares from</span>
<span class="sd">                estimation of the marginal tax rate on capital income</span>
<span class="sd">                functions</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># initialize arrays for output</span>
    <span class="n">etrparam_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">s_max</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">mtrxparam_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">s_max</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">mtryparam_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">s_max</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">etr_wsumsq_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">s_max</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">etr_obs_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">s_max</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">mtrx_wsumsq_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">s_max</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">mtrx_obs_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">s_max</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">mtry_wsumsq_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">s_max</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">mtry_obs_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">s_max</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">PopPct_age</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">s_max</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Calculate average total income in each year</span>
    <span class="n">AvgInc</span> <span class="o">=</span> <span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;market_income&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span> <span class="o">/</span> <span class="n">data</span><span class="p">[</span>
        <span class="s2">&quot;weight&quot;</span>
    <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="c1"># Calculate average ETR and MTRs (weight by population weights</span>
    <span class="c1">#    and income) for each year</span>
    <span class="n">AvgETR</span> <span class="o">=</span> <span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;etr&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;market_income&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span> <span class="o">/</span> <span class="p">(</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;market_income&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span>
    <span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="n">AvgMTRx</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;mtr_labinc&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;market_income&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;market_income&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="n">AvgMTRy</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;mtr_capinc&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;market_income&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;market_income&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="c1"># Caulcatoe fraction of total tax liability that is from payroll</span>
    <span class="c1"># taxes</span>
    <span class="n">frac_tax_payroll</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;payroll_tax_liab&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;total_tax_liab&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span>
    <span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="c1"># Calculate total population in each year</span>
    <span class="n">TotPop_yr</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="c1"># Clean up the data by dropping outliers</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">tax_data_sample</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="c1"># Create an array of the different ages in the data</span>
    <span class="n">min_age</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;age&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">s_min</span><span class="p">))</span>
    <span class="n">max_age</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;age&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">s_max</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">age_specific</span><span class="p">:</span>
        <span class="n">ages_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">min_age</span><span class="p">,</span> <span class="n">max_age</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ages_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">NoData_cnt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">min_age</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Each age s must be done in serial</span>
    <span class="c1"># Set initial values</span>
    <span class="c1"># TODO: update this, so if using DEP or GS initial parameters are estimated on all ages first</span>
    <span class="k">if</span> <span class="n">tax_func_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;DEP&quot;</span><span class="p">,</span> <span class="s2">&quot;DEP_totalinc&quot;</span><span class="p">,</span> <span class="s2">&quot;GS&quot;</span><span class="p">]:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">df_etr</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">df</span><span class="p">[</span>
                <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;etr&quot;</span><span class="p">]))</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;total_labinc&quot;</span><span class="p">]))</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;total_capinc&quot;</span><span class="p">]))</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]))</span>
            <span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="p">[</span>
                <span class="s2">&quot;mtr_labinc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;mtr_capinc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;total_labinc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;total_capinc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;etr&quot;</span><span class="p">,</span>
                <span class="s2">&quot;weight&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df_mtrx</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">df</span><span class="p">[</span>
                <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;mtr_labinc&quot;</span><span class="p">]))</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;total_labinc&quot;</span><span class="p">]))</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;total_capinc&quot;</span><span class="p">]))</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]))</span>
            <span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;mtr_labinc&quot;</span><span class="p">,</span> <span class="s2">&quot;total_labinc&quot;</span><span class="p">,</span> <span class="s2">&quot;total_capinc&quot;</span><span class="p">,</span> <span class="s2">&quot;weight&quot;</span><span class="p">],</span>
        <span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df_mtry</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">df</span><span class="p">[</span>
                <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;mtr_capinc&quot;</span><span class="p">]))</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;total_labinc&quot;</span><span class="p">]))</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;total_capinc&quot;</span><span class="p">]))</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]))</span>
            <span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;mtr_capinc&quot;</span><span class="p">,</span> <span class="s2">&quot;total_labinc&quot;</span><span class="p">,</span> <span class="s2">&quot;total_capinc&quot;</span><span class="p">,</span> <span class="s2">&quot;weight&quot;</span><span class="p">],</span>
        <span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># Estimate effective tax rate function ETR(x,y)</span>
        <span class="p">(</span>
            <span class="n">etrparams</span><span class="p">,</span>
            <span class="n">etr_wsumsq_arr</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">],</span>
            <span class="n">etr_obs_arr</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">],</span>
            <span class="n">params_init_etr</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="n">txfunc_est</span><span class="p">(</span>
            <span class="n">df_etr</span><span class="p">,</span>
            <span class="n">s</span><span class="p">,</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="s2">&quot;etr&quot;</span><span class="p">,</span>
            <span class="n">tax_func_type</span><span class="p">,</span>
            <span class="n">numparams</span><span class="p">,</span>
            <span class="n">output_dir</span><span class="p">,</span>
            <span class="kc">False</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">etrparam_list</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">]</span> <span class="o">=</span> <span class="n">etrparams</span>
        <span class="k">del</span> <span class="n">df_etr</span>

        <span class="c1"># Estimate marginal tax rate of labor income function</span>
        <span class="c1"># MTRx(x,y)</span>
        <span class="p">(</span>
            <span class="n">mtrxparams</span><span class="p">,</span>
            <span class="n">mtrx_wsumsq_arr</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">],</span>
            <span class="n">mtrx_obs_arr</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">],</span>
            <span class="n">params_init_mtrx</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="n">txfunc_est</span><span class="p">(</span>
            <span class="n">df_mtrx</span><span class="p">,</span>
            <span class="n">s</span><span class="p">,</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="s2">&quot;mtrx&quot;</span><span class="p">,</span>
            <span class="n">tax_func_type</span><span class="p">,</span>
            <span class="n">numparams</span><span class="p">,</span>
            <span class="n">output_dir</span><span class="p">,</span>
            <span class="kc">False</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">del</span> <span class="n">df_mtrx</span>
        <span class="c1"># Estimate marginal tax rate of capital income function</span>
        <span class="c1"># MTRy(x,y)</span>
        <span class="p">(</span>
            <span class="n">mtryparams</span><span class="p">,</span>
            <span class="n">mtry_wsumsq_arr</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">],</span>
            <span class="n">mtry_obs_arr</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">],</span>
            <span class="n">params_init_mtry</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="n">txfunc_est</span><span class="p">(</span>
            <span class="n">df_mtry</span><span class="p">,</span>
            <span class="n">s</span><span class="p">,</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="s2">&quot;mtry&quot;</span><span class="p">,</span>
            <span class="n">tax_func_type</span><span class="p">,</span>
            <span class="n">numparams</span><span class="p">,</span>
            <span class="n">output_dir</span><span class="p">,</span>
            <span class="kc">False</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">mtryparam_list</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">]</span> <span class="o">=</span> <span class="n">mtryparams</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">params_init_etr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">params_init_mtrx</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">params_init_mtry</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">ages_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">age_specific</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Year=&quot;</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="s2">&quot;Age=&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;age&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">s</span><span class="p">]</span>
            <span class="n">PopPct_age</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">min_age</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">TotPop_yr</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;year=&quot;</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="s2">&quot;age= all ages&quot;</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">data</span>
            <span class="n">PopPct_age</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">TotPop_yr</span>
        <span class="n">df_etr</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">df</span><span class="p">[</span>
                <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;etr&quot;</span><span class="p">]))</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;total_labinc&quot;</span><span class="p">]))</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;total_capinc&quot;</span><span class="p">]))</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]))</span>
            <span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="p">[</span>
                <span class="s2">&quot;mtr_labinc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;mtr_capinc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;total_labinc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;total_capinc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;etr&quot;</span><span class="p">,</span>
                <span class="s2">&quot;weight&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df_mtrx</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">df</span><span class="p">[</span>
                <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;mtr_labinc&quot;</span><span class="p">]))</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;total_labinc&quot;</span><span class="p">]))</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;total_capinc&quot;</span><span class="p">]))</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]))</span>
            <span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;mtr_labinc&quot;</span><span class="p">,</span> <span class="s2">&quot;total_labinc&quot;</span><span class="p">,</span> <span class="s2">&quot;total_capinc&quot;</span><span class="p">,</span> <span class="s2">&quot;weight&quot;</span><span class="p">],</span>
        <span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df_mtry</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">df</span><span class="p">[</span>
                <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;mtr_capinc&quot;</span><span class="p">]))</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;total_labinc&quot;</span><span class="p">]))</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;total_capinc&quot;</span><span class="p">]))</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]))</span>
            <span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;mtr_capinc&quot;</span><span class="p">,</span> <span class="s2">&quot;total_labinc&quot;</span><span class="p">,</span> <span class="s2">&quot;total_capinc&quot;</span><span class="p">,</span> <span class="s2">&quot;weight&quot;</span><span class="p">],</span>
        <span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df_minobs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span>
            <span class="p">[</span><span class="n">df_etr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">df_mtrx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">df_mtry</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="p">)</span>
        <span class="k">del</span> <span class="n">df</span>

        <span class="k">if</span> <span class="n">df_minobs</span> <span class="o">&lt;</span> <span class="n">MIN_OBS</span> <span class="ow">and</span> <span class="n">s</span> <span class="o">&lt;</span> <span class="n">max_age</span><span class="p">:</span>
            <span class="c1"># &#39;&#39;&#39;</span>
            <span class="c1"># --------------------------------------------------------</span>
            <span class="c1"># Don&#39;t estimate function on this iteration if obs &lt; 240.</span>
            <span class="c1"># Will fill in later with interpolated values</span>
            <span class="c1"># --------------------------------------------------------</span>
            <span class="c1"># &#39;&#39;&#39;</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Insuff. sample size for age &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; in year &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="n">NoData_cnt</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">etrparam_list</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">mtrxparam_list</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">mtryparam_list</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">elif</span> <span class="n">df_minobs</span> <span class="o">&lt;</span> <span class="n">MIN_OBS</span> <span class="ow">and</span> <span class="n">s</span> <span class="o">==</span> <span class="n">max_age</span><span class="p">:</span>
            <span class="c1"># &#39;&#39;&#39;</span>
            <span class="c1"># --------------------------------------------------------</span>
            <span class="c1"># If last period does not have sufficient data, fill in</span>
            <span class="c1"># final missing age data with last positive year</span>
            <span class="c1"># --------------------------------------------------------</span>
            <span class="c1"># lastp_etr  = (numparams,) vector, vector of parameter</span>
            <span class="c1">#              estimates from previous age with sufficient</span>
            <span class="c1">#              observations</span>
            <span class="c1"># lastp_mtrx = (numparams,) vector, vector of parameter</span>
            <span class="c1">#              estimates from previous age with sufficient</span>
            <span class="c1">#              observations</span>
            <span class="c1"># lastp_mtry = (numparams,) vector, vector of parameter</span>
            <span class="c1">#              estimates from previous age with sufficient</span>
            <span class="c1">#              observations</span>
            <span class="c1"># --------------------------------------------------------</span>
            <span class="c1"># &#39;&#39;&#39;</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Max age (s=&quot;</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot;) insuff. data in&quot;</span>
                <span class="o">+</span> <span class="s2">&quot; year &quot;</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot;. Fill in final ages with &quot;</span>
                <span class="o">+</span> <span class="s2">&quot;insuff. data with most recent successful &quot;</span>
                <span class="o">+</span> <span class="s2">&quot;estimate.&quot;</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="n">NoData_cnt</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">lastp_etr</span> <span class="o">=</span> <span class="n">etrparam_list</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">NoData_cnt</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">]</span>
            <span class="n">etrparam_list</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">NoData_cnt</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">lastp_etr</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                <span class="n">NoData_cnt</span> <span class="o">+</span> <span class="n">s_max</span> <span class="o">-</span> <span class="n">max_age</span>
            <span class="p">)</span>
            <span class="n">lastp_mtrx</span> <span class="o">=</span> <span class="n">mtrxparam_list</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">NoData_cnt</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">]</span>
            <span class="n">mtrxparam_list</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">NoData_cnt</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">lastp_mtrx</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                <span class="n">NoData_cnt</span> <span class="o">+</span> <span class="n">s_max</span> <span class="o">-</span> <span class="n">max_age</span>
            <span class="p">)</span>
            <span class="n">lastp_mtry</span> <span class="o">=</span> <span class="n">mtryparam_list</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">NoData_cnt</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">]</span>
            <span class="n">mtryparam_list</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">NoData_cnt</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">lastp_mtry</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                <span class="n">NoData_cnt</span> <span class="o">+</span> <span class="n">s_max</span> <span class="o">-</span> <span class="n">max_age</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Estimate parameters for age with sufficient data</span>
            <span class="k">if</span> <span class="n">desc_data</span><span class="p">:</span>
                <span class="c1"># print some desciptive stats</span>
                <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;Descriptive ETR statistics for age=&quot;</span>
                    <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                    <span class="o">+</span> <span class="s2">&quot; in year &quot;</span>
                    <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">df_etr</span><span class="o">.</span><span class="n">describe</span><span class="p">())</span>
                <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;Descriptive MTRx statistics for age=&quot;</span>
                    <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                    <span class="o">+</span> <span class="s2">&quot; in year &quot;</span>
                    <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">df_mtrx</span><span class="o">.</span><span class="n">describe</span><span class="p">())</span>
                <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;Descriptive MTRy statistics for age=&quot;</span>
                    <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                    <span class="o">+</span> <span class="s2">&quot; in year &quot;</span>
                    <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">df_mtry</span><span class="o">.</span><span class="n">describe</span><span class="p">())</span>

            <span class="k">if</span> <span class="n">graph_data</span><span class="p">:</span>
                <span class="n">pp</span><span class="o">.</span><span class="n">gen_3Dscatters_hist</span><span class="p">(</span><span class="n">df_etr</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">)</span>

            <span class="c1"># Estimate effective tax rate function ETR(x,y)</span>
            <span class="p">(</span>
                <span class="n">etrparams</span><span class="p">,</span>
                <span class="n">etr_wsumsq_arr</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">],</span>
                <span class="n">etr_obs_arr</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">],</span>
                <span class="n">params_init</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="n">txfunc_est</span><span class="p">(</span>
                <span class="n">df_etr</span><span class="p">,</span>
                <span class="n">s</span><span class="p">,</span>
                <span class="n">t</span><span class="p">,</span>
                <span class="s2">&quot;etr&quot;</span><span class="p">,</span>
                <span class="n">tax_func_type</span><span class="p">,</span>
                <span class="n">numparams</span><span class="p">,</span>
                <span class="n">output_dir</span><span class="p">,</span>
                <span class="n">graph_est</span><span class="p">,</span>
                <span class="n">params_init_etr</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">etrparam_list</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">]</span> <span class="o">=</span> <span class="n">etrparams</span>
            <span class="k">del</span> <span class="n">df_etr</span>

            <span class="c1"># Estimate marginal tax rate of labor income function</span>
            <span class="c1"># MTRx(x,y)</span>
            <span class="p">(</span>
                <span class="n">mtrxparams</span><span class="p">,</span>
                <span class="n">mtrx_wsumsq_arr</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">],</span>
                <span class="n">mtrx_obs_arr</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">],</span>
                <span class="n">params_init</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="n">txfunc_est</span><span class="p">(</span>
                <span class="n">df_mtrx</span><span class="p">,</span>
                <span class="n">s</span><span class="p">,</span>
                <span class="n">t</span><span class="p">,</span>
                <span class="s2">&quot;mtrx&quot;</span><span class="p">,</span>
                <span class="n">tax_func_type</span><span class="p">,</span>
                <span class="n">numparams</span><span class="p">,</span>
                <span class="n">output_dir</span><span class="p">,</span>
                <span class="n">graph_est</span><span class="p">,</span>
                <span class="n">params_init_mtrx</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">mtrxparam_list</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">]</span> <span class="o">=</span> <span class="n">mtrxparams</span>
            <span class="k">del</span> <span class="n">df_mtrx</span>
            <span class="c1"># Estimate marginal tax rate of capital income function</span>
            <span class="c1"># MTRy(x,y)</span>
            <span class="p">(</span>
                <span class="n">mtryparams</span><span class="p">,</span>
                <span class="n">mtry_wsumsq_arr</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">],</span>
                <span class="n">mtry_obs_arr</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">],</span>
                <span class="n">params_init</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="n">txfunc_est</span><span class="p">(</span>
                <span class="n">df_mtry</span><span class="p">,</span>
                <span class="n">s</span><span class="p">,</span>
                <span class="n">t</span><span class="p">,</span>
                <span class="s2">&quot;mtry&quot;</span><span class="p">,</span>
                <span class="n">tax_func_type</span><span class="p">,</span>
                <span class="n">numparams</span><span class="p">,</span>
                <span class="n">output_dir</span><span class="p">,</span>
                <span class="n">graph_est</span><span class="p">,</span>
                <span class="n">params_init_mtry</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">mtryparam_list</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">]</span> <span class="o">=</span> <span class="n">mtryparams</span>

            <span class="k">del</span> <span class="n">df_mtry</span>

            <span class="k">if</span> <span class="n">NoData_cnt</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;</span> <span class="n">NoData_cnt</span> <span class="o">==</span> <span class="n">s</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">:</span>
                <span class="c1"># &#39;&#39;&#39;</span>
                <span class="c1"># ----------------------------------------------------</span>
                <span class="c1"># Fill in initial blanks with first positive data</span>
                <span class="c1"># estimates. This includes the case in which</span>
                <span class="c1"># min_age &gt; s_min</span>
                <span class="c1"># ----------------------------------------------------</span>
                <span class="c1"># &#39;&#39;&#39;</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Fill in all previous blank ages&quot;</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="n">etrparam_list</span><span class="p">[:</span> <span class="n">s</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">etrparams</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">s</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">)</span>
                <span class="n">mtrxparam_list</span><span class="p">[:</span> <span class="n">s</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">mtrxparams</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">s</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">)</span>
                <span class="n">mtryparam_list</span><span class="p">[:</span> <span class="n">s</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">mtryparams</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">s</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">)</span>

            <span class="k">elif</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">NoData_cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">NoData_cnt</span> <span class="o">&lt;</span> <span class="n">s</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">tax_func_type</span> <span class="o">!=</span> <span class="s2">&quot;mono&quot;</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="c1"># &#39;&#39;&#39;</span>
                <span class="c1"># -------------------------------------------------------------</span>
                <span class="c1"># For all parametric tax function types (not &quot;mono&quot;), fill in</span>
                <span class="c1"># interior data gaps with linear interpolation between</span>
                <span class="c1"># bracketing positive data ages. In all of these cases,</span>
                <span class="c1"># min_age &lt; s &lt;= max_age.</span>
                <span class="c1"># -------------------------------------------------------------</span>
                <span class="c1"># tvals        = (NoData_cnt+2,) vector, linearly</span>
                <span class="c1">#                space points between 0 and 1</span>
                <span class="c1"># x0_etr       = (NoData_cnt x 10) matrix, positive</span>
                <span class="c1">#                estimates at beginning of no data</span>
                <span class="c1">#                spell</span>
                <span class="c1"># x1_etr       = (NoData_cnt x 10) matrix, positive</span>
                <span class="c1">#                estimates at end (current period) of</span>
                <span class="c1">#                no data spell</span>
                <span class="c1"># lin_int_etr  = (NoData_cnt x 10) matrix, linearly</span>
                <span class="c1">#                interpolated etr parameters between</span>
                <span class="c1">#                x0_etr and x1_etr</span>
                <span class="c1"># x0_mtrx      = (NoData_cnt x 10) matrix, positive</span>
                <span class="c1">#                estimates at beginning of no data</span>
                <span class="c1">#                spell</span>
                <span class="c1"># x1_mtrx      = (NoData_cnt x 10) matrix, positive</span>
                <span class="c1">#                estimates at end (current period) of</span>
                <span class="c1">#                no data spell</span>
                <span class="c1"># lin_int_mtrx = (NoData_cnt x 10) matrix, linearly</span>
                <span class="c1">#                interpolated mtrx parameters between</span>
                <span class="c1">#                x0_mtrx and x1_mtrx</span>
                <span class="c1"># -------------------------------------------------------------</span>
                <span class="c1"># &#39;&#39;&#39;</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Linearly interpolate previous blank tax functions&quot;</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="n">tvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NoData_cnt</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">x0_etr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span>
                    <span class="n">etrparam_list</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">NoData_cnt</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                        <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">numparams</span><span class="p">)</span>
                    <span class="p">),</span>
                    <span class="p">(</span><span class="n">NoData_cnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="n">x1_etr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span>
                    <span class="n">etrparams</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">numparams</span><span class="p">)),</span> <span class="p">(</span><span class="n">NoData_cnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">lin_int_etr</span> <span class="o">=</span> <span class="n">x0_etr</span> <span class="o">+</span> <span class="n">tvals</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">NoData_cnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span>
                    <span class="n">x1_etr</span> <span class="o">-</span> <span class="n">x0_etr</span>
                <span class="p">)</span>

                <span class="n">x0_mtrx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span>
                    <span class="n">mtrxparam_list</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">NoData_cnt</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                        <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">numparams</span><span class="p">)</span>
                    <span class="p">),</span>
                    <span class="p">(</span><span class="n">NoData_cnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="n">x1_mtrx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span>
                    <span class="n">mtrxparams</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">numparams</span><span class="p">)),</span> <span class="p">(</span><span class="n">NoData_cnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">lin_int_mtrx</span> <span class="o">=</span> <span class="n">x0_mtrx</span> <span class="o">+</span> <span class="n">tvals</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">NoData_cnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1_mtrx</span> <span class="o">-</span> <span class="n">x0_mtrx</span><span class="p">)</span>

                <span class="n">x0_mtry</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span>
                    <span class="n">mtryparam_list</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">NoData_cnt</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                        <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">numparams</span><span class="p">)</span>
                    <span class="p">),</span>
                    <span class="p">(</span><span class="n">NoData_cnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="n">x1_mtry</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span>
                    <span class="n">mtryparams</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">numparams</span><span class="p">)),</span> <span class="p">(</span><span class="n">NoData_cnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">lin_int_mtry</span> <span class="o">=</span> <span class="n">x0_mtry</span> <span class="o">+</span> <span class="n">tvals</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">NoData_cnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1_mtry</span> <span class="o">-</span> <span class="n">x0_mtry</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">s_ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NoData_cnt</span><span class="p">):</span>
                    <span class="n">etrparam_list</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">NoData_cnt</span> <span class="o">-</span> <span class="n">min_age</span> <span class="o">+</span> <span class="n">s_ind</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">lin_int_etr</span><span class="p">[</span><span class="n">s_ind</span><span class="p">,</span> <span class="p">:]</span>
                    <span class="p">)</span>
                    <span class="n">mtrxparam_list</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">NoData_cnt</span> <span class="o">-</span> <span class="n">min_age</span> <span class="o">+</span> <span class="n">s_ind</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">lin_int_mtrx</span><span class="p">[</span><span class="n">s_ind</span><span class="p">,</span> <span class="p">:]</span>
                    <span class="p">)</span>
                    <span class="n">mtryparam_list</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">NoData_cnt</span> <span class="o">-</span> <span class="n">min_age</span> <span class="o">+</span> <span class="n">s_ind</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">lin_int_mtry</span><span class="p">[</span><span class="n">s_ind</span><span class="p">,</span> <span class="p">:]</span>
                    <span class="p">)</span>

            <span class="k">elif</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">NoData_cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">NoData_cnt</span> <span class="o">&lt;</span> <span class="n">s</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">tax_func_type</span> <span class="o">==</span> <span class="s2">&quot;mono&quot;</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="c1"># &#39;&#39;&#39;</span>
                <span class="c1"># -------------------------------------------------------------</span>
                <span class="c1"># For all nonparametric tax function types (&quot;mono&quot;), fill in</span>
                <span class="c1"># interior data gaps with the previous estimated interpolating</span>
                <span class="c1"># function (no interpolation between last function and current</span>
                <span class="c1"># function). In all of these cases, min_age &lt; s &lt;= max_age.</span>
                <span class="c1"># -------------------------------------------------------------</span>
                <span class="n">etrparam_list</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">NoData_cnt</span> <span class="o">-</span> <span class="n">min_age</span> <span class="p">:</span> <span class="n">s</span> <span class="o">-</span> <span class="n">min_age</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">etrparam_list</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">NoData_cnt</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="p">]</span> <span class="o">*</span> <span class="n">NoData_cnt</span>
                <span class="n">mtrxparam_list</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">NoData_cnt</span> <span class="o">-</span> <span class="n">min_age</span> <span class="p">:</span> <span class="n">s</span> <span class="o">-</span> <span class="n">min_age</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">mtrxparam_list</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">NoData_cnt</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="p">]</span> <span class="o">*</span> <span class="n">NoData_cnt</span>
                <span class="n">mtryparam_list</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">NoData_cnt</span> <span class="o">-</span> <span class="n">min_age</span> <span class="p">:</span> <span class="n">s</span> <span class="o">-</span> <span class="n">min_age</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">mtryparam_list</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">NoData_cnt</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="p">]</span> <span class="o">*</span> <span class="n">NoData_cnt</span>

            <span class="n">NoData_cnt</span> <span class="o">==</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="n">max_age</span> <span class="ow">and</span> <span class="n">max_age</span> <span class="o">&lt;</span> <span class="n">s_max</span><span class="p">:</span>
                <span class="c1"># &#39;&#39;&#39;</span>
                <span class="c1"># ----------------------------------------------------</span>
                <span class="c1"># If the last age estimates, and max_age&lt; s_max, fill</span>
                <span class="c1"># in the remaining ages with these last estimates</span>
                <span class="c1"># ----------------------------------------------------</span>
                <span class="c1"># &#39;&#39;&#39;</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Fill in all remaining old age tax functions.&quot;</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="n">etrparam_list</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">etrparams</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                    <span class="n">s_max</span> <span class="o">-</span> <span class="n">max_age</span>
                <span class="p">)</span>
                <span class="n">mtrxparam_list</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">mtrxparams</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                    <span class="n">s_max</span> <span class="o">-</span> <span class="n">max_age</span>
                <span class="p">)</span>
                <span class="n">mtryparam_list</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">mtryparams</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                    <span class="n">s_max</span> <span class="o">-</span> <span class="n">max_age</span>
                <span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="n">TotPop_yr</span><span class="p">,</span>
        <span class="n">PopPct_age</span><span class="p">,</span>
        <span class="n">AvgInc</span><span class="p">,</span>
        <span class="n">AvgETR</span><span class="p">,</span>
        <span class="n">AvgMTRx</span><span class="p">,</span>
        <span class="n">AvgMTRy</span><span class="p">,</span>
        <span class="n">frac_tax_payroll</span><span class="p">,</span>
        <span class="n">etrparam_list</span><span class="p">,</span>
        <span class="n">etr_wsumsq_arr</span><span class="p">,</span>
        <span class="n">etr_obs_arr</span><span class="p">,</span>
        <span class="n">mtrxparam_list</span><span class="p">,</span>
        <span class="n">mtrx_wsumsq_arr</span><span class="p">,</span>
        <span class="n">mtrx_obs_arr</span><span class="p">,</span>
        <span class="n">mtryparam_list</span><span class="p">,</span>
        <span class="n">mtry_wsumsq_arr</span><span class="p">,</span>
        <span class="n">mtry_obs_arr</span><span class="p">,</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="tax_func_estimate">
<a class="viewcode-back" href="../../content/api/txfunc.html#ogcore.txfunc.tax_func_estimate">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">tax_func_estimate</span><span class="p">(</span>
    <span class="n">micro_data</span><span class="p">,</span>
    <span class="n">BW</span><span class="p">,</span>
    <span class="n">S</span><span class="p">,</span>
    <span class="n">starting_age</span><span class="p">,</span>
    <span class="n">ending_age</span><span class="p">,</span>
    <span class="n">start_year</span><span class="o">=</span><span class="n">DEFAULT_START_YEAR</span><span class="p">,</span>
    <span class="n">analytical_mtrs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">tax_func_type</span><span class="o">=</span><span class="s2">&quot;DEP&quot;</span><span class="p">,</span>
    <span class="n">age_specific</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">desc_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">graph_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">graph_est</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">num_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">tax_func_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function performs analysis on the source data from microsimulation</span>
<span class="sd">    model and estimates functions for the effective tax rate (ETR), marginal</span>
<span class="sd">    tax rate on labor income (MTRx), and marginal tax rate on capital income</span>
<span class="sd">    (MTRy).</span>

<span class="sd">    Args:</span>
<span class="sd">        micro_data (dict): Dictionary of DataFrames with micro data</span>
<span class="sd">        BW (int): number of years in the budget window (the period</span>
<span class="sd">            over which tax policy is assumed to vary)</span>
<span class="sd">        S (int): number of model periods a model agent is economically</span>
<span class="sd">            active for</span>
<span class="sd">        starting_age (int): minimum age to estimate tax functions for</span>
<span class="sd">        ending_age (int): maximum age to estimate tax functions for</span>
<span class="sd">        start_yr (int): first year of budget window</span>
<span class="sd">        analytical_mtrs (bool): whether to use the analytical derivation</span>
<span class="sd">            of the marginal tax rates (and thus only need to estimate</span>
<span class="sd">            the effective tax rate functions)</span>
<span class="sd">        tax_func_type (str): functional form of tax functions</span>
<span class="sd">        age_specific (bool): whether to estimate age specific tax</span>
<span class="sd">            functions</span>
<span class="sd">        client (Dask client object): client</span>
<span class="sd">        num_workers (int): number of workers to use for parallelization</span>
<span class="sd">            with Dask</span>
<span class="sd">        tax_func_path (str): path to save pickle with estimated tax</span>
<span class="sd">            function parameters to</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict_param (dict): dictionary with tax function parameters</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s_min</span> <span class="o">=</span> <span class="n">starting_age</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">s_max</span> <span class="o">=</span> <span class="n">ending_age</span>
    <span class="n">start_year</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">start_year</span><span class="p">)</span>
    <span class="n">end_yr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">start_year</span> <span class="o">+</span> <span class="n">BW</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;BW = &quot;</span><span class="p">,</span> <span class="n">BW</span><span class="p">,</span> <span class="s2">&quot;begin year = &quot;</span><span class="p">,</span> <span class="n">start_year</span><span class="p">,</span> <span class="s2">&quot;end year = &quot;</span><span class="p">,</span> <span class="n">end_yr</span><span class="p">)</span>
    <span class="n">tax_func_type_num_params_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;DEP&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
        <span class="s2">&quot;DEP_totalinc&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
        <span class="s2">&quot;GS&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="s2">&quot;HSV&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s2">&quot;linear&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;mono&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;mono2D&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">numparams</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tax_func_type_num_params_dict</span><span class="p">[</span><span class="n">tax_func_type</span><span class="p">])</span>
    <span class="n">years_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start_year</span><span class="p">,</span> <span class="n">end_yr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">age_specific</span><span class="p">:</span>
        <span class="n">ages_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">s_min</span><span class="p">,</span> <span class="n">s_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ages_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="c1"># initialize arrays for output</span>
    <span class="n">etrparam_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">BW</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">mtrxparam_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">BW</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">mtryparam_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">BW</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">etr_wsumsq_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">BW</span><span class="p">,</span> <span class="n">s_max</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">etr_obs_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">BW</span><span class="p">,</span> <span class="n">s_max</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">mtrx_wsumsq_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">BW</span><span class="p">,</span> <span class="n">s_max</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">mtrx_obs_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">BW</span><span class="p">,</span> <span class="n">s_max</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">mtry_wsumsq_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">BW</span><span class="p">,</span> <span class="n">s_max</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">mtry_obs_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">BW</span><span class="p">,</span> <span class="n">s_max</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">AvgInc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">BW</span><span class="p">)</span>
    <span class="n">AvgETR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">BW</span><span class="p">)</span>
    <span class="n">AvgMTRx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">BW</span><span class="p">)</span>
    <span class="n">AvgMTRy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">BW</span><span class="p">)</span>
    <span class="n">frac_tax_payroll</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">BW</span><span class="p">)</span>
    <span class="n">TotPop_yr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">BW</span><span class="p">)</span>
    <span class="n">PopPct_age</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">BW</span><span class="p">,</span> <span class="n">s_max</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

    <span class="c1"># &#39;&#39;&#39;</span>
    <span class="c1"># --------------------------------------------------------------------</span>
    <span class="c1"># Solve for tax functions for each year (t) and each age (s)</span>
    <span class="c1"># --------------------------------------------------------------------</span>
    <span class="c1"># start_time = scalar, current processor time in seconds (float)</span>
    <span class="c1"># output_dir = string, directory to which plots will be saved</span>
    <span class="c1"># t          = integer &gt;= start_year, index for year of analysis</span>
    <span class="c1"># --------------------------------------------------------------------</span>
    <span class="c1"># &#39;&#39;&#39;</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">tax_func_path</span><span class="p">:</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CUR_PATH</span><span class="p">,</span> <span class="s2">&quot;OUTPUT&quot;</span><span class="p">,</span> <span class="s2">&quot;TaxFunctions&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">tax_func_path</span><span class="p">),</span> <span class="s2">&quot;OUTPUT&quot;</span><span class="p">,</span> <span class="s2">&quot;TaxFunctions&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">F_OK</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>

    <span class="n">lazy_values</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">years_list</span><span class="p">:</span>
        <span class="n">lazy_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">delayed</span><span class="p">(</span><span class="n">tax_func_loop</span><span class="p">)(</span>
                <span class="n">t</span><span class="p">,</span>
                <span class="n">micro_data</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)],</span>
                <span class="n">start_year</span><span class="p">,</span>
                <span class="n">s_min</span><span class="p">,</span>
                <span class="n">s_max</span><span class="p">,</span>
                <span class="n">age_specific</span><span class="p">,</span>
                <span class="n">tax_func_type</span><span class="p">,</span>
                <span class="n">analytical_mtrs</span><span class="p">,</span>
                <span class="n">desc_data</span><span class="p">,</span>
                <span class="n">graph_data</span><span class="p">,</span>
                <span class="n">graph_est</span><span class="p">,</span>
                <span class="n">output_dir</span><span class="p">,</span>
                <span class="n">numparams</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">client</span><span class="p">:</span>
        <span class="n">futures</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">lazy_values</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">futures</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">results</span> <span class="o">=</span> <span class="n">compute</span><span class="p">(</span>
            <span class="o">*</span><span class="n">lazy_values</span><span class="p">,</span>
            <span class="n">scheduler</span><span class="o">=</span><span class="n">dask</span><span class="o">.</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">get</span><span class="p">,</span>
            <span class="n">num_workers</span><span class="o">=</span><span class="n">num_workers</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Garbage collection</span>
    <span class="k">del</span> <span class="n">micro_data</span>

    <span class="c1"># for i, result in results.items():</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">results</span><span class="p">):</span>
        <span class="p">(</span>
            <span class="n">TotPop_yr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="n">PopPct_age</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span>
            <span class="n">AvgInc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="n">AvgETR</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="n">AvgMTRx</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="n">AvgMTRy</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="n">frac_tax_payroll</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="n">etrparam_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="n">etr_wsumsq_arr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span>
            <span class="n">etr_obs_arr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span>
            <span class="n">mtrxparam_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="n">mtrx_wsumsq_arr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span>
            <span class="n">mtrx_obs_arr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span>
            <span class="n">mtryparam_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="n">mtry_wsumsq_arr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span>
            <span class="n">mtry_obs_arr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span>
        <span class="p">)</span> <span class="o">=</span> <span class="n">result</span>

    <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;Finished tax function loop through &quot;</span>
        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">years_list</span><span class="p">))</span>
        <span class="o">+</span> <span class="s2">&quot; years and &quot;</span>
        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ages_list</span><span class="p">))</span>
        <span class="o">+</span> <span class="s2">&quot; ages per year.&quot;</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

    <span class="c1"># Print tax function computation time</span>
    <span class="k">if</span> <span class="n">elapsed_time</span> <span class="o">&lt;</span> <span class="mi">60</span><span class="p">:</span>  <span class="c1"># less than a minute</span>
        <span class="n">secs</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">elapsed_time</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Tax function estimation time: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">secs</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; sec&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">elapsed_time</span> <span class="o">&gt;=</span> <span class="mi">60</span> <span class="ow">and</span> <span class="n">elapsed_time</span> <span class="o">&lt;</span> <span class="mi">3600</span><span class="p">:</span>  <span class="c1"># less than hour</span>
        <span class="n">mins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">elapsed_time</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span>
        <span class="n">secs</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(((</span><span class="n">elapsed_time</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span> <span class="o">-</span> <span class="n">mins</span><span class="p">)</span> <span class="o">*</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Tax function estimation time: &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mins</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; min, &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">secs</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; sec&quot;</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">elapsed_time</span> <span class="o">&gt;=</span> <span class="mi">3600</span> <span class="ow">and</span> <span class="n">elapsed_time</span> <span class="o">&lt;</span> <span class="mi">86400</span><span class="p">:</span>  <span class="c1"># less than day</span>
        <span class="n">hours</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">elapsed_time</span> <span class="o">/</span> <span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">))</span>
        <span class="n">mins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">elapsed_time</span> <span class="o">-</span> <span class="p">(</span><span class="n">hours</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">))</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span>
        <span class="n">secs</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">elapsed_time</span> <span class="o">-</span> <span class="p">(</span><span class="n">hours</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">mins</span> <span class="o">*</span> <span class="mi">60</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Tax function estimation time: &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">hours</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; hour(s), &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mins</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; min(s), &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">secs</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; sec(s)&quot;</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="c1"># &#39;&#39;&#39;</span>
    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Replace outlier tax functions (SSE&gt;mean+2.5*std) with linear</span>
    <span class="c1"># interpolation for parametric tax functions (not &quot;mono&quot;). We make two</span>
    <span class="c1"># passes (filtering runs).</span>
    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">age_specific</span> <span class="ow">and</span> <span class="n">tax_func_type</span> <span class="o">!=</span> <span class="s2">&quot;mono&quot;</span><span class="p">:</span>
        <span class="n">age_sup</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">s_min</span><span class="p">,</span> <span class="n">s_max</span><span class="p">,</span> <span class="n">s_max</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">se_mult</span> <span class="o">=</span> <span class="mf">3.5</span>
        <span class="n">etr_sse_big</span> <span class="o">=</span> <span class="n">find_outliers</span><span class="p">(</span>
            <span class="n">etr_wsumsq_arr</span> <span class="o">/</span> <span class="n">etr_obs_arr</span><span class="p">,</span>
            <span class="n">age_sup</span><span class="p">,</span>
            <span class="n">se_mult</span><span class="p">,</span>
            <span class="n">start_year</span><span class="p">,</span>
            <span class="s2">&quot;ETR&quot;</span><span class="p">,</span>
            <span class="n">graph</span><span class="o">=</span><span class="n">graph_est</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">etr_sse_big</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">etrparam_list_adj</span> <span class="o">=</span> <span class="n">replace_outliers</span><span class="p">(</span><span class="n">etrparam_list</span><span class="p">,</span> <span class="n">etr_sse_big</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">etr_sse_big</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">etrparam_list_adj</span> <span class="o">=</span> <span class="n">etrparam_list</span>

        <span class="n">mtrx_sse_big</span> <span class="o">=</span> <span class="n">find_outliers</span><span class="p">(</span>
            <span class="n">mtrx_wsumsq_arr</span> <span class="o">/</span> <span class="n">mtrx_obs_arr</span><span class="p">,</span>
            <span class="n">age_sup</span><span class="p">,</span>
            <span class="n">se_mult</span><span class="p">,</span>
            <span class="n">start_year</span><span class="p">,</span>
            <span class="s2">&quot;MTRx&quot;</span><span class="p">,</span>
            <span class="n">graph</span><span class="o">=</span><span class="n">graph_est</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">mtrx_sse_big</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">mtrxparam_list_adj</span> <span class="o">=</span> <span class="n">replace_outliers</span><span class="p">(</span><span class="n">mtrxparam_list</span><span class="p">,</span> <span class="n">mtrx_sse_big</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mtrx_sse_big</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">mtrxparam_list_adj</span> <span class="o">=</span> <span class="n">mtrxparam_list</span>

        <span class="n">mtry_sse_big</span> <span class="o">=</span> <span class="n">find_outliers</span><span class="p">(</span>
            <span class="n">mtry_wsumsq_arr</span> <span class="o">/</span> <span class="n">mtry_obs_arr</span><span class="p">,</span>
            <span class="n">age_sup</span><span class="p">,</span>
            <span class="n">se_mult</span><span class="p">,</span>
            <span class="n">start_year</span><span class="p">,</span>
            <span class="s2">&quot;MTRy&quot;</span><span class="p">,</span>
            <span class="n">graph</span><span class="o">=</span><span class="n">graph_est</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">mtry_sse_big</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">mtryparam_list_adj</span> <span class="o">=</span> <span class="n">replace_outliers</span><span class="p">(</span><span class="n">mtryparam_list</span><span class="p">,</span> <span class="n">mtry_sse_big</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mtry_sse_big</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">mtryparam_list_adj</span> <span class="o">=</span> <span class="n">mtryparam_list</span>

    <span class="c1"># &#39;&#39;&#39;</span>
    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Generate tax function parameters for S &lt; s_max - s_min + 1</span>
    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># etrparam_list_S (list BW x S x numparams): this is an array in which S is</span>
    <span class="c1">#     less-than-or-equal-to s_max-s_min+1. We use weighted averages of</span>
    <span class="c1">#     parameters in relevant age groups</span>
    <span class="c1"># mtrxparam_list_S (list BW x S x numparams): this is an array in which S</span>
    <span class="c1">#     is less-than-or-equal-to s_max-s_min+1. We use weighted averages of</span>
    <span class="c1">#     parameters in relevant age groups</span>
    <span class="c1"># age_cuts     = (S+1,) vector, linspace of age cutoffs of S+1 points</span>
    <span class="c1">#                between 0 and S+1</span>
    <span class="c1"># yrcut_lb     = integer &gt;= 0, index of lower bound age for S bin</span>
    <span class="c1"># yrcut_ub     = integer &gt;= 0, index of upper bound age for S bin</span>
    <span class="c1"># rmndr_pct_lb = scalar in [0,1], discounted weight on lower bound age</span>
    <span class="c1"># rmndr_pct_ub = scalar in [0,1], discounted weight on upper bound age</span>
    <span class="c1"># age_wgts     = ages x BW x 10 array, age weights for each age in</span>
    <span class="c1">#                each year copied back 10 times in the 3rd dimension</span>
    <span class="c1"># --------------------------------------------------------------------</span>
    <span class="c1"># &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">age_specific</span> <span class="ow">and</span> <span class="n">tax_func_type</span> <span class="o">!=</span> <span class="s2">&quot;mono&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">S</span> <span class="o">==</span> <span class="n">s_max</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">etrparam_list_S</span> <span class="o">=</span> <span class="n">etrparam_list_adj</span>
            <span class="n">mtrxparam_list_S</span> <span class="o">=</span> <span class="n">mtrxparam_list_adj</span>
            <span class="n">mtryparam_list_S</span> <span class="o">=</span> <span class="n">mtryparam_list_adj</span>
        <span class="k">elif</span> <span class="n">S</span> <span class="o">&lt;</span> <span class="n">s_max</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">etrparam_list_S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">BW</span><span class="p">,</span> <span class="n">S</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">mtrxparam_list_S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">BW</span><span class="p">,</span> <span class="n">S</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">mtryparam_list_S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">BW</span><span class="p">,</span> <span class="n">S</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">age_cuts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">s_max</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">S</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">yrcut_lb</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">age_cuts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">rmndr_pct_lb</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="k">for</span> <span class="n">bw</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">BW</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">S</span><span class="p">):</span>
                    <span class="n">yrcut_ub</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">age_cuts</span><span class="p">[</span><span class="n">s</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
                    <span class="n">rmndr_pct_ub</span> <span class="o">=</span> <span class="n">age_cuts</span><span class="p">[</span><span class="n">s</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">age_cuts</span><span class="p">[</span><span class="n">s</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">rmndr_pct_ub</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                        <span class="n">rmndr_pct_ub</span> <span class="o">=</span> <span class="mf">1.0</span>
                        <span class="n">yrcut_ub</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="n">age_wgts</span> <span class="o">=</span> <span class="n">PopPct_age</span><span class="p">[</span><span class="n">bw</span><span class="p">,</span> <span class="n">yrcut_lb</span> <span class="p">:</span> <span class="n">yrcut_ub</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="n">age_wgts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="n">rmndr_pct_lb</span>
                    <span class="n">age_wgts</span><span class="p">[</span><span class="n">yrcut_ub</span> <span class="o">-</span> <span class="n">yrcut_lb</span><span class="p">]</span> <span class="o">*=</span> <span class="n">rmndr_pct_ub</span>
                    <span class="n">etrparam_list_S</span><span class="p">[</span><span class="n">bw</span><span class="p">][</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">etrparam_list_adj</span><span class="p">[</span><span class="n">bw</span><span class="p">][</span><span class="n">yrcut_lb</span> <span class="p">:</span> <span class="n">yrcut_ub</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                        <span class="o">*</span> <span class="n">age_wgts</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                    <span class="n">mtrxparam_list_S</span><span class="p">[</span><span class="n">bw</span><span class="p">][</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">mtrxparam_list_adj</span><span class="p">[</span><span class="n">bw</span><span class="p">][</span><span class="n">yrcut_lb</span> <span class="p">:</span> <span class="n">yrcut_ub</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                        <span class="o">*</span> <span class="n">age_wgts</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                    <span class="n">mtryparam_list_S</span><span class="p">[</span><span class="n">bw</span><span class="p">][</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">mtryparam_list_adj</span><span class="p">[</span><span class="n">bw</span><span class="p">][</span><span class="n">yrcut_lb</span> <span class="p">:</span> <span class="n">yrcut_ub</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                        <span class="o">*</span> <span class="n">age_wgts</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                    <span class="n">yrcut_lb</span> <span class="o">=</span> <span class="n">yrcut_ub</span>
                    <span class="n">rmndr_pct_lb</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">rmndr_pct_ub</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">err_msg</span><span class="p">(</span>
                <span class="s2">&quot;txfunc ERROR: S is larger than the difference between &quot;</span>
                <span class="o">+</span> <span class="s2">&quot;the minimum age and the maximum age specified. Please &quot;</span>
                <span class="o">+</span> <span class="s2">&quot;choose an S such that a model period equals at least &quot;</span>
                <span class="o">+</span> <span class="s2">&quot;one calendar year.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Big S: &quot;</span><span class="p">,</span> <span class="n">S</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;max age, min age: &quot;</span><span class="p">,</span> <span class="n">s_max</span><span class="p">,</span> <span class="n">s_min</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">age_specific</span> <span class="ow">and</span> <span class="n">tax_func_type</span> <span class="o">==</span> <span class="s2">&quot;mono&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">S</span> <span class="o">==</span> <span class="n">s_max</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">etrparam_list_S</span> <span class="o">=</span> <span class="n">etrparam_list_adj</span>
            <span class="n">mtrxparam_list_S</span> <span class="o">=</span> <span class="n">mtrxparam_list_adj</span>
            <span class="n">mtryparam_list_S</span> <span class="o">=</span> <span class="n">mtryparam_list_adj</span>
        <span class="k">elif</span> <span class="n">S</span> <span class="o">&lt;</span> <span class="n">s_max</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;txfunc ERROR: tax_func_type = mono and S &lt; s_max - &quot;</span>
                <span class="o">+</span> <span class="s2">&quot;s_min + 1&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">err_msg</span><span class="p">(</span>
                <span class="s2">&quot;txfunc ERROR: S is larger than the difference between &quot;</span>
                <span class="o">+</span> <span class="s2">&quot;the minimum age and the maximum age specified. Please &quot;</span>
                <span class="o">+</span> <span class="s2">&quot;choose an S such that a model period equals at least &quot;</span>
                <span class="o">+</span> <span class="s2">&quot;one calendar year.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Big S: &quot;</span><span class="p">,</span> <span class="n">S</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;max age, min age: &quot;</span><span class="p">,</span> <span class="n">s_max</span><span class="p">,</span> <span class="n">s_min</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">age_specific</span><span class="p">:</span>
        <span class="n">etrparam_list_S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">BW</span><span class="p">,</span> <span class="n">S</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">mtrxparam_list_S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">BW</span><span class="p">,</span> <span class="n">S</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">mtryparam_list_S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">BW</span><span class="p">,</span> <span class="n">S</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">bw</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">BW</span><span class="p">):</span>
            <span class="n">etrparam_list_S</span><span class="p">[</span><span class="n">bw</span><span class="p">][:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">etrparam_list</span><span class="p">[</span><span class="n">bw</span><span class="p">][</span><span class="mi">0</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">]]</span> <span class="o">*</span> <span class="n">S</span>
            <span class="n">mtrxparam_list_S</span><span class="p">[</span><span class="n">bw</span><span class="p">][:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">mtrxparam_list</span><span class="p">[</span><span class="n">bw</span><span class="p">][</span><span class="mi">0</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">]]</span> <span class="o">*</span> <span class="n">S</span>
            <span class="n">mtryparam_list_S</span><span class="p">[</span><span class="n">bw</span><span class="p">][:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">mtryparam_list</span><span class="p">[</span><span class="n">bw</span><span class="p">][</span><span class="mi">0</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">]]</span> <span class="o">*</span> <span class="n">S</span>

    <span class="c1"># Save tax function parameters array and computation time in</span>
    <span class="c1"># dictionary</span>
    <span class="n">dict_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;tfunc_etr_params_S&quot;</span><span class="p">,</span> <span class="n">etrparam_list_S</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;tfunc_mtrx_params_S&quot;</span><span class="p">,</span> <span class="n">mtrxparam_list_S</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;tfunc_mtry_params_S&quot;</span><span class="p">,</span> <span class="n">mtryparam_list_S</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;tfunc_avginc&quot;</span><span class="p">,</span> <span class="n">AvgInc</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;tfunc_avg_etr&quot;</span><span class="p">,</span> <span class="n">AvgETR</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;tfunc_avg_mtrx&quot;</span><span class="p">,</span> <span class="n">AvgMTRx</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;tfunc_avg_mtry&quot;</span><span class="p">,</span> <span class="n">AvgMTRy</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;tfunc_frac_tax_payroll&quot;</span><span class="p">,</span> <span class="n">frac_tax_payroll</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;tfunc_etr_sumsq&quot;</span><span class="p">,</span> <span class="n">etr_wsumsq_arr</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;tfunc_mtrx_sumsq&quot;</span><span class="p">,</span> <span class="n">mtrx_wsumsq_arr</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;tfunc_mtry_sumsq&quot;</span><span class="p">,</span> <span class="n">mtry_wsumsq_arr</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;tfunc_etr_obs&quot;</span><span class="p">,</span> <span class="n">etr_obs_arr</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;tfunc_mtrx_obs&quot;</span><span class="p">,</span> <span class="n">mtrx_obs_arr</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;tfunc_mtry_obs&quot;</span><span class="p">,</span> <span class="n">mtry_obs_arr</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;tfunc_time&quot;</span><span class="p">,</span> <span class="n">elapsed_time</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;tax_func_type&quot;</span><span class="p">,</span> <span class="n">tax_func_type</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;start_year&quot;</span><span class="p">,</span> <span class="n">start_year</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;BW&quot;</span><span class="p">,</span> <span class="n">BW</span><span class="p">),</span>
        <span class="p">]</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">tax_func_path</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tax_func_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">dict_params</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">cloudpickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">dict_params</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dict_params</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">avg_by_bin_multd</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        x (numpy array): 2d with dimensions n by m used for binning</span>
<span class="sd">        y (numpy array): 1d with length n</span>
<span class="sd">        bins (numpy array): 1d with length m, each entry must divide n</span>
<span class="sd">            and is number of bins for corresponding column in x</span>
<span class="sd">        weights (None or numpy array): 1d with length n specifying</span>
<span class="sd">            weight of each observation. if None then array of ones</span>

<span class="sd">    Returns:</span>
<span class="sd">        xNew (numpy array): 2d with second dimension m, first</span>
<span class="sd">            dimension is product of elements in bins, with each entry</span>
<span class="sd">            representative of bin across all the features</span>
<span class="sd">        yNew (numpy array): 1d with length same as first dimension</span>
<span class="sd">            of xWeight, weighted average of y&#39;s corresponding to each</span>
<span class="sd">            entry of xWeight</span>
<span class="sd">        weightsNew (numpy array): 1d with length same as yNew, weight</span>
<span class="sd">            corresponding to each xNew, yNew row</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">):</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Dimensions of x and bins don&#39;t match: </span><span class="si">{}</span><span class="s2"> != </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span>
        <span class="n">tupleBins</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span>
        <span class="n">xNew</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">size</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">yNew</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">weightsNew</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="c1"># iterate through each of the final bins, which consists of bins for each feature</span>
        <span class="c1"># for each, only retain entries falling in that bin</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
            <span class="n">index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">tupleBins</span><span class="p">))</span>
            <span class="n">valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
                <span class="n">valid</span> <span class="o">&amp;=</span> <span class="p">(</span>
                    <span class="n">x</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="n">j</span><span class="p">],</span> <span class="n">v</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">bins</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="n">j</span><span class="p">],</span> <span class="p">(</span><span class="n">v</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">bins</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">valid</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">xNew</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">[</span><span class="n">valid</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">yNew</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">valid</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">[</span><span class="n">valid</span><span class="p">])</span>
                <span class="n">weightsNew</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="n">valid</span><span class="p">])</span>
        <span class="n">xNew</span> <span class="o">=</span> <span class="n">xNew</span><span class="p">[</span><span class="o">~</span><span class="p">(</span><span class="n">weightsNew</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span>
        <span class="n">yNew</span> <span class="o">=</span> <span class="n">yNew</span><span class="p">[</span><span class="o">~</span><span class="p">(</span><span class="n">weightsNew</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span>
        <span class="n">weightsNew</span> <span class="o">=</span> <span class="n">weightsNew</span><span class="p">[</span><span class="o">~</span><span class="p">(</span><span class="n">weightsNew</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">xNew</span><span class="p">,</span> <span class="n">yNew</span><span class="p">,</span> <span class="n">weightsNew</span>


<div class="viewcode-block" id="monotone_spline">
<a class="viewcode-back" href="../../content/api/txfunc.html#ogcore.txfunc.monotone_spline">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">monotone_spline</span><span class="p">(</span>
    <span class="n">x</span><span class="p">,</span>
    <span class="n">y</span><span class="p">,</span>
    <span class="n">weights</span><span class="p">,</span>
    <span class="n">bins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">lam</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
    <span class="n">kap</span><span class="o">=</span><span class="mf">1e7</span><span class="p">,</span>
    <span class="n">incl_uncstr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">show_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">method</span><span class="o">=</span><span class="s2">&quot;eilers&quot;</span><span class="p">,</span>
    <span class="n">splines</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">plot_start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">plot_end</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        method (string): &#39;eilers&#39; or &#39;pygam&#39;</span>
<span class="sd">        splines (None or array-like): for &#39;pygam&#39; only (otherwise set None),</span>
<span class="sd">            number of splines used for each feature, if None use default</span>
<span class="sd">        plot_start/plot_end (number between 0, 100): for &#39;pygam&#39; only if show_plot = True,</span>
<span class="sd">            start and end for percentile of data used in plot, can result in</span>
<span class="sd">            better visualizations if original data has strong outliers</span>


<span class="sd">    Returns:</span>
<span class="sd">        xNew (numpy array): 2d with second dimension m, first</span>
<span class="sd">            dimension is product of elements in bins, with each entry</span>
<span class="sd">            representative of bin across all the features</span>
<span class="sd">        yNew (numpy array): 1d with length same as first dimension</span>
<span class="sd">            of xWeight, weighted average of y&#39;s corresponding to each</span>
<span class="sd">            entry of xWeight</span>
<span class="sd">        weightsNew (numpy array): 1d with length same as yNew, weight</span>
<span class="sd">            corresponding to each xNew, yNew row</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;pygam&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">splines</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">splines</span><span class="p">)</span> <span class="o">!=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot; pygam method requires splines to be None or &quot;</span>
                <span class="o">+</span> <span class="s2">&quot; same length as # of columns in x, &quot;</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">splines</span><span class="p">))</span>
                <span class="o">+</span> <span class="s2">&quot; != &quot;</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>

        <span class="c1"># bin data</span>
        <span class="k">if</span> <span class="n">bins</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x_binned</span><span class="p">,</span> <span class="n">y_binned</span><span class="p">,</span> <span class="n">weights_binned</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">weights</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x_binned</span><span class="p">,</span> <span class="n">y_binned</span><span class="p">,</span> <span class="n">weights_binned</span> <span class="o">=</span> <span class="n">avg_by_bin_multd</span><span class="p">(</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">weights</span>
            <span class="p">)</span>

        <span class="c1"># setup pygam parameters- in addition to &#39;s&#39; spline terms, can also have &#39;t&#39; tensor</span>
        <span class="c1"># terms which are interactions between two variables. &#39;t&#39; terms also need monotonic constraints</span>
        <span class="c1"># to satisfy previous constraints, they actually impose stronger restriction</span>

        <span class="k">if</span> <span class="n">splines</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tempCstr</span> <span class="o">=</span> <span class="n">s</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="s2">&quot;monotonic_inc&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">x_binned</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">tempCstr</span> <span class="o">+=</span> <span class="n">s</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="s2">&quot;monotonic_inc&quot;</span><span class="p">)</span>
            <span class="n">tempUncstr</span> <span class="o">=</span> <span class="n">s</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">x_binned</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">tempUncstr</span> <span class="o">+=</span> <span class="n">s</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tempCstr</span> <span class="o">=</span> <span class="n">s</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="s2">&quot;monotonic_inc&quot;</span><span class="p">,</span> <span class="n">n_splines</span><span class="o">=</span><span class="n">splines</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">x_binned</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">tempCstr</span> <span class="o">+=</span> <span class="n">s</span><span class="p">(</span>
                    <span class="n">i</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="s2">&quot;monotonic_inc&quot;</span><span class="p">,</span> <span class="n">n_splines</span><span class="o">=</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="n">tempUncstr</span> <span class="o">=</span> <span class="n">s</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_splines</span><span class="o">=</span><span class="n">splines</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">x_binned</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">tempUncstr</span> <span class="o">+=</span> <span class="n">s</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">n_splines</span><span class="o">=</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="c1"># fit data</span>
        <span class="n">gamCstr</span> <span class="o">=</span> <span class="n">LinearGAM</span><span class="p">(</span><span class="n">tempCstr</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_binned</span><span class="p">,</span> <span class="n">y_binned</span><span class="p">,</span> <span class="n">weights_binned</span><span class="p">)</span>
        <span class="n">y_cstr</span> <span class="o">=</span> <span class="n">gamCstr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_binned</span><span class="p">)</span>
        <span class="n">wsse_cstr</span> <span class="o">=</span> <span class="p">(</span><span class="n">weights_binned</span> <span class="o">*</span> <span class="p">((</span><span class="n">y_cstr</span> <span class="o">-</span> <span class="n">y_binned</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">incl_uncstr</span><span class="p">:</span>
            <span class="n">gamUncstr</span> <span class="o">=</span> <span class="n">LinearGAM</span><span class="p">(</span><span class="n">tempUncstr</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
                <span class="n">x_binned</span><span class="p">,</span> <span class="n">y_binned</span><span class="p">,</span> <span class="n">weights_binned</span>
            <span class="p">)</span>
            <span class="n">y_uncstr</span> <span class="o">=</span> <span class="n">gamUncstr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_binned</span><span class="p">)</span>
            <span class="n">wsse_uncstr</span> <span class="o">=</span> <span class="p">(</span><span class="n">weights_binned</span> <span class="o">*</span> <span class="p">((</span><span class="n">y_uncstr</span> <span class="o">-</span> <span class="n">y_binned</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y_uncstr</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">wsse_uncstr</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">show_plot</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;projection&quot;</span><span class="p">:</span> <span class="s2">&quot;3d&quot;</span><span class="p">})</span>
                <span class="c1"># select data in [plot_start, end] percentile across both features</span>
                <span class="c1"># this can be rewritten to generalize for n-dimensions, but didn&#39;t know how to plot that</span>
                <span class="n">xactPlot</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span>
                    <span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">plot_start</span><span class="p">))</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">plot_end</span><span class="p">))</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">plot_start</span><span class="p">))</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">plot_end</span><span class="p">))</span>
                <span class="p">]</span>
                <span class="n">yactPlot</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span>
                    <span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">plot_start</span><span class="p">))</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">plot_end</span><span class="p">))</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">plot_start</span><span class="p">))</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">plot_end</span><span class="p">))</span>
                <span class="p">]</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                    <span class="n">xactPlot</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
                    <span class="n">xactPlot</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
                    <span class="n">yactPlot</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
                    <span class="n">s</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">plot_start</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">plot_end</span><span class="p">),</span>
                    <span class="mi">1000</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">x1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">plot_start</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">plot_end</span><span class="p">),</span>
                    <span class="mi">1000</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">X0</span><span class="p">,</span> <span class="n">X1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">)</span>
                <span class="n">yPred</span> <span class="o">=</span> <span class="n">gamCstr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">X0</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">X1</span><span class="o">.</span><span class="n">flatten</span><span class="p">()])</span><span class="o">.</span><span class="n">T</span>
                <span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span>
                    <span class="n">X0</span><span class="p">,</span> <span class="n">X1</span><span class="p">,</span> <span class="n">yPred</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span>
                <span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;Monotonic GAM spline with all data&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">,</span>
                    <span class="n">y</span><span class="p">,</span>
                    <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;None&quot;</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span>
                    <span class="n">s</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;All data&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">,</span>
                    <span class="n">y_cstr</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Monotonic GAM spline&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">incl_uncstr</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                        <span class="n">x</span><span class="p">,</span>
                        <span class="n">y_uncstr</span><span class="p">,</span>
                        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span>
                        <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Unconstrained GAM spline&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">interp</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">gamCstr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">interp</span><span class="p">,</span> <span class="n">y_cstr</span><span class="p">,</span> <span class="n">wsse_cstr</span><span class="p">,</span> <span class="n">y_uncstr</span><span class="p">,</span> <span class="n">wsse_uncstr</span>

    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;eilers&quot;</span><span class="p">:</span>
        <span class="c1"># create binned and weighted x and y data</span>
        <span class="k">if</span> <span class="n">bins</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">bins</span><span class="p">):</span>
                <span class="n">err_msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;monotone_spline2 ERROR: bins value is not type scalar&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
            <span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span>
            <span class="n">x_binned</span><span class="p">,</span> <span class="n">y_binned</span><span class="p">,</span> <span class="n">weights_binned</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">avg_by_bin</span><span class="p">(</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">N</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="ow">not</span> <span class="n">bins</span><span class="p">:</span>
            <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">x_binned</span> <span class="o">=</span> <span class="n">x</span>
            <span class="n">y_binned</span> <span class="o">=</span> <span class="n">y</span>
            <span class="n">weights_binned</span> <span class="o">=</span> <span class="n">weights</span>

        <span class="c1"># Prepare bases (Imat) and penalty</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
        <span class="n">D3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">dd</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">D1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Monotone smoothing</span>
        <span class="n">ws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">weights_binned</span> <span class="o">=</span> <span class="n">weights_binned</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">weights_binned</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">weights1</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">weights_binned</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">weights_binned</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">weights3</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mf">0.25</span> <span class="o">*</span> <span class="n">weights_binned</span><span class="p">[</span><span class="mi">3</span><span class="p">:,</span> <span class="p">:]</span>
            <span class="o">+</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="n">weights_binned</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
            <span class="o">+</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="n">weights_binned</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span>
            <span class="o">+</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="n">weights_binned</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">30</span><span class="p">):</span>
            <span class="n">Ws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">ws</span> <span class="o">*</span> <span class="n">kap</span><span class="p">)</span>
            <span class="n">mon_cof</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span>
                <span class="n">E</span>
                <span class="o">+</span> <span class="n">lam</span> <span class="o">*</span> <span class="n">D3</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">weights3</span><span class="p">)</span> <span class="o">@</span> <span class="n">D3</span>
                <span class="o">+</span> <span class="n">D1</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="p">(</span><span class="n">Ws</span> <span class="o">*</span> <span class="n">weights1</span><span class="p">)</span> <span class="o">@</span> <span class="n">D1</span><span class="p">,</span>
                <span class="n">y_binned</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">ws_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">D1</span> <span class="o">@</span> <span class="n">mon_cof</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span>
            <span class="n">dw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ws</span> <span class="o">!=</span> <span class="n">ws_new</span><span class="p">)</span>
            <span class="n">ws</span> <span class="o">=</span> <span class="n">ws_new</span>
            <span class="k">if</span> <span class="n">dw</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="c1"># Monotonic and non monotonic fits</span>
        <span class="n">y_cstr</span> <span class="o">=</span> <span class="n">mon_cof</span>
        <span class="n">wsse_cstr</span> <span class="o">=</span> <span class="p">(</span><span class="n">weights_binned</span> <span class="o">*</span> <span class="p">((</span><span class="n">y_cstr</span> <span class="o">-</span> <span class="n">y_binned</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">incl_uncstr</span><span class="p">:</span>
            <span class="n">y_uncstr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span>
                <span class="n">E</span> <span class="o">+</span> <span class="n">lam</span> <span class="o">*</span> <span class="n">D3</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">weights3</span><span class="p">)</span> <span class="o">@</span> <span class="n">D3</span><span class="p">,</span> <span class="n">y_binned</span>
            <span class="p">)</span>
            <span class="n">wsse_uncstr</span> <span class="o">=</span> <span class="p">(</span><span class="n">weights_binned</span> <span class="o">*</span> <span class="p">((</span><span class="n">y_uncstr</span> <span class="o">-</span> <span class="n">y_binned</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y_uncstr</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">wsse_uncstr</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">mono_interp</span><span class="p">(</span><span class="n">x_vec</span><span class="p">):</span>
            <span class="c1"># replace last point in data with two copies further out to make smooth</span>
            <span class="c1"># extrapolation</span>
            <span class="n">x_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">x_binned</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.005</span> <span class="o">*</span> <span class="n">x_binned</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mf">1.01</span> <span class="o">*</span> <span class="n">x_binned</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
            <span class="p">)</span>
            <span class="n">y_cstr_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_cstr</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="n">y_cstr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">y_cstr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
            <span class="c1"># Create interpolating cubic spline for interior points</span>
            <span class="n">inter_interpl</span> <span class="o">=</span> <span class="n">intp</span><span class="p">(</span><span class="n">x_new</span><span class="p">,</span> <span class="n">y_cstr_new</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;cubic&quot;</span><span class="p">)</span>
            <span class="n">y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x_vec</span><span class="p">)</span>
            <span class="n">x_lt_min</span> <span class="o">=</span> <span class="n">x_vec</span> <span class="o">&lt;</span> <span class="n">x_binned</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">x_gt_max</span> <span class="o">=</span> <span class="n">x_vec</span> <span class="o">&gt;</span> <span class="n">x_new</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">x_inter</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_vec</span> <span class="o">&gt;=</span> <span class="n">x_binned</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x_vec</span> <span class="o">&lt;=</span> <span class="n">x_new</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
            <span class="n">y_pred</span><span class="p">[</span><span class="n">x_inter</span><span class="p">]</span> <span class="o">=</span> <span class="n">inter_interpl</span><span class="p">(</span><span class="n">x_vec</span><span class="p">[</span><span class="n">x_inter</span><span class="p">])</span>
            <span class="c1"># extrapolate the maximum for values above the maximum</span>
            <span class="n">y_pred</span><span class="p">[</span><span class="n">x_gt_max</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_cstr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># linear extrapolation of last two points for values below the min</span>
            <span class="n">slope</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_cstr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_cstr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">x_binned</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_binned</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">intercept</span> <span class="o">=</span> <span class="n">y_cstr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">x_binned</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">y_pred</span><span class="p">[</span><span class="n">x_lt_min</span><span class="p">]</span> <span class="o">=</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">x_vec</span><span class="p">[</span><span class="n">x_lt_min</span><span class="p">]</span> <span class="o">+</span> <span class="n">intercept</span>

            <span class="k">return</span> <span class="n">y_pred</span>

        <span class="k">if</span> <span class="n">show_plot</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                <span class="n">x</span><span class="p">,</span>
                <span class="n">y</span><span class="p">,</span>
                <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span>
                <span class="n">s</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;All data&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">bins</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">,</span>
                    <span class="n">y_cstr</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Monotonic smooth spline&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">incl_uncstr</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                        <span class="n">x</span><span class="p">,</span>
                        <span class="n">y_uncstr</span><span class="p">,</span>
                        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span>
                        <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Unconstrained smooth spline&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                    <span class="n">x_binned</span><span class="p">,</span>
                    <span class="n">y_binned</span><span class="p">,</span>
                    <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;None&quot;</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
                    <span class="n">s</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Binned data averages&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">,</span>
                    <span class="n">mono_interp</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
                    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Monotonic smooth spline&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">incl_uncstr</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                        <span class="n">x_binned</span><span class="p">,</span>
                        <span class="n">y_uncstr</span><span class="p">,</span>
                        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span>
                        <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Unconstrained smooth spline&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower right&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">mono_interp</span><span class="p">,</span> <span class="n">y_cstr</span><span class="p">,</span> <span class="n">wsse_cstr</span><span class="p">,</span> <span class="n">y_uncstr</span><span class="p">,</span> <span class="n">wsse_uncstr</span>

    <span class="n">err_msg</span> <span class="o">=</span> <span class="n">method</span> <span class="o">+</span> <span class="s2">&quot; method not supported, must be &#39;eilers&#39; or &#39;pygam&#39;&quot;</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span></div>

</pre></div>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Jason DeBacker and Richard W. Evans
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>