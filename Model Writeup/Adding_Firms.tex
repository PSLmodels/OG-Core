\documentclass[letterpaper,12pt]{article}

\usepackage{threeparttable}
\usepackage{geometry}
\geometry{letterpaper,tmargin=1in,bmargin=1in,lmargin=1.25in,rmargin=1.25in}
\usepackage[format=hang,font=normalsize,labelfont=bf]{caption}
\usepackage{amsmath}
\usepackage{multirow}
\usepackage{array}
\usepackage{delarray}
\usepackage{amssymb}
\usepackage{amsthm}
\usepackage{lscape}
\usepackage{natbib}
\usepackage{setspace}
\usepackage{float,color}
\usepackage[pdftex]{graphicx}
\usepackage{pdfsync}
\usepackage{verbatim}
\usepackage{placeins}
\usepackage{geometry}
\usepackage{pdflscape}
\synctex=1
\usepackage{hyperref}
\hypersetup{colorlinks,linkcolor=red,urlcolor=blue,citecolor=red}
\usepackage{bm}


\theoremstyle{definition}
\newtheorem{theorem}{Theorem}
\newtheorem{acknowledgement}[theorem]{Acknowledgement}
\newtheorem{algorithm}[theorem]{Algorithm}
\newtheorem{axiom}[theorem]{Axiom}
\newtheorem{case}[theorem]{Case}
\newtheorem{claim}[theorem]{Claim}
\newtheorem{conclusion}[theorem]{Conclusion}
\newtheorem{condition}[theorem]{Condition}
\newtheorem{conjecture}[theorem]{Conjecture}
\newtheorem{corollary}[theorem]{Corollary}
\newtheorem{criterion}[theorem]{Criterion}
\newtheorem{definition}{Definition} % Number definitions on their own
\newtheorem{derivation}{Derivation} % Number derivations on their own
\newtheorem{example}[theorem]{Example}
\newtheorem{exercise}[theorem]{Exercise}
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{notation}[theorem]{Notation}
\newtheorem{problem}[theorem]{Problem}
\newtheorem{proposition}{Proposition} % Number propositions on their own
\newtheorem{remark}[theorem]{Remark}
\newtheorem{solution}[theorem]{Solution}
\newtheorem{summary}[theorem]{Summary}
\bibliographystyle{aer}
\newcommand\ve{\epsilon}
%\renewcommand\theenumi{\roman{enumi}}
\newcommand\norm[1]{\left\lVert#1\right\rVert}

\begin{document}

\title{Adding Multiple Goods/Production Sectors to the OLG Model}
\date{\today}
\author{}
\maketitle

\begin{spacing}{1.5}
\pagenumbering{arabic}


\section*{The Big Picture}

What we are working towards is having two representative firms (one who faces corporate tax treatment and the other with non-corporate tax treatment) for each of $M$ production industries.  Each firm will produce an unique output that is part of the household's consumption bundle.  There will exist a firm in each sector (corporate/noncorporate) and each industry in equilibrium because households will have preferences such that they want to consume a strictly positive amount of the good from each sector and industry.  The equilibrium shares of the households' composite good will vary as the prices of those goods vary.  The prices of these goods varies as factor prices and taxes change, which impact production sectors/industries differentially.

What are are doing is unique in that we have many production industries \emph{and} have forward looking, truly dynamically optimizing firms.  \href{https://github.com/OpenSourcePolicyCenter/dynamic/blob/master/Papers/ZodrowDiamond2013.pdf}{Zodrow and Diamond (2013)} have dynamic firms, but only four representative firms.  \href{https://github.com/OpenSourcePolicyCenter/dynamic/blob/master/Papers/FullertonRogers1993.pdf}{Fullerton and Rogers (1993)} have many production industries, but static firms.  \href{https://github.com/OpenSourcePolicyCenter/dynamic/blob/master/Papers/memo161.pdf}{The CORTAX model} has dynamic firms with a medium number of representative firms (2-3 per country in a model of maybe 9 countries).  These papers/models represent our main sources of inspiration and are the starting point for the model we are trying to build.

I think the key to making this model feasible is a structure like in Fullerton and Rogers (1993), where factor prices can be used to determine all other prices in the model.  In particular, given $r$ and $w$, their model allows one to derive the price of capital, the price of producer outputs, the price of individual consumption goods, and the price of the composite consumption good.  With all these prices, they then start with the consumers problem and figure out labor supply and demand for each consumption good.  The demand for consumption goods can then be put in terms of demand for producer goods.  The demand for producer goods (output) then implies the amount of capital and labor the firm will employ.  This means all the endogenous prices and quantities in the household and production sectors fall out of the factor prices $r$ and $w$.  Other methods would involve guessing a lot more prices than just $r$ and $w$ (e.g., guessing prices for each of the $Mx2$ production outputs).

We want to structure our model in the way Fullerton and Rogers (1993) do in terms of how all the within period endogenous variables unravel, but will have the firm as a dynamic optimizer (as in Zodrow and Diamond (2013) and CORTAX).  We'll also want to have firms with economic profits so that 1) they have profits to shift to other tax jurisdictions and 2) we can analyze the impact of taxes on normal and supranormal returns.  Of the above papers, only the CORTAX model has economic profits.  

\section*{Starting point}

This document assumes that you have written code that computes the steady-state equilibrium and transition path for an OLG model with households who live for $S$ periods and can be one of $J$ types (where the difference between types is in the amount of effective labor units they can provide).  Households choose labor supply, savings, and consumption.  Bequests are left when a household dies and they get a warm glow utility effect from this (at least for intentional bequests).  I'll be assuming the disutility of labor function is a CRRA function, but one can easily adapt this to the case of an elliptical utility function.  A single, representative firm rents capital and labor to produce output with a constant returns to scale, Cobb Douglas production function.  The codes solves for the model's steady state using a root finder (probably Scipy's \texttt{fsolve}) to simultaneously solve $S\times J \times 2$ equations (household FOCs) for the $S\times J \times 2$ unknowns ($n_{j,s}, b_{j,s}$ - these then determine $c_{j,s}$).  This solution results in Euler errors that are very small (e.g. 1e-10) and satisfies the aggregate resource constraint: $Y=C+I$ (where $I=\delta K$ in the SS).  These conditions are satisfied in both the SS and along the transition path.

\section*{Step 1: Modifying the SS solution algorithm}

The first step is to take the code for solving for the steady state and adjust it just slightly so that it is setup to add the additional pieces in the next sections.  The ``one big fsolve" method used in your code is not robust to different initial values and becomes difficult to work with when multiple firms are added.  What we'll do instead is make a guess at the factor prices, $r$ and $w$.  The SS algorithm will look like:

\begin{enumerate}
\item Make an initial guess at $\bar{r}$ and $\bar{w}$
\item Taking $\bar{r}$ and $\bar{w}$ as given, solve the household's problem:
	\begin{itemize}
	\item For each $j$ type:
		\begin{enumerate}
		\item Make an initial guess at the household's optimal savings and labor supply decisions, $b_{j,s}$, $n_{j,s}$.
		\item Use a root finder (e.g. \texttt{fsolve}) to determine the optimal allocations given $\bar{r}$ and $\bar{w}$.
		\end{enumerate}
	\end{itemize}
\item Aggregate over $J$ and $S$ to determine aggregate supply of labor and capital (where savings=capital), $K$, $L$
	\begin{itemize}
	\item Remember to find $L$ as the aggregate amount of effective labor units supplied, so you not only want to sum over $J$ and $S$, but weight by the number of effective labor units each type/age supplies.
	\end{itemize}
\item Use the fact that supply=demand in eq'm and plug the aggregate factor supplies into the firm's problem
\item Using the Firm's FOC for capital demand, find the interest rate implied by these factor supplies.  Call this interest rate $r_{new}$.  $r_{new}=MPK(K,L)-\delta$.
\item Using the Firm's FOC for labor demand, find the wage rate implied by these factor supplies.  Call this interest rate $w_{new}$.  $w_{new}=MPL(K,L)$.
\item Take differences between the guess at $\bar{r}$ and $\bar{w}$.  
\item Use a root finder to determine the eq'm $\bar{r}$ and $\bar{w}$ (i.e. it'll find the $\bar{r}$ and $\bar{w}$ where $r_{new}-\bar{r}=0$ and $w_{new}-\bar{w}=0$).
\end{enumerate}

So in this algorithm, there is an outer \texttt{fsolve}, solving for $r$ and $w$.  Within that, there is a loop over the $J$ types and an \texttt{fsolve} at each iteration of that loop (each solving $S\times 2$ equations).

You'll want to be sure to have separate functions for the inner and outer loops.  E.g. a \texttt{SS\_solve} function that takes the parameters and initial guesses of $r$ and $w$ as inputs and a \texttt{hh\_solve} that takes relevant parameters and the $b_{j,s}, n_{j,s}$ as inputs.  The \texttt{hh\_solve} function will be within the for loop within the \texttt{SS\_solve} function.  Make sure that all the functions called with in the \texttt{hh\_solve} function are compatible with the dimensions of the inputs (which will only be $S\times 1$ as opposed to $S\times J$ from the previous method.

Note one trick that I've found really helps with the solution is to adjust your initial guesses for the household problem ($b_{j,s}, n_{j,s}$) for each type $j$.  In particular, assuming that ability changes monotonically along the $J$ dimension, then use the solution to the household problem from $j-1$ as the initial guess to solve the problem for the household of type $j$.

To check that this all works as expected, makes sure:
\begin{enumerate}
\item Euler errors are very small
\item The aggregate resource constraint is satisfied ($Y=C+\delta K$ in the SS).
\item You get the same equilibrium from this algorithm as with the previous ``one big fsolve" method (i.e., $b_{j,s}, n_{j,s}, \bar{r}, \bar{w}$ are the same as before).
\end{enumerate}

One can do this same method along the time path.  But I'm thinking that we build up only the SS solution for now, then do the time path once we've got more of the multiple firm problem fleshed out and working in the the SS solution.


%Currently, the steady state is found by iterating on guesses or $r$ and $w$ (and $T^{H}$ and $f$ - but lets ignore these for the exposition here since they aren't relevant here and will stay unchanged as we add firms).  For each guess, the household problem is solved and the aggregate supply of labor and capital are found.  The market clearing conditions are then used to put these amounts supplied into the FOCs from the firm's problem.  Given $K$ and $L$ these FOCs then imply and $r$ and $w$.  These implied prices are then compared against the initial guess. If they match, we've found and equilibrium and if not, we update the guess.
%
%The adjustment will do the following.  The solution will guess $r$ and $w$ and solve the household's problem for $B$, $L$, and $C$.  We'll then use the resource constraint: $C+I=Y$, to find $Y$.  With $Y$ (and $r$ and $w$), we are then able to determine the steady state demand for capital, $K$, and labor $L$.  We then check the market clearing conditions for the capital and labor markets.  We'll iterate on our guesses of $r$ and $w$ until these clear.
%
%Equations to add/edit to the code:
%\begin{enumerate}
%\item Firm function: $I = \delta K$
%\item Miscellaneous Function: $C + I = Y$
%\item Firm function: $K = \frac{\alpha Y}{r+\delta}$ (writing FOC w.r.t. capital in terms of the amount of capital demanded for a given amount of output)
%\item Firm function: add $\delta$ to the FOC for the firm - i.e., $r+\delta = MPK$ since they'll own capital, the rental rate won't include the cost of depreciation.
%\end{enumerate}
%
%To do: edit the code such that after the household problem is solved, the aggregate amount of consumption is found.  Next, use (1) and (3) above to find investment demand: $I=\delta K = \delta \frac{\alpha Y}{r+\delta}$.  Then use (2),  $C+ I = Y$,  to find total demand for output, $Y$.  Plug this $Y$ into the firm FOCs and find capital and labor demand.  Check them agains the supply of capital and labor from the households ($B$ and $L$).  These errors will replace the $r$ and $w$ errors currently in the code.


\section*{Step 2: Make the production function a more general CES production function}

The initial set up, firms have a Cobb-Douglas production function. To allow for the model user to more easily change the elasticity of substitution between capital and labor. Let's write the production function as a more general CES production function.  In particular, let the production function be given by:

\begin{equation}
X_{t}  = F(A_{t},K_{t},EL_{t})= A_{t} \left[(\gamma_{})^{1/\epsilon_{}}(K_{t})^{(\epsilon-1)/\epsilon_{}}+(1-\gamma_{})^{1/\epsilon_{}}EL_{t}^{(\epsilon_{}-1)/\epsilon_{}}\right]^{(\epsilon_{}/(\epsilon_{}-1))},
\end{equation}

\noindent\noindent where $A_{t}$ is total factor productivity, $EL$ is effective labor units (same as our $L$ in the current write up of the firm problem - we'll change the notation so that we can keep track of both $L$, total hours worked, and $EL$ total effective labor units worked) and the parameters $\gamma$ and $\epsilon$ are the share share parameter and the elasticity of substitution parameters.  Note the labor augmenting technological growth. Also note that we've update the notation so that $X_{t}$ denotes the output of the firm in period $t$.  As we expand the model, $Y$ will represent aggregate household income and $X$ will represent firm output.

The marginal products of capital and labor are thus given by:

\begin{equation}
\label{eqn:mpk}
\begin{split}
MPK_{t}=\frac{\partial X_{t}}{\partial K_{t}}&= A_{t}\left(\gamma^{\frac{1}{\epsilon}}K_{t}^{\frac{\epsilon-1}{\epsilon}} + (1-\gamma)^{\frac{1}{\epsilon}}EL_{t}^{\frac{\epsilon-1}{\epsilon}}\right)^{\frac{1}{\epsilon-1}}\gamma^{\frac{1}{\epsilon}}K_{t}^{\frac{-1}{\epsilon}}\\
& = A_{t}^{\frac{\epsilon-1}{\epsilon}}\left(X_{t}\frac{\gamma}{K_{t}}\right)^{\frac{1}{\epsilon}}
\end{split}
\end{equation}

\begin{equation}
\label{eqn:mpl}
\begin{split}
MPL_{t}=\frac{\partial X_{t}}{\partial EL_{t}}&=A_{t}\left(\gamma^{\frac{1}{\epsilon}}K^{\frac{\epsilon-1}{\epsilon}} + (1-\gamma)^{\frac{1}{\epsilon}}EL_{t}^{\frac{\epsilon-1}{\epsilon}}\right)^{\frac{1}{\epsilon-1}}(1-\gamma)^{\frac{1}{\epsilon}}EL_{t}^{\frac{-1}{\epsilon}}e^{g_{y}t}\\
& = A_{t}^{\frac{\epsilon-1}{\epsilon}}\left(X_{t}\frac{1-\gamma}{EL_{t}}\right)^{\frac{1}{\epsilon}}
\end{split}
\end{equation}

We thus need to go into the code and edit the equations for the MPK and MPL to use those above.  These equations should be in just two functions in the code - one that determines the equilibrium wage rate and one that determines the equilibrium interest rate.  You will also need to update the production function in the function that determines firm output.  In addition, you'll need to change the notation for output from $Y$ to $X$ and for aggregate effective labor from $L$ to $EL$.

%This includes the equation that puts the capital stock in terms of output added in Step 1.  This equation should now be: 
%
%\begin{equation}
%\label{eqn:cap_demand}
%K_{t} = \frac{\gamma X_{t}}{\left(r_{t}+\delta\right)^{\epsilon}Z_{t}^{1-\epsilon}}
%\end{equation}


Note that when $\epsilon = 1$, the function becomes the Cobb-Douglas Production Function.  We should probably put an ``if" statement in the code such that if $\epsilon =1$ then the production function is $X_{t}  = F(A_{t},K_{t},EL_{t})= A_{t}K_{t}^{\gamma}EL_{t}^{(1-\gamma)}$.  Marginal products don't have to change, but when $\epsilon=1$, the production function is not defined.

Go ahead and set $\gamma=0.36$ and $\epsilon=0.6$ and solve the model.  Check that:
\begin{enumerate}
\item Euler errors are very small
\item The aggregate resource constraint is satisfied ($X=C+\delta K$ in the SS).
\end{enumerate}


\section*{Step 3: Adding a second static firm}

In this step, we will add a representative firm for a second production industry.  This comes with several substantive changes and so we'll just add one additional firm at this point, not making it a general $M$-firm problem until later steps.

A few remarks about the economy with multiple firms.  The multiple firms will produce differentiated output.  These outputs contribute to distinct consumption goods and these various consumption goods go into a composite consumption good consumed each household.  In addition, the output of the firms will contribute to the capital stock.  The capital stock for each representative firm is made up of a different mix out output from the various industries.

In the remainder of this section, we'll work through how we begin with our guesses of the factor prices ($r$ and $w$) and work through the producer and consumer problems.  I'll lay out the theory first, then discuss implementation into the existing code.  

The exposition here only deals with the SS solution, so the ``bars" on variables will be implicit rather than me typing them.  We'll adapt this to the time path solution in a future step.

\subsection*{Theory}

\subsubsection*{The household's optimization problem}

Consumers maximize the present discounted value of utility from consumption a composite consumption good, $\tilde{c}$, leisure, $\tilde{l}-n$, and from bequests:

    \begin{equation}\label{EqUtilMax}
      \begin{split}
        &U_{j,s} = \sum_{s=1}^{S}\beta^u  u\left(\tilde{c}_{j,s},n_{j,s},b_{j,S+1}\right) \\
        &\text{where} \quad u\left(\tilde{c}_{j,s},n_{j,s},b_{j,S+1}\right) = \frac{\left(\tilde{c}_{j,s}\right)^{1-\sigma} - 1}{1-\sigma} ... \\
        &\qquad\qquad + \chi^n\left(\frac{\left(\tilde{l}-n_{j,s}\right)^{1-\nu} - 1}{1-\nu} \right) + \chi^b\frac{\left(b_{j,S+1,}\right)^{1-\sigma} - 1}{1-\sigma} \\
        &\quad\quad\quad\quad\quad\quad\quad\quad\quad\quad\quad\quad\quad\quad\quad\quad\quad\quad\quad\forall j,1\leq s\leq S
      \end{split}
    \end{equation}
    
 Note that this formulation is written without mortality risk and with a warm glow motive for intentional bequests. $\chi^{n}$ and $\chi^{b}$ are the utility weights on the disutility of labor and the warm glow bequest motive, respectively.  The household chooses the optimal sequence of $\tilde{c}_{j,s}$, $n_{j,s}$, and $b_{j,s}$ to maximize lifetime utility subject to the per period budget constraint: 
 
     \begin{equation}\label{EqBC}
      \begin{split}
        \sum_{i=1}^{I} p_{i}\bar{c}_{i,s} + \tilde{p}_{s}\tilde{c}_{s} + b_{j,s+1} \leq \left(1 + r\right) b_{j,s} + w_t e_{j}&n_{j,s} + \frac{BQ_{j}}{\lambda_j\tilde{N}} \\
        \quad\text{where}\quad b_{j,1} = 0 \\
        &\text{for} \quad 1\leq s \leq S 
      \end{split}
    \end{equation}
    
  Prices for individual consumption goods are given by $p_{i}$, whereas $\tilde{p}$ is the price of the composite consumption good.  The parameters $\bar{c}_{i,s}$ are the minimum consumption amounts for good $i$.  $BQ_{j}$ are aggregate bequests from those of type $j$, which are divided equally between the living households of type $j$.  $\tilde{N}$ is the total population, which can be normalized to one for the SS analysis.  Total bequests are given by:
  
  \begin{equation}
  BQ_{j} = \sum_{J} \lambda_{j}b_{j,S+1}\tilde{N}
  \end{equation}
  
 The first order necessary conditions that must be satisfied in the households optimization problem are:
  
      \begin{equation}\label{Eqbfoc}
      \begin{split}
     \frac{\partial U}{\partial \tilde{b}_{j,s+1}}  = \frac{\tilde{c}_{j,s}^{-\sigma}}{\tilde{p}_{s}} - \beta (1+r) \frac{\tilde{c}_{j,s+1}^{-\sigma}}{\tilde{p}_{s+1}}  = 0, \forall s, j
        \end{split}
    \end{equation}

    \begin{equation}\label{Eqnfoc}
      \begin{split}
      \frac{\partial U}{\partial n_{j,s}} & =  \chi^n_{s}\left(\tilde{l}-n_{j,s}\right)^{-\nu} - \frac{we_{j}}{\tilde{p}_{s}}\tilde{c}_{j,s}^{-\sigma} = 0, \forall s, j       
      \end{split}
    \end{equation}

    \begin{equation}\label{Eqbqfoc}
      \begin{split}
      \frac{\partial U}{\partial b_{j,S+1}} & = \frac{\tilde{c}_{j,S}^{-\sigma}}{\tilde{p}_{S}} - \beta (1+r) \chi^{b} b_{j,S+1}^{-\sigma}, \forall j
      \end{split}
    \end{equation}
  
  The composite consumption good is make up of the individual consumption goods, with the amounts determined by the consumer's consumption subutility function.  We assume a Stone-Geary utility function here, with the composite consumption good defined as: 
  
  \begin{equation} \label{eqn:comp_cons}
\tilde{c}_{j,s}  = \prod_{i=1}^I \left( c_{i,j,s} - \bar{c}_{i,s} \right) ^{\alpha_{i}}, 
 \end{equation}
 
 \noindent\noindent where $i$ denotes the particular consumption good.  $\bar{c}_{i,s}$ are the minimum consumption amounts for good $i$.  The composite consumption good is the composite of ``discretionary" consumption on all the goods (consumption above the minimum amounts).  The $\alpha_{i}$ parameters are the share parameters and define the share of discretionary consumption spending (called the ``supernumerary expenditure) that goes to each good $i$.  What this utility function is modeling is that there some basic requirements for sustenance.  For example, you need a certain amount of calories to live, giving you a minimum food expenditure, but you might choose to go above that.  This specification has a couple nice properties as far as our model is concerned.  First, it helps to get a more realistic tax incidence since it'll have the rich and poor spending different shares of their income on different goods (without resorting to preferences that depend upon ability type $j$).  Second, it'll give us more realistic responses of savings to interest rates.  Typically these models have responses that are much stronger than we see in the data.  The minimum consumption shares help to temper that because some may be close to those thresholds and therefore still have a high marginal utility of consumption for the composite good.
 
The consumer chooses $c_{i,j,s}$ to maximize Equation \ref{eqn:comp_cons} subject to the budget constraint:

    \begin{equation} \label{eqn:cons_budgetcons}
        \sum_{i=1}^{I} p_{i}(c_{i,j,s}-\bar{c}_{i,s})  = \tilde{p}_{s}\tilde{c}_{j,s}
    \end{equation}

\noindent where $p_{i}$ is the gross of tax price of good $i$ at time $t$ and $\tilde{p}_{s}$ is the gross of tax price of the the discretionary component of the composite consumption good consumed by those of age $s$ at time $t$.  Maximization of \ref{Eqcagg} subject to \ref{eqn:cons_budgetcons} yields:

    \begin{equation} \label{eqn:cons_lagrangian}
       \mathcal{L} =  \max_{\{c_{i,j,s}\}_{i=1}^{I}}  \prod_{i=1}^I \left( c_{i,j,s} - \bar c_{i,s} \right) ^{\alpha_{i,s}}  + \lambda \left(\tilde{p}_{s}\tilde{c}_{j,s} - \sum_{i=1}^{I} p_{i}(c_{i,j,s}-\bar{c}_{i,s})\right)
    \end{equation}
    
    Which as $I$ FOCs (for each $j$, $s$, $t$):
    
      \begin{equation} \label{eqn:cons_FOC}
      \begin{split}
       & \frac{\partial \mathcal{L}}{\partial c_{i,j,s}} = \frac{\alpha_{i,s} \prod_{i=1}^I \left( c_{i,j,s} - \bar c_{i,s} \right) ^{\alpha_{i,s}}}{(c_{i,j,s}-\bar{c}_{i,s})}-\lambda p_{i} = 0, \forall \ i  \\
       & \implies  \frac{\alpha_{i,s} \prod_{i=1}^I \left( c_{i,j,s} - \bar c_{i,s} \right) ^{\alpha_{i,s}}}{(c_{i,j,s}-\bar{c}_{i,s})} = \lambda p_{i}, \forall \ i \\
       & \implies  \frac{\alpha_{i,s} \prod_{i=1}^I \left( c_{i,j,s} - \bar c_{i,s} \right) ^{\alpha_{i,s}}}{ p_{i}(c_{i,j,s}-\bar{c}_{i,s})} = \lambda, \forall \ i \\
       & \implies \frac{\alpha_{i,s}}{p_{i}(c_{i,j,s}-\bar{c}_{i,s})}=\frac{\alpha_{k,s}}{p_{k}(c_{k,j,s}-\bar{c}_{k,s})}, \forall \ i,k \\
       & \implies c_{i,j,s}= \frac{\alpha_{i,s} p_{k}(c_{k,j,s}-\bar{c}_{k,s})}{\alpha_{k,s} p_{i}} + \bar{c}_{i,s} \forall i,k 
       \end{split}
    \end{equation}
    
    Now substitute the last line of \ref{eqn:cons_FOC} into the budget constraint (Equation \ref{eqn:cons_budgetcons}):
    
          \begin{equation} \label{eqn:cons_solve}
      \begin{split}
       & \tilde{p}_{s}\tilde{c}_{j,s} = \sum_{i=1}^{I}p_{i}(c_{i,j,s}-\bar{c}_{i,s}) \\
       & \implies  \tilde{p}_{s}\tilde{c}_{j,s} = \sum_{i=1}^{I}p_{i}\left[ \frac{\alpha_{i,s} p_{k}(c_{k,j,s}-\bar{c}_{k,s})}{\alpha_{k,s} p_{i}} + \bar{c}_{i,s}- \bar{c}_{i,s}\right] \\
       & \implies  \tilde{p}_{s}\tilde{c}_{j,s} = \sum_{i=1}^{I}\left[ \frac{\alpha_{i,s} p_{k}(c_{k,s}-\bar{c}_{k,s})}{\alpha_{k,s}}\right] \\
       & \implies  \tilde{p}_{s}\tilde{c}_{j,s} = \frac{ p_{k}(c_{k,j,s}-\bar{c}_{k,s})}{\alpha_{k,s}} \underbrace{\sum_{i=1}^{I}\alpha_{i,s}}_{=1} \\	
        & \implies  \tilde{p}_{s}\tilde{c}_{j,s} = \frac{ p_{k}(c_{k,j,s}-\bar{c}_{k,s})}{\alpha_{k,s}} \\
        & \implies  \frac{ p_{k}(c_{k,j,s}-\bar{c}_{k,s})}{\alpha_{k,s}}  = \tilde{p}_{s}\tilde{c}_{j,s}   \\	
        & \implies  c_{k,j,s}  = \frac{\alpha_{k,s} \tilde{p}_{s}\tilde{c}_{j,s}}{p_{k}} + \bar{c}_{k,s},  \forall \ k  \\	
       \end{split}
    \end{equation}
    
    Thus, total consumption of each good $i$, $c_{i,j,s}$, is given by the the amount of minimum consumption plus the share of total expenditures remaining after making the minimum expenditures on all goods (this is called the ``supernumerary" expenditure).  We derive the prices of the age $s$ composite consumption good in period $t$, $\tilde{p}_{s}$ by using the demand for good $i$ provided in Equation \ref{eqn:cons_solve} in the function defining aggregate discretionary consumption, Equation \ref{eqn:comp_cons}: 
    
              \begin{equation} \label{eqn:composite_price}
      \begin{split}
      & \tilde{c}_{j,s} = \prod_{i=1}^{I}(c_{i,j,s}-\bar{c}_{i,s})^{\alpha_{i,s}} \\
      &\implies \tilde{c}_{j,s} = \prod_{i=1}^{I}\left( \frac{\alpha_{i,s} \tilde{p}_{s}\tilde{c}_{j,s}}{p_{i}} + \bar{c}_{i,s}-\bar{c}_{i,s}\right)^{\alpha_{i,s}} \\
      &\implies \tilde{c}_{j,s} = \prod_{i=1}^{I} \left( \frac{\alpha_{i,s} \tilde{p}_{s}\tilde{c}_{j,s}}{p_{i}} \right)^{\alpha_{i,s}} \\
      &\implies \tilde{c}_{j,s} =  \tilde{p}_{s}\tilde{c}_{j,s} \prod_{i=1}^{I}\left( \frac{\alpha_{i,s}}{p_{i}} \right)^{\alpha_{i,s}} \\
      &\implies \frac{\tilde{p}_{s}\tilde{c}_{j,s}}{\tilde{c}_{j,s}} =  \prod_{i=1}^{I}\left( \frac{p_{i}}{\alpha_{i,s}} \right)^{\alpha_{i,s}} \\
       &\implies \tilde{p}_{s} =  \prod_{i=1}^{I}\left( \frac{p_{i}}{\alpha_{i,s}} \right)^{\alpha_{i,s}} \\
       \end{split}
    \end{equation}
    
    This composite good price is then used in the household's intertemporal optimization problem described in Equation \ref{EqUtilMax}.  With the parameters and endogenous variables, we then use \ref{eqn:cons_solve} to find the $c_{i,j,s}$.
 
\subsubsection*{The firm's optimization problem} 

Each industry is represented by a competitive firm with a constant returns to scale (CRS) CES production function.  We will assume here that each industry output becomes a unique consumption good.  That is if there two production industries, the industry one produces output used for $c_{1}$ and industry two produces output used for $c_{2}$.  Thus we will denote each industry with the subscript $i$, which corresponds to the consumption good they produce.  We'll relax this in the future.  Also, at this point we'll assume that capital can be made from output from either sector.  One unit of output from each sector can be used to produce one unit of capital which can be used by either sector.\footnote{It may be helpful here to think about a financial intermediary that is implicitly sitting between the household and the firm.  This intermediary takes the dollars from the household and transforms them into capital for the firms.}  Because of the CRS and competitive assumptions, firms earn zero profits in equilibrium.  The capital and labor market equilibrium also imply that the wage and rental rates are the same across industry.  We thus have three equations that define the firm's problem, two from the firm's first order conditions for labor and capital demand, and the third from the zero profit condition.  These are:

\begin{equation}
r = p_{i}*MPK(K_{i},EL_{i}) - \delta, \forall i
\end{equation}

\begin{equation}
w = p_{i}*MPL(K_{i},EL_{i}), \forall i
\end{equation}

\begin{equation}
p_{i}X_{i}= w*EL_{i} + (r+\delta)K_{i}
\end{equation}
 
 
\subsubsection*{From factor prices to industry output prices}

Given the guess of the equilibrium interest rate and wage rate, we can use the first order conditions of the firm and the zero profit condition to determine the price of the output of the firms.  In particular, we can use the firm FOCs to find $K(r,w,X)$ and $EL(r,w,X)$.  

With CES production, we'll want to solve for $EL(r,w,X)$ and $K(r,w,X)$.  These can be solved for using the firm's FOCs and are given by:

\begin{equation}
\label{eqn:l_demand}
EL_{i}(r,w,X_{i})=\frac{(1-\gamma)X_{i}}{\left(\frac{w}{p_{i}}\right)^{\epsilon}A^{1-\epsilon}}
\end{equation}



\begin{equation}
\label{eqn:k_demand}
K_{i}(r,w,X_{i})=\frac{\gamma X_{i}}{\left(\frac{(r+\delta)}{p_{i}}\right)^{\epsilon}A^{1-\epsilon}}
\end{equation}


It'll also be useful to write factor demands as derived from the production function and FOCs together.  We'll use this when we derive the demand for capital that is required to produce a given amount of output.\footnote{Note that we need this equation because although we can solve for capital demand as a function of output demanded from Equation \ref{eqn:k_demand}, we will use this equation in determining demand for output (Equation \ref{eqn:find_output}).  In order to use the correct number of unique equations, we'll use these two different equations to solve for capital demand, one of which uses only the FOC for capital and the other, which uses the FOCs and the production function.} 

\begin{equation}
\label{eqn:k_demand2}
K_{i} = \frac{X_{i}}{A}\left[\gamma^{\frac{1}{\epsilon}}+(1-\gamma)^{\frac{1}{\epsilon}}\left(\frac{r+\delta}{w}\right)^{\epsilon-1}\left(\frac{1-\gamma}{\gamma}\right)^{\frac{\epsilon-1}{\epsilon}}\right]^{\frac{\epsilon}{1-\epsilon}}
\end{equation}

and

\begin{equation}
\label{eqn:l_demand2}
EL_{i} =K_{i}\left(\frac{(1-\gamma)}{\gamma}\right)\left(\frac{(r+\delta)}{w}\right)^{\epsilon}
\end{equation}


Plugging these factor demands from equations \ref{eqn:l_demand} and \ref{eqn:k_demand} into the zero profit condition, we get:

\begin{equation}
\label{eqn:prices}
\begin{split}
p_{i}X_{i} &= w EL_{i} + (r+\delta)K_{i} \\
p_{i}X_{i} &= w \frac{(1-\gamma)X_{i}}{\left(\frac{w}{p_{i}}\right)^{\epsilon}A^{1-\epsilon}} + (r+\delta)\frac{\gamma X_{i}}{\left(\frac{(r+\delta)}{p_{i}}\right)^{\epsilon}A^{1-\epsilon}} \\
\implies p_{i} & = \left[(1-\gamma)\left(\frac{w}{A}\right)^{1-\epsilon} + \gamma\left(\frac{(r+\delta)}{A}\right)^{1-\epsilon} \right]^{\frac{1}{1-\epsilon}}
\end{split}
\end{equation}


%The cost function is given by $C(r,w,X) = w*L(r,w,X) + (r+\delta)*K(r,w,X)$.  With CRS production technology, we have the marginal cost being constant over all levels of output.  The firm's profit maximization of the firm results in price equal marginal cost.  Thus we'll find $p_{m} = \frac{\partial C(r,w,X)}{\partial X} = mc(r,w)$, where $p_{m}$ is the price of output from industry $m$.
%
%
%The price of output is thus determined by the condition that price equal marginal cost:
%
%\begin{equation}
%\label{eqn:output_price}
%p_{m}(r_{t},w_{t}) = \hat{w}_{t}\frac{EL_{m}(r_{t},w_{t},X_{m})}{X_{m}} + (r_{t}+\delta_{m})\frac{K_{m}(r_{t},w_{t},X_{m})}{X_{m}}
%\end{equation}
%
%\subsection*{From industry output prices to prices of consumption goods}
%
%We use a fixed-coefficient matrix to map the output of production goods to consumption goods.  This captures the fact that a good is made up of the output from a number of production sectors.  E.g. Your purchase of a hamburger combines output from the agriculture, transportation, and retail industries, among others.  This fixed coefficient matrix will be calibrated using the BEA's Personal Consumption Expenditure Bridge Tables.  There are $I$ consumption goods.  The fixed-coefficient matrix will be an $M\times I$ matrix, which we will call $\Pi$.  The elements of $\Pi$, $\pi_{m,i}$ give the share consumption good $m$ the comes from the output of industry $m$.  If $\boldsymbol{p^{c}_{t}}$ is the $I$-length vector of consumption good prices in period $t$, then this vector is determined as:
%
%\begin{equation}
%\label{eqn:cons_price}
%\underbrace{\boldsymbol{p^{c}_{t}}}_{1 \times I} = \underbrace{\boldsymbol{p_{m}}}_{1 \times M} \times \underbrace{\Pi}_{M \times I}
%\end{equation}

\subsubsection*{From prices of individual consumption goods to the price of the composite consumption good}

We've got the prices of individual consumption goods from the zero profit condition of the firm's problem.  As noted above, the price of the composite consumption good can be derived from the prices of individual consumption goods and the solution to the consumer's subutility maximization problem.  The yields:

\begin{equation} \label{eqn:composite_price2}
\tilde{p}_{s} =  \prod_{i=1}^{I}\left( \frac{p^{c}_{i}}{\alpha_{i,s}} \right)^{\alpha_{i,s}} \\
\end{equation}

It is this composite price that enters the household's intertemporal optimization problem where is chooses the amount of discretionary consumption, labor supply, and savings for each period.  The budget constraint will contain a term for the cost of require consumption and discretionary consumption.  


%Let's now walk through the relevant equations to add/change in the code from this subsection:
%
%We'll need to take result of Equation \ref{eqn:cons_price} and put that in Equation \ref{eqn:composite_price} to find the price of the composite consumption good.  The price will then feed into the household's utility maximization problem because we can write total consumption as:
%
%\begin{equation}
%\label{eqn:total_cons}
%c_{j,s}=\tilde{c}_{j,s}+\sum_{i=1}^{I}c_{i,s} 
%\end{equation}
%
%\noindent\noindent Thus the budget constraint of the household becomes:
%
%\begin{equation}\label{EqBC}
%\begin{split}
%\sum_{i=1}^{I} p^{c}_{i}\bar{c}_{i,s} + \tilde{p}_{s}\tilde{c}_{s} + b_{j,s+1,t+1} \leq \left(1 + r_t\right) b_{j,s} + w_t e_{j,s}&n_{j,s} + \frac{BQ_{j}}{\lambda_j\tilde{N}_t} - T_{j,s} \\
%\quad\text{where}\quad b_{j,s,1} = 0 \\
%&\text{for} \quad E+1\leq s \leq E+S \quad \forall j,t
%\end{split}
%\end{equation} 
%
%The household FOC's will look similar to what we currently have. We'll use the choice of total consumption and Equation \ref{eqn:total_cons} to solve for $\tilde{c}_{j,s}$.  We then use $\tilde{c}_{j,s}$ in Equation \ref{eqn:cons_solve} to find the demand for consumption good $i$, by household with ability $j$ and of age $s$ at time $t$.  Summing this over $J$ and $S$ gives of the aggregate demand for consumption good $i$ at time $t$, $c_{i}$. 
%
%The aggregate supplies of capital and labor are determined as before.

\subsubsection*{Finding total demand for the output from industry $i$}

Given the CRS production function, we need to find total output to determine the demands for capital and labor by the firm.  To find the total demand for output, we'll use the resource constraint.  In particular, the demand for output from each sector is determined by the demand for output from that sector for consumption and investment.

From the solution to the household's problem, we have the demands for each consumption good, $c_{i}$.  We'll let the aggregate demand for consumption goods from industry $i$ (summing over $S$ and $J$), be given by $C_{i}$.  Total demand for output from industry $i$ is the sum of the demands from consumption and investment.

To find the demands for investment, note that in the SS, $I_{i}=\delta K_{i}$.  Recall that from Equation \ref{eqn:k_demand}, we can write the demand for capital as a function of output.  We can use this to find the total demand for output from each industry:

\begin{equation}
\label{eqn:find_output}
\begin{split}
X_{i} &= C_{i} + \delta K_{i} \\
X_{i} &= C_{i} + \delta \left(\frac{\gamma X_{i}}{\left(\frac{(r+\delta)}{p_{i}}\right)^{\epsilon}A^{1-\epsilon}} \right)\\
\implies X_{i} &= \frac{C_{i}}{1-\frac{\delta \gamma}{\left(\frac{(r+\delta)}{p_{i}}\right)^{\epsilon}A^{1-\epsilon}}}
\end{split}
\end{equation}  

With the demand for output from each industry, $r$, and $w$, we can solve for each industry's factor demands from equations \ref{eqn:l_demand} and \ref{eqn:k_demand}.

Let's explain a few assumptions that we are making here.  First, we have assumed that consumption good $i$ is made up solely from the output of industry $i$.  This assumption first manifested itself about when we found the price of consumption good $i$ as the price charged for output from producers in industry $i$ (Equation \ref{eqn:prices}).  Second, we are assuming that the capital stock used in industry $i$ is made from the output of industry $i$ (hence there the resource constraint in Equation \ref{eqn:find_output} being written in terms of industry $i$ only.  Finally, and this assumption is the least explicit, we assume that some financial intermediary channels household savings into the appropriate industry.  Implicitly, all prices above ($w, r, p_{i}, \tilde{p}$) are relative to the price of capital, which is the numeraire and normalized to one.  Each unit of account the household saves is a unit of capital.  In our capital market clearing condition (Equation \ref{eqn:cap_mkt_clear}), we sum the capital demanded by each industry together and check that it is equal to the capital supplied by the household.  What's implicit here is that the households savings can be used for the capital of either industry.  Think of it as a household saving an unspecified unit of capital and a financial intermediary that operates between the household and the firm and ensures that savings of each household is in the appropriate capital stock as demanded from each firm (e.g., with two firms, the intermediary makes sure the appropriate fraction of household savings is of the capital type used by firm 1 and the remained is the type used by firm 2).  The household is indifferent to what type of capital it owns, since both are paid the same rate of return, $r$.

\textcolor{red}{One thing that I'm not sure of - in the explanation above, the price of capital in both industries is normalized to one.  Can two prices be normalized like this?  This will not be relevant when we make the firm's problem dynamic since households will not longer rent capital to firms.  Rather there will be a price of capital and firms will purchase capital directly - and the capital stock (and price of new capital) for each industry will be accounted for explicitly with each in the problem of the representative firm in each industry.}


\subsubsection*{Closing up the model - finding an equilibrium}

The SS equilibrium will be defined by prices and allocations such that the above equations are all satisfied and markets clear.  Walras Law says that we need only check for market clearing in two of the three markets.\footnote{Note that we have a goods market, a capital market, and a labor market.}  The market clearing conditions with multiple firms become:

\begin{equation}
\label{eqn:cap_mkt_clear}
\sum_{i} K_{i} = \sum_{J}\sum_{S}b_{j,s}
\end{equation}

\noindent\noindent and 

\begin{equation}
\sum_{i} EL_{i} = \sum_{J}\sum_{S}e_{j,s}*n_{j,s}
\end{equation}


\subsection*{Computation}

To compute the solution to the SS of the model with two firms, we'll build off the algorithm set out in step one.  New steps/functions are highlighted in red:

\begin{enumerate}
\item Make an initial guess at $\bar{r}$ and $\bar{w}$
\item \textcolor{red}{Use $r$ and $w$ and Equations \ref{eqn:prices} and \ref{eqn:composite_price2} to solve for the price of consumption goods 1 and 2 and the composite good price.}
\item Taking $\bar{r}$, $\bar{w}$, $p_{1}$, $p_{2}$, and $\tilde{p}$ as given, solve the household's problem:
	\begin{itemize}
	\item For each $j$ type:
		\begin{enumerate}
		\item Make an initial guess at the household's optimal savings and labor supply decisions, $b_{j,s}$, $n_{j,s}$.
		\item Use a root finder (e.g. \texttt{fsolve}) to determine the optimal allocations given $\bar{r}$ and $\bar{w}$.
		\end{enumerate}
	\end{itemize}
\item \textcolor{red}{Aggregate over $J$ and $S$ to determine aggregate supply of labor and capital (where savings=capital), and aggregate consumption of each good; $K$, $EL$, $C_{1}$, $C_{2}$.}
	\begin{itemize}
	\item Remember to find $EL$ as the aggregate amount of effective labor units supplied, so you not only want to sum over $J$ and $S$, but weight by the number of effective labor units each type/age supplies.
	\end{itemize}
\item \textcolor{red}{Use the aggregate demands for each of the two consumption goods and Equation \ref{eqn:find_output} to solve for the output from each industry $i$.}
\item \textcolor{red}{Use Equations \ref{eqn:l_demand2} and \ref{eqn:k_demand2} to solve for the factor demands from each industry.}
\item \textcolor{red}{Find the aggregate capital stock demanded: $K = K_{1}+K_{2}$.}
\item \textcolor{red}{Find the aggregate effective labor demanded: $EL = EL_{1}+EL_{2}$.}
\item \textcolor{red}{Take differences between aggregate amounts supplied and demanded.}
\item \textcolor{red}{Use a root finder to determine the eq'm $\bar{r}$ and $\bar{w}$ (i.e. it'll find the $\bar{r}$ and $\bar{w}$ where $K_{demand}-K_{supply}=0$ and $EL_{demand}-EL_{supply}=0$).}
\end{enumerate}

You might start by setting $\bar{c}_{1}=\bar{c}_{2}=0$ and $\alpha_{1}=\alpha_{2}=(1-\alpha_{1})=0.5$ (note that the $\alpha$'s have to sum to one).  Once you solve the model with this parameterization, try changing these parameters to make sure everything works out.  Note that you won't want to set the minimum consumption amounts too high since that may result in the consumer not being able to afford positive amounts of the composite consumption good.

To check that this all works as expected, makes sure:
\begin{enumerate}
\item Euler errors are very small
\item The aggregate resource constraint is satisfied ($X_{i}=C_{i}+\delta K_{i}$ for each industry $i$ in the SS).
\item The labor and capital markets clear.
\item If you set $\alpha_{1}=1$ (so $\alpha_{2}=0$), that you get the same solution as with the one good/firm problem.
\end{enumerate}

\subsection*{Alternative Computational Procedure}

This section proposes and alternative computational procedure.  This method has the advantage that one can write code such that a while loop can replace the outer  \texttt{fsolve}, which is used above to determine $r$ and $w$.  The updating of $r$ and $w$ in this method can leverage differences between the current and prior iteration, speeding up the model's convergence.  The algorithm uses the same steps 1-6 as above.  The differences in the remainder are:

\begin{enumerate}
\setcounter{enumi}{6}
\item With the factor demands in hand, use the firm FOCS to find the implied wage rate and interest rate for each firm. Call these $r_{new}$ and $w_{new}$.
	\begin{itemize}
	\item Note that the implies factor prices should be the same for each firm - so you only need to solve for one, but do a check to make sure they are the same.
	\item Note that you'll need to rearrange Equations \ref{eqn:k_demand} and \ref{eqn:l_demand} to find $r$ and $w$ in terms of factor demands and output prices:
	\item $r = p_{i} MPK(K_{i},EL_{i}) - \delta$
	\item $w = p_{i} MPL(K_{i},EL_{i}) $
	\end{itemize}
\item Take differences between $r_{new}$ and $r$ and $w_{new}$ and $w$.
\item Use a root finder to determine the eq'm $r$ and $w$ (i.e. it'll find the where $r_{new}-r=0$ and $w_{new}-w=0$).
\end{enumerate}

Be sure to run all the checks noted above to make sure the solution you find is actually the correct solution.

Evan and Isaac were able to use a convex combination or the $r_{new}$ and $r$ (and $w_{new}$ and $w$) to update, but we can start by just getting this to work with a root finder to solve the outer loop.  \textcolor{red}{Note that I have not been successful in computing this because, despite the resource constraint and Euler equations being satisfied and the factor prices converging, the market clearing conditions are not satisfied.  In this algorithm with a single firm, the factor supplies are plugged into the firm FOCs to get the new implied interest rate.  In the two firm problem, one can't do this since you need to figure out how to split those factor demands across the firms.  The necessitates solving for the factor demands from each firm and there so market clearing is not satisfied by construction as it was with this algorithm applied to the single firm problem.}

\section*{Step 4: Generalizing to $M$ firms and $I$ consumption goods}

Now that the two firm problem has been solved, we can generalize to more industries and goods quite easily.  In the computational model, we'll used array operators to make the code deal with the increased number of firms and goods quite efficiently.  The major changes to the setup from Step 3 are as follows.

First, we may generalize out parameters:
\begin{itemize}
\item The parameters of the firm problem may be industry specific: $\delta_{m}, \gamma_{m}, \epsilon_{m}, A_{m}$.
\end{itemize}

Second, we need to map output good prices into consumption good prices.  To do this, we'll use a fixed-coefficient matrix that related industry outputs to consumption goods.  This matrix corresponds to the BEA's PCE-Bridge Table.  This will be an $M\times I$ matrix, where the element of row $m$ and column $i$ gives the fraction of consumption good $i$ that is comprised of output from industry $m$.  Thus, each column of this matrix must sum to 1.  Let's denote this matrix by $\Pi$.  If we let $\boldsymbol{p^{c}_{t}}$ b an $I$-length vector of consumption goods prices and $\boldsymbol{p_{t}}$ be an $M$-length vector of output good prices, then we can find the prices of consumption goods as:

\begin{equation}
\label{eqn:capital_prices}
\underbrace{\boldsymbol{p^{c}_{t}}}_{1\times I} =\underbrace{\boldsymbol{p_{t}}}_{1\times M} \times  \underbrace{\Pi}_{M\times I}
\end{equation}

This relation between production and consumption goods given by $\Pi$ also enters into the general version of each industry's resource constraint (Equation \ref{eqn:find_output} above).   To think about the most general version of this resource constraint, we also need to consider another fixed-coefficient matrix, this one relating industry outputs to industry inputs.  This table corresponds to the BEA's Input-Output Tables.  This matrix is an $M\times M$ matrix, where the element of row $m$ and column $n$ gives the fraction of the capital good for industry $n$ that is comprised of output from industry $m$.  Thus, each column of this matrix must sum to 1.   We'll denote this matrix by $\Xi$.  If we let $\boldsymbol{p^{k}_{t}}$ b an $M$-length vector of capital goods prices and $\boldsymbol{p_{t}}$ be an $M$-length vector of output good prices, then we can find the prices of capital goods as:

\begin{equation}
\label{eqn:capital_prices}
\underbrace{\boldsymbol{p^{k}_{t}}}_{1\times M} =\underbrace{\boldsymbol{p_{t}}}_{1\times M} \times  \underbrace{\Xi}_{M\times M}
\end{equation}

With these relationships, the resource constraints for the $M$ industries can be written in matrix notation as:

\begin{equation}
\label{eqn:matrix_rc}
\underbrace{\boldsymbol{X_{t}}}_{1\times M} = \underbrace{\underbrace{\boldsymbol{C_{t}}}_{1\times I} \times  \underbrace{\Pi'}_{I\times M}}_{1\times M} + \underbrace{\underbrace{\boldsymbol{I_{t}}}_{1\times M} \times  \underbrace{\Xi'}_{M\times M}}_{1\times M}, 
\end{equation}

\noindent\noindent where $\boldsymbol{C_{t}}$ is the vector of aggregate consumption of each of the $I$ consumption goods and $\boldsymbol{I_{t}}$ is the vector of investment demand for each of the $M$ production industries.  Thus $\boldsymbol{X_{t}}$ gives the total output demanded from each industry stemming from both household demand for consumption and industry demand for investment.  In the steady state, we know that $\bar{I}_{m,}=\delta \bar{K}_{m}$.  

As in the previous section, we use these output demands to solve for the factor demands from the representative firm's in each of the $I$ industries.  We then can check out market clearing constraints by ensuring that aggregate capital demanded by firms is equal to the supply of capital from the household and that the aggregate demand for labor from the firms is equal to the aggregate amount of effective labor units supplied by the household.

\section*{Step 5: Making the firm's problem dynamic}

In this step, we'll make the firm's problem dynamic. This means firms own capital, not rent it from the household.  This doesn't in itself have a large effect on the equations governing the firm in the steady state, but it will certainly change the solution along the time path and requires us to redefine the ``zero profit" condition of the firm. One major effect here is that the capital market clearing condition will be replaced by an asset market clearing condition.  In particular, that the household demand for equities equal the value of the firms in the economy.

\subsection*{The problem of a firm (sequence problem)}

Let's begin by defining the problem of a firm so that we understand it's optimization problem and how that will fit into our general equilibrium model.

Let's consider a simple model where the firm hires labor and purchases capital to maximize profits.  The firm is infinitely lived, and so it maximizing the discounted value of the stream of future profits.  Let the per period profits be given by $\pi(K_{t},L_{t},K_{t+1}) = p_{t}F(K_{t},L_{t}) - w_{t}L_{t} - p^{k}_{t}(K_{t+1} - (1-\delta)K_{t})$.\footnote{You often just see revenue minus labor costs as the profit function in these dynamic problems, but this notation makes the exposition of the problem more clear and doesn't change the substance.}  The notation is as follows:
\begin{itemize}
\item The subscript $t$ refers to the period. 
\item $K$ is the capital stock owned/used by the firm
\item $L$ are the units of labor hired by the firm
\item $F(K,L)$ is the firm's production function
\item $w$ is the wage rate, the price of labor
\item $p$ is the price of output
\item $p^{k}$ is the price of capital
\item $\delta$ is the rate at which the capital stock depreciates
\end{itemize}

We have a transition equation for the dynamic variable, $K_{t}$, which tells us how the capital stock evolves over time: $K_{t+1} = (1-\delta)K_{t} + I_{t}$, where $I_{t}$ is gross investment. Thus another way to write the per period profit function is: $\pi(K_{t},L_{t},K_{t+1}) = p_{t}F(K_{t},L_{t}) - w_{t}L_{t} - p^{k}_{t}I_{t}$.  We can normalize one of these prices to one by dividing through by that price.  We'll make the price of output the numeraire, dividing through by $p_{t}$ yields: $\pi(K_{t},L_{t},K_{t+1}) = F(K_{t},L_{t}) - \frac{w_{t}}{p_{t}}L_{t} - \frac{p^{k}_{t}}{p_{t}}I_{t}$.  In an economy with one good, the produced good is the same as capital and so $p^{k}_{t}=p_{t}$.   Let $\tilde{w}_{t}=\frac{w_{t}}{p_{t}}$, be the real wage (the number of units of output paid for a unit of labor).  We can thus write the profit function as: $\pi(K_{t},L_{t},K_{t+1}) = F(K_{t},L_{t}) - \tilde{w}_{t}L_{t} - I_{t}$.

The problem of the firm is the maximize the discounted present value of these profits.  Let the the discount rate of the firm be $\beta=\frac{1}{1+r}$.  That is, the firm discounts profits based on the return it can get on a risk free asset, given by $r$.  In principle $r$ can change from year to year, but let's just write the discount rate as $\beta$ to simply the notation here (we'll add the complexity in a bit).  The problem of the firm is thus:

\begin{equation}
\label{eqn:firm_seq_prob}
\max_{\{L_{t},K_{t+1}\}^{\infty}_{t=0}} \sum_{t=0}^{\infty} \beta^{t}\pi(K_{t},L_{t},K_{t+1})
\end{equation}

Note that you can also write this optimization problem as one where the firm chooses investment:

\begin{equation}
\label{eqn:firm_seq_prob2}
\begin{split}
\max_{\{L_{t},I_{t}\}^{\infty}_{t=0}} \sum_{t=0}^{\infty} \beta^{t}\pi(K_{t},L_{t},I_{t}) \\
\quad\quad \text{subject to: } K_{t+1} = (1-\delta)K_{t} + I_{t} 
\end{split}
\end{equation}

In either case, the household is choosing labor supply today and the amount of capital to start the next period with (either directly through the choice of $K_{t+1}$ or indirectly through the choice of $I_{t}$.  Their will be an infinite number of first order conditions - a set of which are for the choice of labor and a set of which are for the choice of capital/investment.  In particular, for the choice of labor, we have:

\begin{equation}
\label{eqn:dyn_firm_foc_l}
\begin{split}
&\frac{\partial \pi(K_{t},L_{t},K_{t+1})}{\partial L_{t}} = 0, \forall \ t \\
 \implies & \frac{\partial F(K_{t}, L_{t})}{\partial L_{t}} = \tilde{w}_{t}, \forall \ t \\
\end{split}
\end{equation}

and for the choice of capital we have:

\begin{equation}
\label{eqn:dyn_firm_foc_k}
\begin{split}
&\frac{\partial \pi(K_{t},L_{t},K_{t+1})}{\partial K_{t+1}} + \frac{\partial \pi(K_{t+1},L_{t+1},K_{t+2})}{\partial K_{t+1}} = 0, \forall \ t \\
 \implies & 1 = \beta \left[ \frac{\partial F(K_{t+1}, L_{t+1})}{\partial K_{t+1}}  + 1 - \delta\right], \forall \ t \\
 & \text{Noting that } \beta= \frac{1}{1+r}, \text{ we have: } \\
  & r+\delta =  \frac{\partial F(K_{t+1}, L_{t+1})}{\partial K_{t+1}} , \forall \ t 
\end{split}
\end{equation}

You can see that these conditions look very similar to that of the static firm.  Firms hire labor up until the point where the marginal product of labor (which is the marginal benefit of labor) equals the wage rate (which is the marginal cost of labor).  Firms purchase capital up to the point where the marginal product of capital (which is the marginal benefit of having capital) is equal to the marginal cost (given by the user cost of capital - the sum of the opportunity cost of not earning rate $r$ on the money invested in capital and the cost of depreciation).

\subsubsection*{Firm Sequence Problem Exercises}

\begin{enumerate}
\item Write out the Lagrangian describing the firm's constrained optimization problem of Equation \ref{eqn:firm_seq_prob2}.  What are the first order necessary conditions?
\item Assume a Cobb-Douglas production function.  Solve for the steady state level of capital and labor as functions of the parameters, $\bar{r}$, and $\bar{w}$ in the partial equilibrium model (i.e., only consider the firm).
\end{enumerate}

\subsection*{The problem of the firm (Bellman equation)}

It'll often be useful to write the problem of the firm as a Bellman equation, rather than as a sequence problem.  This means we are writing the firm's problem as a functional equation.  A functional equation is an equation which specifies a function implicitly.  In this case, that implicit function is the value function - or the maximum of the firms objective problem.  We'll denote the value function with $V(\cdot)$ and the solution to the Bellman equation is the maximum firm value, which is the maximum net present value of firm profits.  The value function for the firm is written as:

\begin{equation}
\label{eqn:firm_bellman}
\begin{split}
& V(K; r, w) = \max_{K', L} \pi(K,L,K') + \beta V(K'; r', w') \\
\end{split}
\end{equation}

A few notes on this equation:
\begin{itemize}
\item I'm using $w$ as the real wage so I don't have to type $\tilde{w}$.
\item Since the time horizon is infinite, time subscripts are omitted.  At any period, there are an infinite number of periods ahead for the firm to plan for.
\item ``Primed" variables denote one period ahead variables.  So $K$ is the firm's capital stock in the current period and $K'$ is it's capital stock in the next period.
\item The arguments in the $V(\cdot)$ functions are the ``state variables".  These variables include all the relevant information the firm needs to know about it's situation or the aggregate economy in order to make a decision.  
\item $V(\cdot)$ appears on both sides of the equality.  It is thus implicitly defined by this equation (hence the Bellman Equation being termed a functional equation).
\item With this new notation, the transition equation becomes: $K' = (1-\delta)K + I$
\item We are solving this functional equation for 3 functions:
	\begin{enumerate}
	\item A policy function for $L$: $L(K;r,w)$, which tell us how much labor the firm hires given the state variables $K,r,w$
	\item A policy function for $K'$: $K'(K;r,w)$, which tell us how much capital the firm purchases given the state variables $K,r,w$
	\item A value function, $V(K;r,w)$, which tell us the value of the firm given the state variables $K,r,w$
	\end{enumerate}
\end{itemize}

If we take the first order conditions for labor and capital, respectively, we get:

\begin{equation}
\label{eqn:bellman_foc_l}
\begin{split}
&\frac{\partial V(K;r,w)}{\partial L} = \frac{\partial \pi(K,L,K')}{\partial L} = 0 \\
\implies & \frac{\partial F(K,L)}{\partial L} = w \\
\end{split}
\end{equation}

and 

\begin{equation}
\label{eqn:bellman_foc_k}
\begin{split}
&\frac{\partial V(K;r,w)}{\partial K'} = \frac{\partial \pi(K,L,K')}{\partial K'} + \beta \frac{\partial V(K'; r',w')}{\partial K'} = 0 \\
\implies & 1 = \beta \frac{\partial V(K';r',w')}{\partial K'}  \\
\end{split}
\end{equation}

Note that we don't know $\frac{\partial V(K';r',w')}{\partial K'}$.  $V(K;r,w)$ is a function we are solving for and to find it, we need to know the optimal choices of $K'$.  But the FOC for capital is saying that we need $V(K;r,w)$ to solve for the choice of capital!  What can we do?  We are going to use something called the Envelope Condition.  Let's apply, then explain it in words.

First, take the derivative of $V(K;r,w)$ with respect to $K$: 

\begin{equation}
\begin{split}
& \frac{\partial V(K;r,w)}{\partial K} = \frac{\partial \pi(K,L,K')}{\partial K} +  \frac{\partial \pi(K,L,K')}{\partial K'}\frac{\partial K'}{\partial K} + \beta  \frac{\partial V(K'; r',w')}{\partial K'}\frac{\partial K'}{\partial K} \\
\implies &  \frac{\partial V(K;r,w)}{\partial K} = \frac{\partial \pi(K,L,K')}{\partial K} +  \underbrace{\left(\frac{\partial \pi(K,L,K')}{\partial K'} + \beta  \frac{\partial V(K'; r',w')}{\partial K'}\right)}_{=0, \text{ by FOC for $K'$}}\frac{\partial K'}{\partial K} \\
\implies & \frac{\partial V(K;r,w)}{\partial K} = \frac{\partial \pi(K,L,K')}{\partial K} = \frac{\partial F(K,L)}{\partial K} + 1 - \delta \\
& \text{iterating one period ahead, we have:}\\
& \frac{\partial V(K';r',w')}{\partial K'} = \frac{\partial \pi(K',L',K'')}{\partial K'} =  \frac{\partial F(K',L')}{\partial K'} + 1 - \delta  \\
\end{split}
\end{equation}

So we know what $ \frac{\partial V(K';r',w')}{\partial K'}$ is in terms of variables and parameters.  The Envelope Condition (or Envelope Theorem) that helps us determine this is a result of what's called the ``principle of optimality".  This is the idea that once we have optimized along the entire path (i.e., the firm is choosing the optimal $K'$ in all periods), then the change in those policy functions (the functions determining $K'$ as a function of the state variables ($K,r,w$) is zero.  So if we change a state variable (in this case $K'$) the effect on the value function is only the direct effect of the change in $K'$ on next period profits - the effect of the change in $K'$ on $K''$, $K'''$, etc. are all zero due to the principle of optimality.

Using this Envelope Condition, we can rewrite the FOC for $K'$ as:

\begin{equation}
\label{eqn:bellman_foc_k2}
\begin{split}
&\frac{\partial V(K;r,w)}{\partial K'} = \frac{\partial \pi(K,L,K')}{\partial K'} + \beta \frac{\partial V(K'; r',w')}{\partial K'} = 0 \\
\implies & 1 = \beta \frac{\partial V(K';r',w')}{\partial K'}  \\
\implies & 1 = \beta \left[ \frac{\partial F(K',L')}{\partial K'} + 1 - \delta \right] \\
& \text{or, noting that } \beta = \frac{1}{1+r}: \\
\implies & r+\delta = \frac{\partial F(K',L')}{\partial K'}  \\
\end{split}
\end{equation}

So the FOCs are the same as in the sequence problem, which they out to be (since it is just a different way to state the same problem).

\subsubsection*{An aside on Q-theory}

Tobin's Q is a way to determine optimal investment policy.  Tobin's Q measures the marginal value of capital invested in the firm.  Using the Bellman Formulation, we can write marginal Tobin's q (also called just ``marginal q") as:

\begin{equation}
\label{eqn:marginal_q}
q = \frac{\partial V(K;r,w)}{\partial K}
\end{equation}

Thus $q$ gives the marginal change in firm value for another unit of capital invested in the firm.  $q$ thus provides a sufficient statistic for investment - if $q$ is greater than the price of capital, invest - else don't.  The Q-theory of investment is helpful in thinking about optimal investment behavior and in interpreting the necessary conditions of the firms problem.  We'll return to this view in our discussions below.

%
%
%
%\subsubsection*{Exercises with the Bellman equation formulation of the firm problem}


\subsection*{Solving the firm's problem outside of the steady state}

\subsubsection*{Deriving the value of the firm}

The return on owning a share of firm $i$ is given by:

\begin{equation}
\label{eqn:r_firm_i}
r_{i,t} = \frac{DIV_{it} + \overbrace{V_{i,t+1}-V_{i,t}-VN_{i,t}}^{\text{capital gains}}}{V_{i,t}}, 
\end{equation}

\noindent\noindent where $DIV_{i,t}$ are dividends distributed by firm $i$ at time $t$, $V_{i,t}$ is the value of the firm, and $VN_{i,t}$ are new equity issues by the firm.  New equity issued in period $t$ lower the return to the shareholders owning the firm at the beginning of period $t$ since they dilute those shareholders' fraction of ownership in the firm.  

An asset market equilibrium requires that, without any uncertainty, if households are going to own shares in all firms $i$, then they must all have the same return.  Thus, $r_{i,t}=r_{t}, \forall \ i,t$.

Dividends are given by:

\begin{equation}
\label{eqn:divs}
DIV_{i,t} = p_{i,t}X_{i,t}-w_{t}EL_{i,t}-p^{k}_{i,t}I_{i,t}+VN_{i,t}
\end{equation}

This says that dividends can be paid by the surplus of revenue over expenses, plus new equity issues.  The latter says that money raised from new equity issues can be used to fund dividend distributions.  We don't usually see this happen in practice, where a firm raises money from one group to pay out to other shareholders.  The reason is that it is costly to raise equity and there are tax implications.  Note that in this simple model without taxes and frictions, we will not be able to determine the amount of equity raised since they can always raise more equity to distribute as dividends and keep the return on the firm constant.  I'll point this out several times as we further analyze this problem, but do keep that in the back of your head.

We can solve for the value of the firm by rearranging Equation \ref{eqn:r_firm_i}:

\begin{equation}
\label{eqn:derive_v}
\begin{split}
&r_{t} = \frac{DIV_{it} + \overbrace{V_{i,t+1}-V_{i,t}-VN_{i,t}}^{\text{capital gains}}}{V_{i,t}}\\
\implies & r_{t} V_{i,t} = DIV_{i,t} + V_{i,t+1} - V_{i,t} - VN_{i,t} \\
\implies & (1+r_{t})V_{i,t} = DIV_{i,t} - VN_{i,t} + V_{i,t+1} \\
\implies & V_{i,t} = \frac{1}{1+r_{t}}\left[DIV_{i,t}-VN_{i,t} + VN_{i,t+1}\right] \\
\implies & V_{i,t} = \frac{1}{1+r_{t}}\left[DIV_{i,t}-VN_{i,t}\right]+ \frac{1}{1+r_{t}}\frac{1}{1+r_{t+1}}\left[DIV_{i,t+1}-VN_{i,t+1} + V_{i,t+2}\right] \\
\implies & V_{i,t} =  \frac{1}{1+r_{t}}\left[DIV_{i,t}-VN_{i,t}\right]+ \frac{1}{1+r_{t}}\frac{1}{1+r_{t+1}}\left[DIV_{i,t+1}-VN_{i,t+1}\right] ... \\
 & \quad\quad\quad + \frac{1}{1+r_{t}}\frac{1}{1+r_{t+1}}\frac{1}{1+r_{t+2}}\left[DIV_{i,t+2}-VN_{i,t+2}+ V_{i,t+3}\right] \\
&... \\
\implies & V_{i,t} = \sum_{u=t}^{\infty}\prod_{\nu=t}^{u} \left(\frac{1}{1+r_{\nu}}\right)\left[DIV_{i,u}-VN_{i,u}\right] + \underbrace{\prod_{\nu=t}^{u} \left(\frac{1}{1+r_{\nu}}\right)V_{i,\infty}}_{=0,\text{ by transversality condition}}\\
\implies & V_{i,t} = \sum_{u=t}^{\infty}\prod_{\nu=t}^{u} \left(\frac{1}{1+r_{\nu}}\right)\left[DIV_{i,u}-VN_{i,u}\right] 
\end{split}
\end{equation}

What this means is the the value of the firm is the present discounted value of the stream of dividends from that firm, less the value of new equity issues.  Note that the transversality condition is the restriction that the discounted value of the firm much converge to zero in the limit.  This is necessary to to bound the infinite horizon problem, and without it we would not be able find a solution.  Intuitively, what is means is that the value of the firm can't grow faster than the discount rate - which ensures the limiting value of the firm is not positive.  If the limiting value of the firm were allowed to be positive, the firm would be over-accumulating retained earnings/capital in the infinite horizon problem.  Another way to conceptualize the transversality condition is to think about a finite horizon household optimization problem.  In the last period of life, the household would like to have infinitely negative savings (i.e., it'd like to borrow from the periods beyond life to consume during life).  We need to put a restriction on this last period borrowing to constrain and solve the problem.  The transversality condition is the infinite horizon analogue to this.

\subsubsection*{The sequence problem of the firm}

Using the result above, we can write the problem of the firm as a sequence problem.  This formulation is particularly good at highlighting the constraints the firm faces.  The sequence problem of a given firm is:

\begin{equation}
\label{eqn:firm_seq_prob}
\begin{split}
&\max_{\left\{I_{i,u}, K_{i,u+1},EL_{i,u},VN_{i,t}\right\}_{u=t}^{\infty}} \sum_{u=t}^{\infty} \prod_{\nu=t}^{u} \left(\frac{1}{1+r_{v}}\right) DIV_{i,u}-VN_{i,u} \\
&\quad\quad\quad \text{subject to: } DIV_{i,u}\geq0, VN_{i,t}\geq0, I_{i,u} = K_{i,u+1}-(1-\delta)K_{i,u} \\
\end{split}
\end{equation}

The first constraint is the dividend distributions must be non-negative.  The second is the new equity issues need to be non-negative.  This constraint is maybe less necessary - firms often repurchase shares.  But in the context of our larger model of tax policy, it's useful to make this restriction since frequent share repurchases receive the same tax treatment as dividend distributions from the IRS.  Thus we'll only allow firms to return money to shareholders via dividend distributions and not share repurchases.   The final constraint is law of motion for the capital stock.

The Lagrangian describing this constraint optimization problem is given by:

\begin{equation}
\label{eqn:firm_lagrange}
\begin{split}
\mathcal{L} = &  \max_{\left\{I_{i,u},K_{i,u+1},EL_{i,u},VN_{i,u}\right\}_{u=t}^{\infty}} \sum_{u=t}^{\infty} \prod_{\nu=t}^{u} \left(\frac{1}{1+r_{v}}\right) \left\{ p_{i,u}F(K_{i,u},EL_{i,u}) - w_{u}EL_{i,u} \right.\\
       & \left. -p^{k}_{i,u}I_{i,u} +VN_{i,u} - VN_{i,u} \right. \\
       &+\left. \lambda_{i,u}(p_{i,u}F(K_{i,u},EL_{i,u}) - w_{u}EL_{i,u} -p^{k}_{i,u}I_{i,u} +VN_{i,u}) \right. \\
       &+ \left. \mu_{i,u}VN_{i,u} + q_{i,u}(I - K_{i,u+1} + (1-\delta)K_{i,u})\right\} \\
\end{split}
\end{equation}

The FOCs for this problem, which must hold for all firms $i$ and at all periods $u$, are as follows:

\begin{equation}
\label{eqn:lagrange_foc_i}
\begin{split}
& \frac{\partial \mathcal{L}}{\partial I_{i,u}} = \prod_{\nu=t}^{u} \left(\frac{1}{1+r_{v}}\right) \left\{ -p^{k}_{i,u} - \lambda_{i,u}p^{k}_{i,u} + q_{i,u} \right\} = 0 \\
\implies &   -p^{k}_{i,u} - \lambda_{i,u}p^{k}_{i,u} + q_{i,u} = 0 \\
\implies & q_{i,u} = (1+\lambda_{i,u})p^{k}_{i,u} \\
\end{split}
\end{equation}


\begin{equation}
\label{eqn:lagrange_foc_k}
\begin{split}
& \frac{\partial \mathcal{L}}{\partial K_{i,u+1}} =   \prod_{\nu=t}^{u} \left(\frac{1}{1+r_{v}}\right) \left\{- q_{i,u} \right\} ... \\
& \quad\quad\quad\quad + \prod_{\nu=t}^{u+1} \left(\frac{1}{1+r_{v}}\right) \left\{(1+\lambda_{i,u+1})p_{i,u+1}\frac{\partial F(K_{i,u+1},EL_{i,u+1})}{\partial K_{i,u+1}} + q_{i,u+1}(1-\delta) \right\} = 0 \\
\implies &  - q_{i,u} + \frac{1}{1+r_{u+1}} \left\{(1+\lambda_{i,u+1})p_{i,u+1}\frac{\partial F(K_{i,u+1},EL_{i,u+1})}{\partial K_{i,u+1}}+ q_{i,u+1}(1-\delta)  \right\} = 0 \\
\implies & q_{i,u} =  \frac{1}{1+r_{u+1}} \left\{(1+\lambda_{i,u+1})p_{i,u+1}\frac{\partial F(K_{i,u+1},EL_{i,u+1})}{\partial K_{i,u+1}}+ q_{i,u+1}(1-\delta)  \right\}  \\
\end{split}
\end{equation}

\begin{equation}
\label{eqn:lagrange_foc_l}
\begin{split}
& \frac{\partial \mathcal{L}}{\partial EL_{i,u}} =   \prod_{\nu=t}^{u} \left(\frac{1}{1+r_{v}}\right) \left\{(1+\lambda_{i,u})p_{i,u}\frac{\partial F(K_{i,u+1},EL_{i,u+1})}{\partial EL_{i,u+1}} - (1+\lambda_{i,u})w_{u} \right\} = 0 \\
\implies & (1+\lambda_{i,u})p_{i,u}\frac{\partial F(K_{i,u+1},EL_{i,u+1})}{\partial EL_{i,u+1}} - (1+\lambda_{i,u})w_{u}  = 0 \\
\implies & (1+\lambda_{i,u})p_{i,u}\frac{\partial F(K_{i,u+1},EL_{i,u+1})}{\partial EL_{i,u+1}} =  (1+\lambda_{i,u)}w_{u}  \\
\implies & p_{i,u}\frac{\partial F(K_{i,u+1},EL_{i,u+1})}{\partial EL_{i,u+1}} =  w_{u}  \\
\implies &\frac{\partial F(K_{i,u+1},EL_{i,u+1})}{\partial EL_{i,u+1}} =  \frac{w_{u}}{ p_{i,u}}  \\
\end{split}
\end{equation}


\begin{equation}
\label{eqn:lagrange_foc_vn}
\begin{split}
& \frac{\partial \mathcal{L}}{\partial VN_{i,u}} =   \prod_{\nu=t}^{u} \left(\frac{1}{1+r_{v}}\right) \left\{(1+\lambda_{i,u})- 1 + \mu_{i,u} \right\} = 0 \\
\implies & (1+\lambda_{i,u})- 1  +\mu_{i,u}  = 0 \\
\implies & \lambda_{i,u} + \mu_{i,u}=0  \\
\implies &\lambda_{i,u} = -\mu_{i,u} \\
\implies &  \lambda_{i,u}= \mu_{i,u} =0 \implies  VN_{i,u}>0 \text{ and } DIV_{i,u} > 0
\end{split}
\end{equation}


Note that this last FOC implies that both dividends and new equity issues are positive, since both Lagrangian multipliers must be zero to hold equality.  This result highlights the indeterminacy of dividends and new equity issues when there are no taxes and financial frictions.  It illustrates the Modigliani-Miller Theorem about the irrelevance of corporate finance. Their theorem states that in the absence of taxes and other frictions, the value of the firm is unaffected by how the firm is financed.  That is, the value of the firm is not affected by whether retained earnings or external finance (in this case, new equity issues) are used to finance investment since they both have the same cost to the firm.  You can see from the firm's problem above that raising one dollar from retained earnings only to distribute that as dividends in the same period has no effect on the firm problem.

These FOC's can be used to solve for the endogenous variables, $K_{i,u+1}, I_{i,u}, EL_{i,u}, VN_{i,u}$ as functions of the parameters and the factor and output prices that these competitive firms take as given.  Equation \ref{eqn:lagrange_foc_vn} and \ref{eqn:lagrange_foc_i} together imply that:

\begin{equation}
\label{eqn:q_p}
q_{i,u} = p^{k}_{i,u}
\end{equation}

Note that $q_{i,u}$, the multiplier on the law of motion for capital constraint, represents the shadow price of capital in the firm.  Equation \ref{eqn:p_q} says that, along the optimal investment path, the marginal value of capital in the firm is equal to the price of capital.  This is a familiar result of Tobin's Q-theory; firms should invest until $\frac{q_{i,u}}{p_{i,u}}=1$. 

Using Equation \ref{eqn:q_p}, together with Equation \ref{eqn:lagrange_foc_k}, we find that:

\begin{equation}
\label{eqn:opt_inv}
p^{k}_{i,u} =  \frac{1}{1+r_{u+1}} \left\{p_{i,u+1}\frac{\partial F(K_{i,u+1},EL_{i,u+1})}{\partial K_{i,u+1}}+ p^{k}_{i,u+1}(1-\delta)  \right\} 
\end{equation}

The lefthand side of Equation \ref{eqn:opt_inv} gives the marginal cost of capital (which is the price of a unit of capital).  The righthand side gives the marginal benefit of capital; with an additional unit of capital tomorrow you get additional output (given by the marginal product of capital) and need less investment in the subsequent period ($u+1$) to have the same amount of capital going into period $u+2$.  This equation is also often written in the form:

\begin{equation}
\label{eqn:opt_inv2}
\frac{p^{k}_{i,u}}{p_{i,u+1}}(1+r_{u+1}) - \frac{p^{k}_{i,u+1}}{p_{i,u+1}}(1-\delta) =\frac{\partial F(K_{i,u+1},EL_{i,u+1})}{\partial K_{i,u+1}} , 
\end{equation}

\noindent\noindent where the lefthand side is the familiar real user cost of capital, which equals the marginal product of capital along the optimal investment path.

We can solve for the firm's endogenous variables using Equations \ref{eqn:lagrange_foc_l} and \ref{eqn:opt_inv}.  In particular, the FOC for labor can be used to solve for the firm's labor demand function:

\begin{equation}
\label{eqn:solve_dyn_l}
\begin{split}
 &\frac{\partial F(K_{i,u+1},EL_{i,u+1})}{\partial EL_{i,u+1}} =  \frac{w_{u}}{ p_{i,u}}  \\
 \implies & A_{i,u}^{\frac{\epsilon_{i}-1}/{\epsilon_{i}}}\left( \frac{(1-\gamma_{i})X_{i,u}}{EL_{i,u}}\right)^{\frac{1}{\epsilon_{i}}} =   \frac{w_{u}}{ p_{i,u}} \\
\implies & EL_{i,u} = \left( \frac{ p_{i,u}}{w_{u}}\right)^{\epsilon_{i}}A_{i,u}^{\epsilon_{i}-1}X_{i,u} = EL(p_{i,u},w_{u},X_{i,u})
\end{split}
\end{equation}

Likewise, Equation \ref{eqn:opt_inv} can be used to solve for the capital demand function:

\begin{equation}
\label{eqn:solve_dyn_k}
\begin{split}
 &p^{k}_{i,u} =  \frac{1}{1+r_{u+1}} \left\{p_{i,u+1}\frac{\partial F(K_{i,u+1},EL_{i,u+1})}{\partial K_{i,u+1}}+ p^{k}_{i,u+1}(1-\delta)  \right\}  \\
 \implies & \frac{p^{k}_{i,u}}{p_{i,u+1}}(1+r_{u+1}) - \frac{p^{k}_{i,u+1}}{p_{i,u+1}}(1-\delta) =\frac{\partial F(K_{i,u+1},EL_{i,u+1})}{\partial K_{i,u+1}} \\
\implies & \frac{p^{k}_{i,u}}{p_{i,u+1}}(1+r_{u+1}) - \frac{p^{k}_{i,u+1}}{p_{i,u+1}}(1-\delta) =A_{i,u+1}^{\frac{\epsilon_{i}-1}{\epsilon_{i}}} \left( \frac{\gamma_{i}X_{i,u+1}}{K_{i,u+1}}\right)^{\frac{1}{\epsilon_{i}}} \\
\implies & K_{i,u+1} = \gamma_{i}X_{i,u+1}A_{i,u+1}^{\epsilon_{i}-1} \left(\frac{p_{i,u+1}}{p^{k}_{i,u}(1+r_{u+1}) - p^{k}_{i,u+1}(1-\delta)} \right)^{\epsilon_{i}} = K(p_{i,u+1},p^{k}_{i,u},p^{k}_{i,u+1},r_{u+1},X_{i,u+1})
\end{split}
\end{equation}

We then can determine investment through the law of motion for capital:

\begin{equation}
\label{eqn:solve_dyn_i}
\begin{split}
 &I_{i,u} = K_{i,u+1} - (1-\delta)K_{i,u} \\
\implies & I_{i,u} = K(p_{i,u+1},p^{k}_{i,u},p^{k}_{i,u+1},r_{u+1},X_{i,u+1}) - (1-\delta)K(p_{i,u},p^{k}_{i,u-1},p^{k}_{i,u},r_{u},X_{i,u}) 
\end{split}
\end{equation}

Dividends follow from the firm's cash flow equation:

\begin{equation}
\label{eqn:solve_dyn_div}
\begin{split}
 &DIV_{i,u} = p_{i,u}X_{i,u} - w_{u}EL_{i,u}-p^{k}_{i,u}I_{i,u} \\
\implies &DIV_{i,u} = p_{i,u}X_{i,u} - w_{u}EL(p_{i,u},w_{u},X_{i,u}) - p^{k}_{i,u}I_{i,u} \\
\end{split}
\end{equation}

As noted above, new equity issues, $VN_{i,u}$ are indeterminate in this model without taxes and frictions.  Thus we have all the firm's endogenous variables solved for in terms of factor prices and output prices, which the firm takes as given, and total output.

\subsubsection*{An aside: Financial policy with taxes}
To help illustrate how the financial policy irrelevance result differs in the presence of taxes, let's consider a similar problem to that formulated above, but with taxes on capital gains and dividends.  These taxes will create a tax wedge between internal and external finance and we can see the result on the necessary condition for the firm's choice of new equity issues.

With capital gains taxed at a rate $\tau^{g}$ and dividends taxed at rate $\tau^{d}$, the value of the firm is given by:


\begin{equation}
r_{t} = \frac{(1-\tau^{d}_{t})DIV_{i,t}+(1-\tau^{g}_{t})(V_{i,t+1}-V_{i,t}-VN_{i,t})}{V_{i,t}}
\end{equation} 

As before, we can rearrange this equation, iterate forward, and apply the transversality condition to solve for the value of the firm.  We get:

\begin{equation}
\label{eqn:v_firm_tax}
\begin{split}
 V_{i,t}= \sum_{u=t}^{\infty} \prod_{\nu=t}^{u}\left(\frac{1}{1+\frac{r_{\nu}}{(1+\tau^{g}_{\nu})}}\right)\left[ \left(\frac{1-\tau^{d}_{u}}{1-\tau^{g}_{u}}\right)DIV_{i,u}-VN_{i,u} \right] \\
\end{split}
\end{equation}

The Lagrangian for the sequence problem is:

\begin{equation}
\label{eqn:firm_lagrange_tax}
\begin{split}
\mathcal{L} = &  \max_{\left\{I_{i,u},K_{i,u+1},EL_{i,u},VN_{i,u}\right\}_{u=t}^{\infty}} \sum_{u=t}^{\infty} \prod_{\nu=t}^{u} \left(\frac{1}{1+\frac{r_{v}}{(1+\tau^{g}_{\nu})}}\right)\left\{ \left(\frac{1-\tau^{d}_{u}}{1-\tau^{g}_{u}}\right) \left[p_{i,u}F(K_{i,u},EL_{i,u}) - w_{u}EL_{i,u} \right. \right.\\
       & \left. \left. -p^{k}_{i,u}I_{i,u} +VN_{i,u}\right] - VN_{i,u} \right. \\
       &+\left. \lambda_{i,u}(p_{i,u}F(K_{i,u},EL_{i,u}) - w_{u}EL_{i,u} -p^{k}_{i,u}I_{i,u} +VN_{i,u}) \right. \\
       &+ \left. \mu_{i,u}VN_{i,u} + q_{i,u}(I - K_{i,u+1} + (1-\delta)K_{i,u})\right\} \\
\end{split}
\end{equation}

And the FOC for the firm's choice of new equity is:

\begin{equation}
\label{eqn:lagrange_foc_vn_tax}
\begin{split}
& \frac{\partial \mathcal{L}}{\partial VN_{i,u}} =   \prod_{\nu=t}^{u} \left(\frac{1}{1+r_{v}}\right) \left\{\left(\frac{1-\tau^{d}_{u}}{1-\tau^{g}_{u}}\right) - 1 +\lambda_{i,u}  + \mu_{i,u} \right\} = 0 \\
\implies & \left(\frac{1-\tau^{d}_{u}}{1-\tau^{g}_{u}}\right) +\lambda_{i,u}- 1  + \mu_{i,u}  = 0 \\
\implies &   \left(\frac{1-\tau^{d}_{u}}{1-\tau^{g}_{u}}\right) + \lambda_{i,u} + \mu_{i,u} = 1  \\
\end{split}
\end{equation}

If $\tau^{g}_{u}=\tau^{d}_{u}$, then $ \left(\frac{1-\tau^{d}_{u}}{1-\tau^{g}_{u}}\right)=1$ and thus $\lambda_{i,u}= \mu_{i,u}=0$, and we are back to the result derived without taxes shown in Equation \ref{eqn:lagrange_foc_vn}.

If $\tau^{g}_{u}<\tau^{d}_{u}$ (as it was in the U.S. prior to the 2003 tax cuts), then $ \left(\frac{1-\tau^{d}_{u}}{1-\tau^{g}_{u}}\right)<1$, which means $ \lambda_{i,u} + \mu_{i,u} >0$.  That is, at least one constraint is binding. This means that the firm will never be both distributing dividends and issuing new equity.  It may do neither ($DIV=VN=0$), but it won't do both.  

If $\tau^{g}_{u}> \tau^{d}_{u}$, then $ \left(\frac{1-\tau^{d}_{u}}{1-\tau^{g}_{u}}\right)>1$, which means  $ \lambda_{i,u} + \mu_{i,u} <0$.  This can't happen since these Lagrangian multipliers are non-negative.  What this is illustrating is that no solutions exists to the firm's problem if capital gains taxes are greater than dividend taxes.  In this case, the firm will want to issue an infinite amount of new equity and use that to finance dividends.  This will drive firm value to infinity.  The reason is that issuing \$1 of new equity costs the shareholder $\$1\times(1-\tau^{g}_{u})$.  Distributing a dollar of as dividends benefits the shareholder by $\$1\times (1-\tau^{d}_{u})$.  If $\tau^{g}_{u}> \tau^{d}_{u}$, then $\$1\times (1-\tau^{d}_{u}) > \$1\times(1-\tau^{g}_{u})$, and the shareholder benefits from this transaction of using new equity to finance dividends.  Without additional frictions (e.g. increasing costs to issuing equity), this is true at any amount of new equity issued, and therefore the problem's solution is that the firm issues an infinite amount of new equity and uses that to finance and infinite about of dividend distributions and firm value goes to infinity.  Tax arbitrage produces an infinite, risk free return for the shareholder.

\subsubsection*{Determining the prices of output and capital}

Firms are competitive and so take the prices of output and capital as given.  Unlike the static firm model, there is not a per period zero profit condition.  The analogous condition for the dynamic firm's problem is that prices are such that the return to the firm's shareholders is the market rate of return.  Recall that:

\begin{equation}
\begin{split}
r_{t} &= \frac{DIV_{i,t}+V_{i,t+1}-V_{i,t}-VN_{i,t}}{V_{i,t}}\\
\implies r_{t} &= \frac{DIV_{i,t} + \sum_{u=t+1}^{\infty}\prod_{\nu=t}^{u}\left(\frac{1}{1+r_{\nu}}\right)\left[DIV_{i,u}-VN_{i,u}\right] -\sum_{u=t}^{\infty}\prod_{\nu=t}^{u}\left(\frac{1}{1+r_{\nu}}\right)\left[DIV_{i,u}-VN_{i,u}\right]}{V_{i,t}} ...\\
& \quad\quad\quad\quad\quad - \frac{VN_{i,t}}{V_{i,t}} \\
\implies r_{t} & = \frac{DIV_{i,t} - \frac{1}{1+r_{t}}\left[DIV_{i,t} - VN_{i,t}\right] - VN_{i,t}}{V_{i,t}} \\
\implies r_{t} & = \frac{\frac{r_{t}}{1+r_{t}}\left[DIV_{i,t}-VN_{i,t}\right]}{V_{i,t}} \\
\implies 1+r_{t} &= \frac{DIV_{i,t}-VN_{i,t}}{V_{i,t}}
\end{split}
\end{equation}

Recall from Equations \ref{eqn:solve_dyn_k} to \ref{eqn:solve_dyn_div}, we were able to solve for factor demand and dividends in terms of prices and output.  $VN_{i,u}$ were indeterminate, but let's just make it simple and assume they are zero (as might be the case in a world where dividend taxes exceed capital gains tax - or there are frictions making external finance costly) for all $i$ and $u$.\footnote{We can prove they will be zero in the steady state with taxes or frictions and without idiosyncratic firm productivity shocks.  They make no be zero along the transition path even with taxes and frictions - it'll depend upon the the firm's production function and their initial capital stock.}  When new equity issues are zero, we have:

\begin{equation}
\label{eqn:price_det}
\begin{split}
& 1+r_{t} = \frac{DIV_{i,t}}{V_{i,t}} \\
\implies &  1+r_{t} = \frac{ p_{i,t}X_{i,t} - w_{t}EL(p_{i,t},w_{u},X_{i,t}) - p^{k}_{i,t}I_{i,t}}{V_{i,t}} \\
\implies &  1+r_{t} = \frac{ p_{i,t}X_{i,t} - w_{t}EL(p_{i,t},w_{t},X_{i,t})}{V_{i,t}}... \\
 & \quad\quad\quad\quad\quad\quad - \frac{p^{k}_{i,t}(K(p_{i,t+1},p^{k}_{i,t},p^{k}_{i,t+1},r_{t+1},X_{i,t+1}) - (1-\delta)K(p_{i,t},p^{k}_{i,t-1},p^{k}_{i,t},r_{t},X_{i,t}))}{V_{i,t}} \\
\end{split}
\end{equation}


This means we have an equation written in terms of factor prices, output prices, capital prices, output, and parameters.  This will be the equation we use to solve for prices, but we need two more pieces. 

First, we have that output prices determine capital prices, since capital is an output.  We'll assume a fixed-coefficient input-output matrix.  Call this matrix $\Xi$.  If we let $\boldsymbol{p_{t}}$ be the $1\times M$ vector of output prices, we can determine the capital prices as:

\begin{equation}
\label{eqn:capital_prices}
\underbrace{\boldsymbol{p^{k}_{t}}}_{1\times M} =\underbrace{\boldsymbol{p_{t}}}_{1\times M} \times  \underbrace{\Xi}_{M\times M}
\end{equation}

Second, we need to solve for $V_{i,t}$ in terms of factor prices, output prices, capital prices, output, and parameters.  To do this, we will use the result of \citet{Hayashi1982}.  Hayashi shows that with quadratic adjustment costs to changing the capital stock (which we have here - albeit the costs are zero in this simple model) and a production function that is proportional to the capital stock (which we have since we have a CRS production function), the the firm's marginal q, $q_{i,u}$, is equal to the firm's average q, $Q_{i,u}$:

\begin{equation}
q_{i,t} = \frac{V_{i,t}}{K_{i,t}} = Q_{i,t} 
\end{equation}

We thus have:

\begin{equation}
\label{eqn:solve_v1}
V_{i,t} = q_{i,t}K_{i,t} =p^{k}_{i,t}K_{i,t},
\end{equation}

\noindent\noindent where the second equality follows from the first order condition for investment, that at an optimum, marginal q is equal to the price of capital.


Using this result for the value of the firm in Equation \ref{eqn:price_det} we have:

\begin{equation}
\label{eqn:price_det2}
\begin{split}
&  1+r_{t} = \frac{ p_{i,t}X_{i,t} - w_{t}E_{i,t} - p^{k}_{i,t}I_{i,t}}{V_{i,t}} \\
\implies & 1+r_{t} =  \frac{ p_{i,t}X_{i,t} - w_{t}EL(p_{i,t},w_{u},X_{i,t}) - p^{k}_{i,t}I_{i,t}}{p^{k}_{i,t}K_{i,t}} \\
\implies & (1+r_{t})p^{k}_{i,t}K_{i,t} =  p_{i,t}X_{i,t} - w_{t}EL(p_{i,t},w_{u},X_{i,t}) - p^{k}_{i,t}I_{i,t} \\
\implies & p_{i,t}X_{i,t} = w_{t}EL_{i,t} + p^{k}_{i,t}I_{i,t} +  (1+r_{t})p^{k}_{i,t}K_{i,t} \\
\implies & p_{i,t}X_{i,t} = w_{t}EL_{i,t}+ p^{k}_{i,t}(K_{i,t+1} - (1-\delta)K_{i,t}) +  (1+r_{t})p^{k}_{i,t}K_{i,t} \\
\implies & p_{i,t}X_{i,t} = w_{t}EL_{i,t} + p^{k}_{i,t}K_{i,t+1}+  (r_{t}+\delta)p^{k}_{i,t}K_{i,t} \\
\implies & p_{i,t}= \frac{w_{t}(1-\gamma_{i})X_{i,t}A_{i,t}^{\epsilon_{i}-1}\left( \frac{ p_{i,t}}{w_{t}}\right)^{\epsilon_{i}} + p^{k}_{i,t} \gamma_{i}X_{i,t+1}A_{i,t+1}^{1-\epsilon_{i}} \left(\frac{p_{i,t+1}}{p^{k}_{i,t}(1+r_{t+1}) - p^{k}_{i,t+1}(1-\delta)} \right)^{\epsilon_{i}}}{X_{i,t} } ... \\
& \quad\quad\quad\quad\quad + \frac{ (r_{t}+\delta)p^{k}_{i,t}\gamma_{i}X_{i,t}A_{i,t}^{1-\epsilon_{i}} \left(\frac{p_{i,t}}{p^{k}_{i,t-1}(1+r_{t}) - p^{k}_{i,t}(1-\delta)} \right)^{\epsilon_{i}}}{X_{i,t} } \\
\implies & p_{i,t}= w_{t}(1-\gamma_{i})A_{i,t}^{\epsilon_{i}-1}\left( \frac{ p_{i,t}}{w_{t}}\right)^{\epsilon_{i}} + p^{k}_{i,t} \gamma_{i}\frac{X_{i,t+1}}{X_{i,t}}A_{i,t+1}^{1-\epsilon_{i}} \left(\frac{p_{i,t+1}}{p^{k}_{i,t}(1+r_{t+1}) - p^{k}_{i,t+1}(1-\delta)} \right)^{\epsilon_{i}} ... \\
& \quad\quad\quad\quad\quad +  (r_{t}+\delta)p^{k}_{i,t}\gamma_{i}A_{i,t}^{1-\epsilon_{i}} \left(\frac{p_{i,t}}{p^{k}_{i,t-1}(1+r_{t}) - p^{k}_{i,t}(1-\delta)} \right)^{\epsilon_{i}}
\end{split}
\end{equation}

%
% \implies &  1+r_{t} = \frac{p_{i,t}X_{i,t} - w_{t}\left( \frac{ p_{i,t}}{w_{t}}\right)^{\epsilon_{i}}A_{i,t}^{\epsilon_{i}-1}X_{i,t}}{V_{i,t}} ...\\ 
% & \quad - \frac{p^{k}_{i,t}\left( \gamma_{i}X_{i,t+1}A_{i,t+1}^{1-\epsilon_{i}} \left(\frac{p_{i,t+1}}{p^{k}_{i,t}(1+r_{t+1}) - p^{k}_{i,t+1}(1-\delta)} \right)^{\epsilon_{i}} - (1-\delta) \gamma_{i}X_{i,t}A_{i,t}^{1-\epsilon_{i}} \left(\frac{p_{i,t}}{p^{k}_{i,t-1}(1+r_{t}) - p^{k}_{i,t}(1-\delta)} \right)^{\epsilon_{i}}\right)}{V_{i,t}} \\


Given demand for output, we can use Equations \ref{eqn:price_det2} and \ref{eqn:capital_prices} to solve for the prices of output and capital.  Solving for the time path of prices will utilize the ability to work backwards from the steady state that is fundamental to the Time Path Iteration solution method.  We'll go through this specifically in a future section.  We'll next discuss how to find the solution in the steady state.

\subsection*{The firm's problem in the steady state}	

Since the firm's problem is stationary, the steady-state solution is much simpler than the solution along the time path. The key equations describing the optimal investment, employment, and financial policies in the steady state are given by:

\begin{equation}
\label{eqn:foc_l_ss}
\frac{\partial F(\bar{K}_{i},\overline{EL}_{i})}{\partial \overline{EL}_{i}} = \frac{\bar{w}}{\bar{p}_{i}}
\end{equation}

\begin{equation}
\label{eqn:foc_k_ss}
\frac{\partial F(\bar{K}_{i},\overline{EL}_{i})}{\partial \bar{K}_{i}} = \frac{\bar{p}^{k}_{i}}{\bar{p}_{i}}(\bar{r}+\delta)
\end{equation}

\begin{equation}
\label{eqn:i_ss}
\bar{I}_{i} = \delta \bar{K}_{i}
\end{equation}

\begin{equation}
\label{eqn:foc_vn_ss}
\bar{\lambda}_{i}=\bar{\mu}_{i} = 0 \implies \overline{VN}_{i}\geq0, \overline{DIV}_{i}\geq0
\end{equation}

The steady state return on equity in the firm is given by:

\begin{equation}
\label{eqn:ss_return}
\begin{split}
& \bar{r} = \frac{\overline{DIV}_{i}+\bar{V}_{i}-\bar{V}_{i}-\overline{VN}_{i}}{\bar{V}_{i}}\\
\implies & \bar{r} =  \frac{\overline{DIV}_{i}-\overline{VN}_{i}}{\bar{V}_{i}}\\
\implies & \bar{r} =  \frac{\overline{DIV}_{i}}{\bar{V}},\\
\end{split}
\end{equation}

\noindent\noindent where the last line follows from the assumption that the firm never issues new equity and distributes dividends at the same time.  As pointed out before (and as Equation \ref{eqn:foc_vn_ss} shows), the solution without taxes or frictions offers an indeterminate amount of dividends and new equity issues.  To close the model, we are making the assumption (as is the case with dividend taxes that exceed capital gains taxes - or with costly external finance) that a firm never distributed dividends and issues new equity at the same time.  In the SS, we know that the solution must then be that the firm distributes dividends.  If it were not, $\overline{DIV}_{i}=0$ and $\overline{VN}_{i}>0$ and thus firm value would be negative.  Therefore, it must be the case that $\overline{DIV}_{i}>0$ and $\overline{VN}_{i}=0$.

Equations \ref{eqn:foc_l_ss} through \ref{eqn:i_ss} give us $\overline{EL}_{i}, \bar{K}_{i},$ and $\bar{I}_{i}$:

\begin{equation}
\label{eqn:l_ss}
\overline{EL}_{i} = (1-\gamma_{i}) \left( \frac{ \bar{p}_{i}}{\bar{w}}\right)^{\epsilon_{i}}\bar{A}_{i}^{\epsilon_{i}-1}\bar{X}_{i} = EL(\bar{p}_{i},\bar{w},\bar{X}_{i})
\end{equation}

\begin{equation}
\label{eqn:k_ss}
\bar{K}_{i} = \gamma_{i}\bar{X}_{i}\bar{A}_{i}^{1-\epsilon_{i}} \left(\frac{\bar{p}_{i}}{\bar{p}^{k}_{i}(\bar{r}+\delta)} \right)^{\epsilon_{i}} = K(\bar{p}_{i},\bar{p}^{k}_{i},\bar{r},\bar{X}_{i})
\end{equation}

\begin{equation}
\label{eqn:q_ss}
\bar{q}_{i} = \frac{\bar{p}_{i}MPK(\bar{K}_{i},\overline{EL}_{i})}{\bar{r}+\delta}=\bar{p}^{k}
\end{equation}

\begin{equation}
\label{eqn:i_ss2}
\bar{I}_{i} = \delta \bar{K}_{i}
\end{equation}

\begin{equation}
\label{eqn:div_ss}
\overline{DIV}_{i} = \bar{p}_{i}\bar{X}_{i}-\bar{w}\overline{EL}_{i}-\bar{p}^{k}_{i}\delta \bar{K}_{i}
\end{equation}

The final equation we'll need is the \citet{Hayashi1982} result relating marginal and average q.  In the steady-state this implies:

\begin{equation}
\label{eqn:ss_marg_avg_q}
\begin{split}
& \bar{q}_{i} = \frac{\bar{V}_{i}}{\bar{K}_{i}} \\
\implies & V_{i} = \bar{q}_{i}\bar{K}_{i} \\
\implies & V_{i} = \bar{p}^{k}_{i}\bar{K}_{i}  \\
\end{split}
\end{equation}

Putting this together with the steady state return on the firm we find:

\begin{equation}
\label{eqn:price_det_ss}
\begin{split}
&\bar{r} = \frac{\overline{DIV}_{i}}{\bar{V}_{i}} \\
\implies & \bar{r} = \frac{ \bar{p}_{i}\bar{X}_{i}-\bar{w}\overline{EL}_{i}-\bar{p}^{k}_{i}\delta \bar{K}_{i}}{\bar{q}_{i}\bar{K}_{i}} \\
\implies & \bar{r}\bar{q}_{i}\bar{K}_{i} = \bar{p}_{i}\bar{X}_{i}-\bar{w}\overline{EL}_{i}-\bar{p}^{k}_{i}\delta \bar{K}_{i} \\
\implies &  \bar{p}_{i}\bar{X}_{i} = \bar{w}\overline{EL}_{i} + \bar{p}^{k}_{i}\delta \bar{K}_{i} +  \bar{r}\bar{q}_{i}\bar{K}_{i} \\
\implies &   \bar{p}_{i} = \frac{\bar{w}\overline{EL}_{i} + \bar{p}^{k}_{i}\delta \bar{K}_{i} +  \bar{r}\bar{q}_{i}\bar{K}_{i}}{\bar{X}_{i}}\\
\implies &   \bar{p}_{i} = \frac{\bar{w}\overline{EL}_{i} + \bar{p}^{k}_{i}(r+\delta) \bar{K}_{i}}{\bar{X}_{i}}\\
\implies &\bar{p}_{i} = \frac{ \bar{w}(1-\gamma_{i})\bar{X}_{i}\bar{A}_{i}^{\epsilon_{i}-1}\left( \frac{ \bar{p}_{i}}{\bar{w}}\right)^{\epsilon_{i}}+\bar{p}^{k}_{i}(r+\delta)\gamma_{i}\bar{X}_{i}\bar{A}_{i}^{1-\epsilon_{i}} \left(\frac{\bar{p}_{i}}{\bar{p}^{k}_{i}(\bar{r}+\delta)} \right)^{\epsilon_{i}}}{\bar{X}_{i}} \\
\implies &\bar{p}_{i} = \bar{w}(1-\gamma_{i})\bar{A}_{i}^{\epsilon_{i}-1}\left( \frac{ \bar{p}_{i}}{\bar{w}}\right)^{\epsilon_{i}}+\bar{p}^{k}_{i}(r+\delta)\gamma_{i}\bar{A}_{i}^{1-\epsilon_{i}} \left(\frac{\bar{p}_{i}}{\bar{p}^{k}_{i}(\bar{r}+\delta)} \right)^{\epsilon_{i}}\\
\end{split}
\end{equation}

The above equation, together with Equation \ref{eqn:capital_prices}, allow use to determine $\bar{p}_{i}$ and $\bar{p}^{k}_{i}$, for all $i$, as functions of parameters, exogenous variables ($\bar{A}_{i}$), and factor prices ($\bar{r}$ and $\bar{w}$).


\subsection*{Changes to the household's problem}

Finding the consumer's demand for consumption will be the same as the static problem.  And the consumer's problem will look the same.  However, now savings, $b$, will be interpreted as the value of shares of the firms owned.  Since all firms will give the rate of return, households will be assumed to hold a diversified portfolio of firms (since all firms have the same return on equity, there is really no difference between this and any other portfolio assumption).  

\subsection*{Finding total demand for output from industry $m$}

Same as in the static problem.

\begin{equation}
\label{eqn:output_demand_dyn}
X_{i,u} = C_{i,u} + \sum_{m=1}^{M}I_{m}*\xi{m,i}
\end{equation}

\subsection*{Finding factor demands}

Same as in the static problem, updated to use the FOCs from the dynamic firm's problem.  The resulting demands for the steady state are given in Equations \ref{eqn:k_ss} and \ref{eqn:l_ss}.  For the transition path, they are given by Equations \ref{eqn:solve_dyn_k} and \ref{eqn:solve_dyn_l}.


\subsection*{Market clearing}

There are three markets - the labor market, the asset market, and the goods market.  By Walras' Law we only need to check two and we'll use the labor and capital markets:

\begin{equation}
\sum_{M} \bar{V}_{m} = \sum_{J}\sum_{S}\bar{b}_{j,s}
\end{equation}

\noindent\noindent This says that the total value of assets held by the households must equal the total value of the firms in which they own shares. We can determine the steady state value of the firm as :

\begin{equation}
\label{eqn:solve_firm_value}
\bar{V}_{m} =\frac{\overline{DIV}_{m}}{\bar{r}}
\end{equation}

The condition for the labor market is: 

\begin{equation}
\sum_{M} \overline{EL}_{m} = \sum_{J}\sum_{S}e_{j,s}*\bar{n}_{j,s}
\end{equation}

\subsection*{Steady-state Computational Procedure}

To compute the solution to the SS of the model with dynamic firms, we'll use a similar algorithm to what we've used for static firm, but with some updated equations.  The algorithm is as follows:

\begin{enumerate}
\item Make an initial guess at $\bar{r}$ and $\bar{w}$
\item Use $r$ and $w$ and Equations \ref{eqn:price_det_ss} and \ref{eqn:composite_price2} to solve for the price of consumption goods 1 and 2 and the composite good price.
\item Taking $\bar{r}$, $\bar{w}$, $p_{1}$, $p_{2}$, and $\tilde{p}$ as given, solve the household's problem:
	\begin{itemize}
	\item For each $j$ type:
		\begin{enumerate}
		\item Make an initial guess at the household's optimal savings and labor supply decisions, $b_{j,s}$, $n_{j,s}$.
		\item Use a root finder (e.g. \texttt{fsolve}) to determine the optimal allocations given $\bar{r}$ and $\bar{w}$.
		\end{enumerate}
	\end{itemize}
\item Aggregate over $J$ and $S$ to determine aggregate supply of labor and savings, and aggregate consumption of each good; $B$, $EL$, $C_{1}$, $C_{2}$.
	\begin{itemize}
	\item Here, $B$ is the sum of saving by all households.  We won't use $K$ since households don't hold any capital in this setup.
	\item Remember to find $EL$ as the aggregate amount of effective labor units supplied, so you not only want to sum over $J$ and $S$, but weight by the number of effective labor units each type/age supplies.
	\end{itemize}
\item Use the aggregate demands for each of the two consumption goods and Equation \ref{eqn:find_output} to solve for the output from each industry $i$.
\item Use Equations \ref{eqn:l_ss} and \ref{eqn:k_ss} to solve for the factor demands from each industry.
\item Solve for the value of each firm using Equation \ref{eqn:solve_firm_value}
\item Find the aggregate value of firms: $V = V_{1}+V_{2}$.
\item Find the aggregate effective labor demanded: $EL = EL_{1}+EL_{2}$.
\item Take differences between aggregate amounts of labor supplied and demanded and between aggregate savings and aggregate firm value.
\item Use a root finder to determine the eq'm $\bar{r}$ and $\bar{w}$ (i.e. it'll find the $\bar{r}$ and $\bar{w}$ where $\bar{V}-\bar{B}=0$ and $\overline{EL}_{demand}-\overline{EL}_{supply}=0$).
\end{enumerate}

\section*{Future steps}

\begin{enumerate}
\setcounter{enumi}{5}
\item Add growth
\item Add simple taxes (div, cap gain, corp inc tax on accounting profits)
\item Add solution for firms along the time path
\item Add endogenous financial policy (it's at this step that we'll add the feature that households invest their savings in two assets - bonds and equities - which have potentially different returns).
\item Add more complex taxes (parameters for various consumption tax/income tax systems, invest tax credits, tax depreciation)
\item Allow consumer subutility preferences to be age dependent.
\item Add government that purchases capital and labor to make public good.  Don't need to change consumer utility function to account for this, but we could.
\item Add government production firm
\item Add a fixed factor of production so that there are economic profits (this will necessitate a transfer of profits back to the household) (????)
\item Add a noncorporate sector
\item Add income shifting.  This involves adding multinational firms.
\item Add government debt????
\end{enumerate}


\end{spacing}

% Bibliography:
\clearpage
\bibliography{OSPC_BYU_Dyn_Bib}
\index{Bibliography@\emph{Bibliography}}%  

\end{document}